
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Calico · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../sdn/" />
    
    
    <link rel="prev" href="flannel.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    ABOUT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../k8s-ingress/">
            
                <a href="../k8s-ingress/">
            
                    
                    CONTAINER INGRESS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../k8s-ingress/f5-cis/">
            
                <a href="../k8s-ingress/f5-cis/">
            
                    
                    F5 CIS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../k8s-ingress/f5-cis/install.html">
            
                <a href="../k8s-ingress/f5-cis/install.html">
            
                    
                    安装
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1.1" data-path="../k8s-ingress/f5-cis/solutions/flannel-etcd-mode.html">
            
                <a href="../k8s-ingress/f5-cis/solutions/flannel-etcd-mode.html">
            
                    
                    Flannel etcd mode
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="../k8s-ingress/f5-cis/config.html">
            
                <a href="../k8s-ingress/f5-cis/config.html">
            
                    
                    配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="../k8s-ingress/f5-cis/as3/">
            
                <a href="../k8s-ingress/f5-cis/as3/">
            
                    
                    AS3
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.3.1" data-path="../k8s-ingress/f5-cis/as3/canary/">
            
                <a href="../k8s-ingress/f5-cis/as3/canary/">
            
                    
                    Canary Releasing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.2" data-path="../k8s-ingress/f5-cis/as3/ws/">
            
                <a href="../k8s-ingress/f5-cis/as3/ws/">
            
                    
                    WebSocket
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.3" data-path="../k8s-ingress/f5-cis/as3/hubmode/">
            
                <a href="../k8s-ingress/f5-cis/as3/hubmode/">
            
                    
                    HubMode
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.1.4" data-path="../k8s-ingress/f5-cis/ingress/">
            
                <a href="../k8s-ingress/f5-cis/ingress/">
            
                    
                    Ingress
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.5" data-path="../k8s-ingress/f5-cis/cccl/">
            
                <a href="../k8s-ingress/f5-cis/cccl/">
            
                    
                    CCCL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.6" data-path="../k8s-ingress/f5-cis/mgmt-isolation/">
            
                <a href="../k8s-ingress/f5-cis/mgmt-isolation/">
            
                    
                    管理隔离
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../k8s-ingress/nginx-ingress/">
            
                <a href="../k8s-ingress/nginx-ingress/">
            
                    
                    NGINX
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="../k8s-ingress/nginx-ingress/bigip/">
            
                <a href="../k8s-ingress/nginx-ingress/bigip/">
            
                    
                    Deployment Architectures
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../k8s-ingress/nginx-plus-ingress/">
            
                <a href="../k8s-ingress/nginx-plus-ingress/">
            
                    
                    NGINX PLUS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.3.1" data-path="../k8s-ingress/nginx-plus-ingress/monitor/dashboard.html">
            
                <a href="../k8s-ingress/nginx-plus-ingress/monitor/dashboard.html">
            
                    
                    Monitor Dashboard
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.2" data-path="../k8s-ingress/nginx-plus-ingress/bigip/">
            
                <a href="../k8s-ingress/nginx-plus-ingress/bigip/">
            
                    
                    Deployment Architectures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.3" data-path="../k8s-ingress/nginx-plus-ingress/l4-lb/">
            
                <a href="../k8s-ingress/nginx-plus-ingress/l4-lb/">
            
                    
                    L4 Load Balancing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.4" data-path="../k8s-ingress/nginx-plus-ingress/health-checks/">
            
                <a href="../k8s-ingress/nginx-plus-ingress/health-checks/">
            
                    
                    Active Health Checks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.5" data-path="../k8s-ingress/nginx-plus-ingress/release/">
            
                <a href="../k8s-ingress/nginx-plus-ingress/release/">
            
                    
                    Zero-Downtime Releases
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../k8s-ingress/performance/">
            
                <a href="../k8s-ingress/performance/">
            
                    
                    PERFORMANCE
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    CONTAINER NETWORK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="docker.html">
            
                <a href="docker.html">
            
                    
                    DOCKER
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="k8s.html">
            
                <a href="k8s.html">
            
                    
                    K8S
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="kubenet.html">
            
                <a href="kubenet.html">
            
                    
                    kubenet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="flannel.html">
            
                <a href="flannel.html">
            
                    
                    Flannel
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.2.3" data-path="Calico.html">
            
                <a href="Calico.html">
            
                    
                    Calico
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../sdn/">
            
                <a href="../sdn/">
            
                    
                    LINUX NETWORK
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../sdn/netfilter.html">
            
                <a href="../sdn/netfilter.html">
            
                    
                    Netfilter
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../sdn/ovs.html">
            
                <a href="../sdn/ovs.html">
            
                    
                    OVS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../sdn/ovs-switch.html">
            
                <a href="../sdn/ovs-switch.html">
            
                    
                    SWITCHING
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="../sdn/ovs-routing.html">
            
                <a href="../sdn/ovs-routing.html">
            
                    
                    ROUTING
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.3" data-path="../sdn/ovs-acl.html">
            
                <a href="../sdn/ovs-acl.html">
            
                    
                    ACLs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.4" data-path="../sdn/ovs-nfv.html">
            
                <a href="../sdn/ovs-nfv.html">
            
                    
                    NFV
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../sdn/mininet.html">
            
                <a href="../sdn/mininet.html">
            
                    
                    Mininet
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../cloud/">
            
                <a href="../cloud/">
            
                    
                    CLOUD
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../cloud/aws.html">
            
                <a href="../cloud/aws.html">
            
                    
                    AWS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../nginx/">
            
                <a href="../nginx/">
            
                    
                    NGINX
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="../nginx/concepts.html">
            
                <a href="../nginx/concepts.html">
            
                    
                    入门到精通
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="../nginx/install.html">
            
                <a href="../nginx/install.html">
            
                    
                    离线安装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="../nginx/controller.html">
            
                <a href="../nginx/controller.html">
            
                    
                    Nginx Controller
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.3.1" data-path="../nginx/apidrive.html">
            
                <a href="../nginx/apidrive.html">
            
                    
                    API
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="../nginx/usecase.html">
            
                <a href="../nginx/usecase.html">
            
                    
                    Use Case
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.4.1" data-path="../nginx/docker.html">
            
                <a href="../nginx/docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="../nginx/app/">
            
                <a href="../nginx/app/">
            
                    
                    现代应用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="../nginx/programming.html">
            
                <a href="../nginx/programming.html">
            
                    
                    可编程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../bigip/">
            
                <a href="../bigip/">
            
                    
                    BIG-IP
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../bigip/vs.html">
            
                <a href="../bigip/vs.html">
            
                    
                    Virtual Server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../bigip/lb.html">
            
                <a href="../bigip/lb.html">
            
                    
                    Load Balancing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../bigip/monitor.html">
            
                <a href="../bigip/monitor.html">
            
                    
                    Monitor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../bigip/profiles.html">
            
                <a href="../bigip/profiles.html">
            
                    
                    Profiles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../bigip/dns.html">
            
                <a href="../bigip/dns.html">
            
                    
                    DNS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../dist.html">
            
                <a href="../dist.html">
            
                    
                    DISTRIBUTED
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../zk/">
            
                <a href="../zk/">
            
                    
                    ZooKeeper
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" >
            
                <a target="_blank" href="https://cloudadc.github.io/distribute-dev-framework/content/dubbo">
            
                    
                    DUBBO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../mongo/">
            
                <a href="../mongo/">
            
                    
                    MongoDB
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1" data-path="../mongo/viewpoint/presentation.html">
            
                <a href="../mongo/viewpoint/presentation.html">
            
                    
                    定位
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1.1" data-path="../mongo/viewpoint/5thingsfornosql.html">
            
                <a href="../mongo/viewpoint/5thingsfornosql.html">
            
                    
                    NOSQL 选择五维度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.1.2" data-path="../mongo/viewpoint/oversea.html">
            
                <a href="../mongo/viewpoint/oversea.html">
            
                    
                    MongoDB 助力企业出海
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.1.3" data-path="../mongo/viewpoint/td.html">
            
                <a href="../mongo/viewpoint/td.html">
            
                    
                    Teradata 优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.1.4" data-path="../mongo/viewpoint/cards.html">
            
                <a href="../mongo/viewpoint/cards.html">
            
                    
                    MongoDB 对话卡片
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.3.2" data-path="../mongo/dba/basic.html">
            
                <a href="../mongo/dba/basic.html">
            
                    
                    基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3" data-path="../mongo/dev/">
            
                <a href="../mongo/dev/">
            
                    
                    开发
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.3.1" data-path="../mongo/dev/aggregation.html">
            
                <a href="../mongo/dev/aggregation.html">
            
                    
                    Aggregation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3.2" data-path="../mongo/dev/aggregation-sum.html">
            
                <a href="../mongo/dev/aggregation-sum.html">
            
                    
                    $sum
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3.3" data-path="../mongo/dev/transactions.html">
            
                <a href="../mongo/dev/transactions.html">
            
                    
                    分布式事务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3.4" data-path="../mongo/dev/java.html">
            
                <a href="../mongo/dev/java.html">
            
                    
                    Java
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3.5" data-path="../mongo/dev/geo.html">
            
                <a href="../mongo/dev/geo.html">
            
                    
                    地理信息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.3.4" data-path="../mongo/dba/cluster-admin.html">
            
                <a href="../mongo/dba/cluster-admin.html">
            
                    
                    运维
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.4.1" data-path="../mongo/dba/replication.html">
            
                <a href="../mongo/dba/replication.html">
            
                    
                    高可用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4.2" data-path="../mongo/dba/rs-deployments.html">
            
                <a href="../mongo/dba/rs-deployments.html">
            
                    
                    部署
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4.3" data-path="../mongo/dba/rs-maintenance.html">
            
                <a href="../mongo/dba/rs-maintenance.html">
            
                    
                    维护
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4.4" data-path="../mongo/dba/sharding.html">
            
                <a href="../mongo/dba/sharding.html">
            
                    
                    分片
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4.5" data-path="../mongo/dba/dba.html">
            
                <a href="../mongo/dba/dba.html">
            
                    
                    DBA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4.6" data-path="../mongo/dba/sh-restore.html">
            
                <a href="../mongo/dba/sh-restore.html">
            
                    
                    基于 Delayed Secondary 时间点恢复
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4.7" data-path="../mongo/dba/opsmanager.html">
            
                <a href="../mongo/dba/opsmanager.html">
            
                    
                    Ops Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4.8" data-path="../mongo/dba/perf.html">
            
                <a href="../mongo/dba/perf.html">
            
                    
                    性能调优
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4.9" data-path="../mongo/dba/troubleshooting.html">
            
                <a href="../mongo/dba/troubleshooting.html">
            
                    
                    监控
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.3.5" data-path="../mongo/dba/security.html">
            
                <a href="../mongo/dba/security.html">
            
                    
                    安全
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../kafka/">
            
                <a href="../kafka/">
            
                    
                    Kafka
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="../kafka/installing/">
            
                <a href="../kafka/installing/">
            
                    
                    安装
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../elastic/">
            
                <a href="../elastic/">
            
                    
                    ElasticSearch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../spark/">
            
                <a href="../spark/">
            
                    
                    Spark
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <a target="_blank" href="https://cloudadc.github.io/nodejs-honeypot/">
            
                    
                    NODE.JS HONEYPOT
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Calico</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="calico">Calico</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#__">&#x5B89;&#x88C5;</a>
<ul class="sectlevel2">
<li><a href="#_install_via_operator">Install via operator</a></li>
<li><a href="#_install_via_manifest">Install via Manifest</a></li>
<li><a href="#_install_calicoctl">Install calicoctl</a></li>
<li><a href="#_deploy_yaobank_app">Deploy YaoBank App</a></li>
</ul>
</li>
<li><a href="#___2">&#x5B89;&#x5168;</a>
<ul class="sectlevel2">
<li><a href="#__network_policy">&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981; Network Policy&#xFF1F;</a></li>
<li><a href="#_kubernetes_network_policy_calico_network_policy">Kubernetes Network Policy &#x4E0E; Calico &#x989D;&#x5916;&#x589E;&#x52A0;&#x7684; Network Policy</a></li>
<li><a href="#__pod">&#x5141;&#x8BB8;&#x6765;&#x81EA;&#x7279;&#x5B9A;POD&#x7684;&#x5165;&#x5411;&#x8BBF;&#x95EE;</a></li>
<li><a href="#__default_deny">&#x8BBE;&#x7F6E; Default Deny &#x7B56;&#x7565;</a></li>
<li><a href="#_yaobank">yaobank &#x7B56;&#x7565;&#x63A7;&#x5236;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</a></li>
<li><a href="#_calico_yaobank">Calico &#x7B56;&#x7565;&#x8BBE;&#x5B9A; yaobank &#x7B56;&#x7565;&#x63A7;&#x5236;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</a></li>
<li><a href="#_managing_trust_across_teams">Managing Trust Across Teams</a></li>
<li><a href="#_network_policy_for_hosts_and_nodeports">Network Policy for Hosts and NodePorts</a></li>
</ul>
</li>
<li><a href="#_pod_connectivity">POD Connectivity</a>
<ul class="sectlevel2">
<li><a href="#_pods_network">Pods Network</a></li>
<li><a href="#_wireguard_encryption">WireGuard Encryption</a></li>
<li><a href="#_ip_pools">IP Pools</a></li>
<li><a href="#_bgp_peering">BGP Peering</a></li>
<li><a href="#_cluster_ip_address_ranges">Cluster IP Address Ranges</a></li>
<li><a href="#_create_ip_pools">Create IP Pools</a></li>
</ul>
</li>
<li><a href="#_kubernetes_services_networking">Kubernetes Services Networking</a>
<ul class="sectlevel2">
<li><a href="#_kube_proxy_service_debug">kube-proxy service debug</a></li>
<li><a href="#_calico_native_service_handling">Calico Native Service Handling</a></li>
<li><a href="#_advertising_services">Advertising Services</a></li>
</ul>
</li>
<li><a href="#_calico_with_aws">Calico with AWS</a>
<ul class="sectlevel2">
<li><a href="#_aws_kubernetes">AWS &#x4E0A;&#x8FD0;&#x884C; Kubernetes &#x7684;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;</a></li>
<li><a href="#_aws_kubernetes_aws_cni_calico_cni">AWS &#x4E0A; Kubernetes &#x4F7F;&#x7528;AWS CNI &#x548C; Calico CNI &#x5BF9;&#x6BD4;</a></li>
<li><a href="#_aws_kubernetes_security_group">AWS &#x4E0A; Kubernetes Security Group</a></li>
<li><a href="#_aws_kubernetes_networkpolicy_encryption">AWS &#x4E0A; Kubernetes NetworkPolicy &#x548C; Encryption</a></li>
<li><a href="#_aws_calico_5">AWS &#x4E0A;&#x4F7F;&#x7528; Calico &#x7684; 5 &#x79CD;&#x7EC4;&#x5408;&#x65B9;&#x5F0F;</a></li>
<li><a href="#_aws_byoc_kubernetes">AWS &#x4E0A;&#x6784;&#x5EFA; BYOC Kubernetes &#x96C6;&#x7FA4;&#x5DE5;&#x5177;</a></li>
<li><a href="#_aws_cni_calico_policy_iptables_dataplane">AWS CNI + Calico Policy + iptables Dataplane</a></li>
<li><a href="#_aws_cni_calico_policy_calico_ebpf">AWS CNI + Calico Policy + Calico eBPF</a></li>
<li><a href="#_calico_cni_calico_policy_iptables_dataplane">Calico CNI + Calico Policy + iptables Dataplane</a></li>
<li><a href="#__aws_service_calico_production_enabled_kubernetes">&#x57FA;&#x4E8E; AWS Service &#x53CA; Calico &#x6784;&#x5EFA; Production Enabled Kubernetes &#x73AF;&#x5883;</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="__">&#x5B89;&#x88C5;</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_install_via_operator">Install via operator</h3>
<div class="listingblock">
<div class="title"><strong>1. install the operator</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl create <span class="hljs-_">-f</span> https://docs.projectcalico.org/archive/v3.16/manifests/tigera-operator.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. Install Calico</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    containerIPForwarding: Enabled
    ipPools:
    - cidr: 198.19.16.0/21
      natOutgoing: Enabled
      encapsulation: None
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. Calico pods</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n calico-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-typha-7fb7f4bd66-fvt89              1/1     Running   2          28m
calico-typha-7fb7f4bd66-gltp8              1/1     Running   2          28m
calico-node-42d6k                          1/1     Running   1          28m
calico-typha-7fb7f4bd66-lq6b5              1/1     Running   2          28m
calico-node-tlvbb                          1/1     Running   2          28m
calico-kube-controllers-57f767d97b-nxrnx   1/1     Running   3          28m
calico-node<span class="hljs-_">-l</span>5n4s                          1/1     Running   0          28m</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>calico-node</strong>: Calico-node runs on every Kubernetes cluster node as a DaemonSet. It is responsible for enforcing network policy, setting up routes on the nodes, plus managing any virtual interfaces for IPIP, VXLAN, or WireGuard.</p>
</li>
<li>
<p><strong>calico-typha</strong>: Typha is as a stateful proxy for the Kubernetes API server. It&#x2019;s used by every calico-node pod to query and watch Kubernetes resources without putting excessive load on the Kubernetes API server.  The Tigera Operator automatically scales the number of Typha instances as the cluster size grows.</p>
</li>
<li>
<p><strong>calico-kube-controllers</strong>: Runs a variety of Calico specific controllers that automate synchronization of resources. For example, when a Kubernetes node is deleted, it tidies up any IP addresses or other Calico resources associated with the node.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The Kubernetes network model does specify that pods can communicate with each other directly without NAT. But a pod communicating with another pod via a service is not direct communication, and normally will use NAT to change the connection destination from the service to the backing pod as part of load balancing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_install_via_manifest">Install via Manifest</h3>
<div class="listingblock">
<div class="title"><strong>1. Download Manifest</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl https://docs.projectcalico.org/manifests/calico.yaml -O</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Uncomment the <code>CALICO_IPV4POOL_CIDR</code>, and make sure the CIDR value equals the value of <code>--pod-network-cidr</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>2. Install Calico</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> calico.yaml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Refer to <a href="https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises" target="_blank">LINK</a> for more details.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>3. Calico pods</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A | grep calico
kube-system   calico-kube-controllers-855445d444-8rx26   1/1     Running   2          38h
kube-system   calico-node-56d8l                          1/1     Running   2          38h
kube-system   calico-node-r7ltw                          1/1     Running   2          38h</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Install via Manifest doesn&#x2019;t contains the <strong>calico-typha</strong>, which has less performance comapre with Install via operator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_install_calicoctl">Install calicoctl</h3>
<div class="listingblock">
<div class="title"><strong>1. Download</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -o calicoctl -O -L  <span class="hljs-string">&quot;https://github.com/projectcalico/calicoctl/releases/download/v3.20.1/calicoctl&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. Copy to /usr/local/bin</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">chmod +x calicoctl
sudo cp calicoctl /usr/<span class="hljs-built_in">local</span>/bin/</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. Verify</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ calicoctl get nodes -o wide
NAME            ASN       IPV4             IPV6
control-plane   (64512)   172.16.25.3/24
worker01        (64512)   172.16.25.4/24</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Refer to <a href="https://docs.projectcalico.org/reference/calicoctl/" class="bare" target="_blank">https://docs.projectcalico.org/reference/calicoctl/</a> for calicoctl reference.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_yaobank_app">Deploy YaoBank App</h3>
<div class="paragraph">
<p>The YaoBank Demo App contains 3 Microservice:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="files/microservice-on-k8s.png" alt="microservice on k8s.png"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Customer (which provides a simple web GUI)</p>
</li>
<li>
<p>Summary (some middleware business logic)</p>
</li>
<li>
<p>Database (the persistent datastore for the bank)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Originally from <a href="https://raw.githubusercontent.com/tigera/ccol1/main/yaobank.yaml" class="bare" target="_blank">https://raw.githubusercontent.com/tigera/ccol1/main/yaobank.yaml</a>, the nodeSelector are adjuested, and the docker image are retagged.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="files/yaobank.yaml">yaobank.yaml</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><strong>1. Deploy YaoBank App</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> yaobank.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. Show YaoBank App</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n yaobank --show-labels --no-headers
customer-cfc847564-dk56j    1/1   Running   0     82s   app=customer,pod-template-hash=cfc847564,version=v1
database-644f4569dd-mnncp   1/1   Running   0     83s   app=database,pod-template-hash=644f4569dd,version=v1
summary-5877cf8b57-9sc44    1/1   Running   0     82s   app=summary,pod-template-hash=5877cf8b57,version=v1
summary-5877cf8b57-kjb7b    1/1   Running   0     82s   app=summary,pod-template-hash=5877cf8b57,version=v1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. Verify App</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl http://control-plane:30180/ -I
HTTP/1.0 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 593
Server: Werkzeug/0.12.2 Python/2.7.12
Date: Fri, 24 Sep 2021 16:59:18 GMT</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___2">&#x5B89;&#x5168;</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__network_policy">&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981; Network Policy&#xFF1F;</h3>
<div class="paragraph">
<p><span class="image"><img src="files/networkpolicy.png" alt="networkpolicy.png"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>&#x5728;&#x5BB9;&#x5668;&#x5E73;&#x53F0;&#x9700;&#x8981;&#x57FA;&#x4E8E;IP&#x5730;&#x5740;&#x6216;&#x8005;&#x5E94;&#x7528;&#x7AEF;&#x53E3;&#x8FDB;&#x884C;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#xFF08;OSI L3&#x3001;L4&#xFF09;</p>
</li>
<li>
<p>&#x4EE5;&#x5E94;&#x7528;&#x4E3A;&#x4E2D;&#x5FC3;&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x901A;&#x8FC7;&#x6807;&#x7B7E;&#x5339;&#x914D;&#x7684;&#x65B9;&#x5F0F;&#x63A7;&#x5236;&#x7740;&#x5E94;&#x7528;POD&#x5982;&#x4F55;&#x88AB;&#x8BBF;&#x95EE;</p>
</li>
<li>
<p>Kubernetes &#x63D0;&#x4F9B;&#x4E86; Network Policy API &#x63A5;&#x53E3;&#xFF0C;&#x4F46;&#x662F;&#x6CA1;&#x6709;&#x505A;&#x5B9E;&#x73B0;&#xFF0C;&#x5B9E;&#x73B0;&#x4EA4;&#x7ED9; CNI &#x63D2;&#x4EF6;&#x5B9E;&#x73B0;&#x5382;&#x5546;&#xFF0C;&#x5B9E;&#x73B0;&#x4E0E;&#x5E95;&#x5C42;&#x7F51;&#x7EDC;&#x80FD;&#x529B;&#x7684;&#x89E3;&#x8026;</p>
</li>
<li>
<p>Network Policy&#x4EF7;&#x503C;</p>
<div class="ulist">
<ul>
<li>
<p>&#x653B;&#x51FB;&#x8005;&#x82B1;&#x6837;&#x66F4;&#x52A0;&#x806A;&#x660E;</p>
</li>
<li>
<p>&#x653B;&#x51FB;&#x91CF;&#x66F4;&#x591A;</p>
</li>
<li>
<p>&#x4E1C;&#x897F;&#x5411;&#x5B89;&#x5168;</p>
</li>
<li>
<p>&#x53EF;&#x4EE5;&#x8BA9;&#x975E;&#x7F51;&#x7EDC;&#x4E13;&#x5BB6;&#x914D;&#x7F6E;&#x9632;&#x706B;&#x5899;&#x3002;</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#x5357;&#x5317;&#x5411;&#x5B89;&#x5168;&#xFF1A;Calico Enterprise integrates with Fortinet firewalls, and make Fortinet understands ingress node or pod ip address.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_kubernetes_network_policy_calico_network_policy">Kubernetes Network Policy &#x4E0E; Calico &#x989D;&#x5916;&#x589E;&#x52A0;&#x7684; Network Policy</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kubernetes Network Policy</th>
<th class="tableblock halign-left valign-top">Calico Network Policy</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Ingress &amp; egress rules</p>
</li>
<li>
<p>Pod selectors</p>
</li>
<li>
<p>Namespce selectors</p>
</li>
<li>
<p>Port lists</p>
</li>
<li>
<p>Named Ports</p>
</li>
<li>
<p>IP blocks &amp; excepts</p>
</li>
<li>
<p>TCP, UDP, or SCTP</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Namespaced &amp; global scopes</p>
</li>
<li>
<p>Deny and log actions</p>
</li>
<li>
<p>Policy ordering</p>
</li>
<li>
<p>Richer matches, like ServiceAccounts, ICMP</p>
</li>
<li>
<p>Istio integration, like Cryptpgraphic identity matching, Layer 5-7 match criteria</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="__pod">&#x5141;&#x8BB8;&#x6765;&#x81EA;&#x7279;&#x5B9A;POD&#x7684;&#x5165;&#x5411;&#x8BBF;&#x95EE;</h3>
<div class="paragraph">
<p>&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x4E3A;&#x5141;&#x8BB8;&#x6765;&#x81EA;&#x7279;&#x5B9A;POD&#x7684;&#x5165;&#x5411;&#x8BBF;&#x95EE;&#xFF0C;&#x540D;&#x79F0;&#x4E3A;database&#x7684;POD&#x53EA;&#x5141;&#x8BB8;&#x6765;&#x81EA;summary POD&#x7684;&#x5165;&#x5411;&#x8BBF;&#x95EE;</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="files/allow-traffic-from-specific-pod.png" alt="allow traffic from specific pod.png"></span></p>
</div>
<div class="listingblock">
<div class="title"><strong>1. &#x67E5;&#x770B; database POD &#x6807;&#x7B7E;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n yaobank --show-labels | grep database
database-644f4569dd-mnncp   1/1     Running   0          22h   app=database,pod-template-hash=644f4569dd,version=v1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B; summary POD &#x6807;&#x7B7E;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n yaobank --show-labels | grep summary
summary-5877cf8b57-9sc44    1/1     Running   0          22h   app=summary,pod-template-hash=5877cf8b57,version=v1
summary-5877cf8b57-kjb7b    1/1     Running   0          22h   app=summary,pod-template-hash=5877cf8b57,version=v1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x5206;&#x522B;&#x5728; customer POD &#x548C;summary POD &#x5185;&#x8BBF;&#x95EE;database</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">CUSTOMER_POD=$(kubectl get pods -n yaobank <span class="hljs-_">-l</span> app=customer -o name)
SUMMARY_POD=$(kubectl get pods -n yaobank <span class="hljs-_">-l</span> app=summary -o name | head -n 1)

$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$CUSTOMER_POD</span> -n yaobank -- bash
root@customer-cfc847564-dk56j:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true -I -s | head -n 1</span>
HTTP/1.1 200 OK

$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$SUMMARY_POD</span> -n yaobank -- bash
root@summary-5877cf8b57-9sc44:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true -I -s | head -n 1</span>
HTTP/1.1 200 OK</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x6DFB;&#x52A0; database-policy</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: database-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: database
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: summary
    ports:
      - protocol: TCP
        port: 2379
  egress:
    - to: []
EOF</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>spec.podSelector.matchLabels</code> - &#x6307;&#x5B9A;&#x8981;&#x4FDD;&#x62A4;&#x7684;&#x76EE;&#x6807; POD &#x4E3A; database&#xFF0C;&#x5177;&#x6709; <code>app=database</code> &#x7684;&#x6807;&#x7B7E;&#x3002;</p>
</li>
<li>
<p><code>spec.ingress.from.podSelector.matchLabels</code> - &#x6307;&#x5B9A;&#x5141;&#x8BB8;&#x8BBF;&#x95EE;&#x7684; POD &#x9700;&#x5177;&#x6709; <code>app=summary</code> &#x6807;&#x7B7E;</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x91CD;&#x590D;&#x6267;&#x884C;&#x7B2C;3&#x6B65;&#xFF0C;&#x5206;&#x522B;&#x5728; customer POD &#x548C;summary POD &#x5185;&#x8BBF;&#x95EE;database</strong>*</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@customer-cfc847564-dk56j:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true -I -m 3</span>
curl: (28) Connection timed out after 3001 milliseconds

$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$SUMMARY_POD</span> -n yaobank -- bash
root@summary-5877cf8b57-9sc44:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true -I -s | head -n 1</span>
HTTP/1.1 200 OK</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
&#x5BF9;&#x6BD4;&#x7B2C;&#x4E09;&#x6B65;&#x6267;&#x884C;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x62D2;&#x7EDD;&#x6765;&#x81EA; customer POD &#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x800C;&#x5141;&#x8BB8;&#x6765;&#x81EA; summary POD &#x7684;&#x8BF7;&#x6C42;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>6. Clean Up</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete networkpolicy database-policy -n yaobank</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__default_deny">&#x8BBE;&#x7F6E; Default Deny &#x7B56;&#x7565;</h3>
<div class="listingblock">
<div class="title"><strong>1. &#x8BBF;&#x95EE;&#x670D;&#x52A1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl http://control-plane:30180 -m 3
  &lt;body&gt;
  	&lt;h1&gt;Welcome to YAO Bank&lt;/h1&gt;
  	&lt;h2&gt;Name: Spike Curtis&lt;/h2&gt;
  	&lt;h2&gt;Balance: 2389.45&lt;/h2&gt;
  	&lt;p&gt;&lt;a href=<span class="hljs-string">&quot;/logout&quot;</span>&gt;Log Out &gt;&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/body&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x8BBE;&#x7F6E; Default Deny &#x7B56;&#x7565;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: yaobank
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x91CD;&#x590D;&#x6B65;&#x9AA4; 1&#xFF0C;&#x8BBF;&#x95EE;&#x670D;&#x52A1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl http://control-plane:30180 -m 3
curl: (28) Operation timed out after 3001 milliseconds with 0 bytes received</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x5206;&#x522B;&#x5728; customer POD &#x548C; summary POD &#x4E2D;&#x8BBF;&#x95EE;&#x5176;&#x4ED6; POD</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$CUSTOMER_POD</span> -n yaobank -- bash
root@customer-cfc847564-dk56j:/app<span class="hljs-comment"># curl http://summary -m 3</span>
curl: (28) Resolving timed out after 3513 milliseconds
root@customer-cfc847564-dk56j:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true -m 3</span>
curl: (28) Resolving timed out after 3512 milliseconds

$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$SUMMARY_POD</span> -n yaobank -- bash
root@summary-5877cf8b57-9sc44:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true -m 3</span>
curl: (28) Resolving timed out after 3515 milliseconds</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. Clean UP</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete networkpolicy default-deny -n yaobank</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_yaobank">yaobank &#x7B56;&#x7565;&#x63A7;&#x5236;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</h3>
<div class="listingblock">
<div class="title"><strong>1. &#x8BBE;&#x7F6E; Default Deny &#x7B56;&#x7565;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: yaobank
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#x57FA;&#x4E8E; namespace &#x8BBE;&#x7F6E; Default Deny &#x7B56;&#x7565;&#xFF0C;namespace &#x5185;&#x6240;&#x6709; POD &#x51FA;&#x5411;&#x548C;&#x5165;&#x5411;&#x90FD;&#x88AB;&#x7981;&#x6B62;&#xFF1A;</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="files/np-default-deny.png" alt="np default deny.png"></span></p>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x57FA;&#x4E8E;&#x6240;&#x6709; POD &#x8BBE;&#x5B9A;&#x5165;&#x5411;&#x548C;&#x51FA;&#x5411;&#x7B56;&#x7565;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: customer-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: customer
  ingress:
    - ports:
      - protocol: TCP
        port: 80
  egress:
    - to: []
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: summary-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: summary
  ingress:
    - from:
      - podSelector:
          matchLabels:
            app: customer
      ports:
      - protocol: TCP
        port: 80
  egress:
    - to:
      - podSelector:
          matchLabels:
            app: database
      ports:
      - protocol: TCP
        port: 2379
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: database-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: database
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: summary
    ports:
      - protocol: TCP
        port: 2379
  egress:
    - to: []
EOF</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_calico_yaobank">Calico &#x7B56;&#x7565;&#x8BBE;&#x5B9A; yaobank &#x7B56;&#x7565;&#x63A7;&#x5236;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</h3>
<div class="paragraph">
<p>Kubernetes &#x5B9A;&#x4E49;&#x7684; Default Deny &#x53EA;&#x80FD;&#x57FA;&#x4E8E;&#x5355;&#x4E2A; namespace &#x8BBE;&#x5B9A;Default Deny&#xFF0C;&#x800C; Calico &#x7B56;&#x7565;&#x8BBE;&#x5B9A; Default Deny &#x662F;&#x57FA;&#x4E8E; Kubernetes &#x5168;&#x5C40;&#x8BBE;&#x5B9A;&#x3002;</p>
</div>
<div class="listingblock">
<div class="title"><strong>1. Default Deny</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: default-app-policy
spec:
  namespaceSelector: has(projectcalico.org/name) &amp;&amp; projectcalico.org/name not <span class="hljs-keyword">in</span> {<span class="hljs-string">&quot;kube-system&quot;</span>, <span class="hljs-string">&quot;calico-system&quot;</span>}
  types:
  - Ingress
  - Egress
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x66F4;&#x65B0;&#x5168;&#x5C40;&#x7B56;&#x7565;&#xFF0C;&#x5141;&#x8BB8; DNS</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: default-app-policy
spec:
  namespaceSelector: has(projectcalico.org/name) &amp;&amp; projectcalico.org/name not <span class="hljs-keyword">in</span> {<span class="hljs-string">&quot;kube-system&quot;</span>, <span class="hljs-string">&quot;calico-system&quot;</span>}
  types:
  - Ingress
  - Egress
  egress:
    - action: Allow
      protocol: UDP
      destination:
        selector: k8s-app == <span class="hljs-string">&quot;kube-dns&quot;</span>
        ports:
          - 53
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x57FA;&#x4E8E;&#x6BCF;&#x4E2A; POD &#x8BBE;&#x5B9A;&#x51FA;&#x5165;&#x5411;&#x7B56;&#x7565;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: database-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: database
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: summary
    ports:
      - protocol: TCP
        port: 2379
  egress:
    - to: []
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: customer-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: customer
  ingress:
    - ports:
      - protocol: TCP
        port: 80
  egress:
    - to: []
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: summary-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: summary
  ingress:
    - from:
      - podSelector:
          matchLabels:
            app: customer
      ports:
      - protocol: TCP
        port: 80
  egress:
    - to:
      - podSelector:
          matchLabels:
            app: database
      ports:
      - protocol: TCP
        port: 2379
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x67E5;&#x770B;&#x7B56;&#x7565;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ calicoctl get GlobalNetworkPolicy
NAME
default-app-policy

$ kubectl get NetworkPolicy -n yaobank
NAME              POD-SELECTOR   AGE
customer-policy   app=customer   4m16s
database-policy   app=database   4m15s
summary-policy    app=summary    4m15s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x8BBF;&#x95EE;&#x670D;&#x52A1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl http://control-plane:30180 -I <span class="hljs-_">-s</span> | head -n 1
HTTP/1.0 200 OK</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. Clean Up</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete NetworkPolicy summary-policy -n yaobank
kubectl delete NetworkPolicy customer-policy -n yaobank
kubectl delete NetworkPolicy database-policy -n yaobank

calicoctl delete GlobalNetworkPolicy default-app-policy</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_managing_trust_across_teams">Managing Trust Across Teams</h3>
<div class="listingblock">
<div class="title"><strong>1. Lockdown Cluster Egress</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: egress-lockdown
spec:
  order: 600
  namespaceSelector: has(projectcalico.org/name) &amp;&amp; projectcalico.org/name not <span class="hljs-keyword">in</span> {<span class="hljs-string">&quot;kube-system&quot;</span>, <span class="hljs-string">&quot;calico-system&quot;</span>}
  serviceAccountSelector: internet-egress not <span class="hljs-keyword">in</span> {<span class="hljs-string">&quot;allowed&quot;</span>}
  types:
  - Egress
  egress:
    - action: Deny
      destination:
        notNets:
          - 10.0.0.0/8
          - 172.16.0.0/12
          - 192.168.0.0/16
          - 198.18.0.0/15
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. Grant Selective Cluster Egress</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl label serviceaccount -n yaobank customer internet-egress=allowed</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. Clean Up</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl delete GlobalNetworkPolicy egress-lockdown</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_network_policy_for_hosts_and_nodeports">Network Policy for Hosts and NodePorts</h3>
<div class="listingblock">
<div class="title"><strong>1. Network Policy for Nodes</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF| calicoctl apply <span class="hljs-_">-f</span> -
---
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: default-node-policy
spec:
  selector: has(kubernetes.io/hostname)
  ingress:
  - action: Allow
    protocol: TCP
    <span class="hljs-built_in">source</span>:
      nets:
      - 127.0.0.1/32
  - action: Allow
    protocol: UDP
    <span class="hljs-built_in">source</span>:
      nets:
      - 127.0.0.1/32
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. Create Host Endpoints</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl patch kubecontrollersconfiguration default --patch=<span class="hljs-string">&apos;{&quot;spec&quot;: {&quot;controllers&quot;: {&quot;node&quot;: {&quot;hostEndpoint&quot;: {&quot;autoCreate&quot;: &quot;Enabled&quot;}}}}}&apos;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. Restrict Access to Kubernetes NodePorts</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
---
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: nodeport-policy
spec:
  order: 100
  selector: has(kubernetes.io/hostname)
  applyOnForward: <span class="hljs-literal">true</span>
  preDNAT: <span class="hljs-literal">true</span>
  ingress:
  - action: Deny
    protocol: TCP
    destination:
      ports: [<span class="hljs-string">&quot;30000:32767&quot;</span>]
  - action: Deny
    protocol: UDP
    destination:
      ports: [<span class="hljs-string">&quot;30000:32767&quot;</span>]
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. Selectively allow access to customer front end</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
---
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: nodeport-policy
spec:
  order: 100
  selector: has(kubernetes.io/hostname)
  applyOnForward: <span class="hljs-literal">true</span>
  preDNAT: <span class="hljs-literal">true</span>
  ingress:
  - action: Allow
    protocol: TCP
    destination:
      ports: [30180]
    <span class="hljs-built_in">source</span>:
      nets:
      - 198.19.15.254/32
  - action: Deny
    protocol: TCP
    destination:
      ports: [<span class="hljs-string">&quot;30000:32767&quot;</span>]
  - action: Deny
    protocol: UDP
    destination:
      ports: [<span class="hljs-string">&quot;30000:32767&quot;</span>]
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. Clean Up</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl delete GlobalNetworkPolicy default-node-policy
calicoctl delete GlobalNetworkPolicy nodeport-policy</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pod_connectivity">POD Connectivity</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_pods_network">Pods Network</h3>
<div class="listingblock">
<div class="title"><strong>1. Exec into the pod</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">CUSTOMER_POD=$(kubectl get pods -n yaobank <span class="hljs-_">-l</span> app=customer -o name)
kubectl <span class="hljs-built_in">exec</span> -ti -n yaobank <span class="hljs-variable">$CUSTOMER_POD</span> -- /bin/bash</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. list interfaces</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@customer-574bd6cc75-9wx6m:/app<span class="hljs-comment"># ip a</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
3: eth0@<span class="hljs-keyword">if</span>5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1410 qdisc noqueue state UP group default
    link/ether 86:2d:a8:72:34:7d brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 198.19.22.147/32 brd 198.19.22.147 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::842d:a8ff:fe72:347d/64 scope link
       valid_lft forever preferred_lft forever</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>There is a lo loopback interface with an IP address of 127.0.0.1. This is the standard loopback interface that every network namespace has by default. You can think of it as localhost for the pod itself.</p>
</li>
<li>
<p>There is an eth0 interface which has the pods actual IP address, 198.19.22.147. Notice this matches the IP address that kubectl get pods returned earlier.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><strong>3. ip link</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@customer-574bd6cc75-9wx6m:/app<span class="hljs-comment"># ip -c link show up</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
3: eth0@<span class="hljs-keyword">if</span>5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1410 qdisc noqueue state UP mode DEFAULT group default
    link/ether 86:2d:a8:72:34:7d brd ff:ff:ff:ff:ff:ff link-netnsid 0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. Routing Table</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@customer-574bd6cc75-9wx6m:/app<span class="hljs-comment"># ip route</span>
default via 169.254.1.1 dev eth0
169.254.1.1 dev eth0  scope link</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This shows that the pod&#x2019;s default route is out over the eth0 interface. i.e. Anytime it wants to send traffic to anywhere other than itself, it will send the traffic over eth0. (Note that the next hop address of 169.254.1.1 is a dummy address used by Calico. Every Calico networked pod sees this as its next hop.)
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>5. Exit from the customer pod</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">exit</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wireguard_encryption">WireGuard Encryption</h3>
<div class="listingblock">
<div class="title"><strong>1. enabling encryption</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl patch felixconfiguration default --type=<span class="hljs-string">&apos;merge&apos;</span> -p <span class="hljs-string">&apos;{&quot;spec&quot;:{&quot;wireguardEnabled&quot;:true}}&apos;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. wireguardPublicKey</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ calicoctl get node node1 -o yaml
apiVersion: projectcalico.org/v3
kind: Node
metadata:
  annotations:
    projectcalico.org/kube-labels: <span class="hljs-string">&apos;{&quot;beta.kubernetes.io/arch&quot;:&quot;amd64&quot;,&quot;beta.kubernetes.io/instance-type&quot;:&quot;k3s&quot;,&quot;beta.kubernetes.io/os&quot;:&quot;linux&quot;,&quot;k3s.io/hostname&quot;:&quot;node1&quot;,&quot;k3s.io/internal-ip&quot;:&quot;198.19.0.2&quot;,&quot;kubernetes.io/arch&quot;:&quot;amd64&quot;,&quot;kubernetes.io/hostname&quot;:&quot;node1&quot;,&quot;kubernetes.io/os&quot;:&quot;linux&quot;,&quot;node.kubernetes.io/instance-type&quot;:&quot;k3s&quot;}&apos;</span>
  creationTimestamp: <span class="hljs-string">&quot;2021-08-25T14:20:09Z&quot;</span>
  labels:
    beta.kubernetes.io/arch: amd64
    beta.kubernetes.io/instance-type: k3s
    beta.kubernetes.io/os: linux
    k3s.io/hostname: node1
    k3s.io/internal-ip: 198.19.0.2
    kubernetes.io/arch: amd64
    kubernetes.io/hostname: node1
    kubernetes.io/os: linux
    node.kubernetes.io/instance-type: k3s
  name: node1
  resourceVersion: <span class="hljs-string">&quot;22959&quot;</span>
  uid: 15122ad5-dfd7-4dfe-9c26-7a637a7088be
spec:
  bgp:
    ipv4Address: 198.19.0.2/20
  orchRefs:
  - nodeName: node1
    orchestrator: k8s
  wireguard:
    interfaceIPv4Address: 198.19.22.157
status:
  podCIDRs:
  - 198.19.17.0/24
  wireguardPublicKey: bIuu8myw2pIonLtCqtTf2bmzg4Syswp8m7wKh8C6mT4=</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. inspect wireguard from the interfaces</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ssh node1
$ ip addr | grep wireguard
13: wireguard.cali: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1400 qdisc noqueue state UNKNOWN group default qlen 1000
    inet 198.19.22.157/32 brd 198.19.22.157 scope global wireguard.cali</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. Disabling Encryption</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl patch felixconfiguration default --type=<span class="hljs-string">&apos;merge&apos;</span> -p <span class="hljs-string">&apos;{&quot;spec&quot;:{&quot;wireguardEnabled&quot;:false}}&apos;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ip_pools">IP Pools</h3>
<div class="ulist">
<ul>
<li>
<p>IP Pools are calico resource which define ranges of addresses that the calico IP address management and IPAM CNI plugin can use.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ calicoctl get IPPool default-ipv4-ippool -o yaml
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
  creationTimestamp: <span class="hljs-string">&quot;2021-08-25T14:43:21Z&quot;</span>
  name: default-ipv4-ippool
  resourceVersion: <span class="hljs-string">&quot;1371&quot;</span>
  uid: 218a5773-6fff-48fd<span class="hljs-_">-a</span>175-486b9ad66faa
spec:
  blockSize: 26
  cidr: 198.19.16.0/21
  ipipMode: Never
  natOutgoing: <span class="hljs-literal">true</span>
  nodeSelector: all()
  vxlanMode: Never</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The IP Pool can be per Node, pernamespace</p>
</li>
<li>
<p>To improve performance and scalibility, Calico IPAM to allocates IPs to nodes in blocks.IP &#x5206;&#x914D;&#x662F;&#x52A8;&#x6001;&#x7684;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;NODE&#x7528;&#x5B8C;&#x4E86; 64 &#x4E2A;&#x5730;&#x5740;&#x540E;&#xFF0C;Calico IPAM &#x4F1A;&#x5728;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0; Block&#xFF0C;&#x5982;&#x679C; Block &#x88AB;&#x5206;&#x914D;&#x5B8C;&#x4E86;&#xFF0C;&#x5219;&#x4F1A;&#x5230;&#x76F8;&#x90BB;&#x7684; NODE&#x7684;Block&#x501F;&#x4E00;&#x4E2A;IP&#x3002;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_bgp_peering">BGP Peering</h3>
<div class="ulist">
<ul>
<li>
<p><strong>&#x4EC0;&#x4E48;&#x662F; BGP</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>BGP &#x662F;&#x4E00;&#x4E2A;&#x6807;&#x51C6;&#x7684;&#x7F51;&#x7EDC;&#x534F;&#x8BAE;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x7F51;&#x7EDC;&#x8DEF;&#x7531;&#x5668;&#x90FD;&#x652F;&#x6301; BGP &#x534F;&#x8BAE;&#xFF0C;BGP &#x534F;&#x8BAE;&#x7528;&#x6765;&#x5728;&#x8DEF;&#x7531;&#x5668;&#x4E4B;&#x95F4;&#x5171;&#x4EAB;&#x548C;&#x540C;&#x6B65;&#x8DEF;&#x7531;&#x4FE1;&#x606F;&#x3002;</p>
</div>
</div>
<div class="sect2">
<h3 id="_cluster_ip_address_ranges">Cluster IP Address Ranges</h3>
<div class="paragraph">
<p>There are two address ranges that Kubernetes is normally configured with that are worth understanding:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The cluster pod CIDR is the range of IP addresses Kubernetes is expecting to be assigned to pods in the cluster.</p>
</li>
<li>
<p>The services CIDR is the range of IP addresses that are used for the Cluster IPs of Kubernetes Sevices (the virtual IP that corresponds to each Kubernetes Service).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl cluster-info dump | grep -m 2 -E <span class="hljs-string">&quot;service-cidr|cluster-cidr&quot;</span>
                    <span class="hljs-string">&quot;k3s.io/node-args&quot;</span>: <span class="hljs-string">&quot;[\&quot;server\&quot;,\&quot;--flannel-backend\&quot;,\&quot;none\&quot;,\&quot;--cluster-cidr\&quot;,\&quot;198.19.16.0/20\&quot;,\&quot;--service-cidr\&quot;,\&quot;198.19.32.0/20\&quot;,\&quot;--write-kubeconfig-mode\&quot;,\&quot;664\&quot;,\&quot;--disable-network-policy\&quot;]&quot;</span>,</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_ip_pools">Create IP Pools</h3>
<div class="listingblock">
<div class="title"><strong>1. Create externally routable IP Pool</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
---
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
  name: external-pool
spec:
  cidr: 198.19.24.0/21
  blockSize: 29
  ipipMode: Never
  natOutgoing: <span class="hljs-literal">true</span>
  nodeSelector: <span class="hljs-string">&quot;!all()&quot;</span>
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. Examine BGP peering status</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ssh node1
$ sudo calicoctl node status
Calico process is running.

IPv4 BGP status
+--------------+-------------------+-------+----------+-------------+
| PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |    INFO     |
+--------------+-------------------+-------+----------+-------------+
| 198.19.0.1   | node-to-node mesh | up    | 07:25:58 | Established |
| 198.19.0.3   | node-to-node mesh | up    | 07:25:56 | Established |
+--------------+-------------------+-------+----------+-------------+

IPv6 BGP status
No IPv6 peers found.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. Add a BGP Peer</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
---
apiVersion: projectcalico.org/v3
kind: BGPPeer
metadata:
  name: bgppeer-global-host1
spec:
  peerIP: 198.19.15.254
  asNumber: 64512
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. Examine BGP peering status</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ssh node1
$ sudo calicoctl node status
Calico process is running.

IPv4 BGP status
+---------------+-------------------+-------+----------+-------------+
| PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |
+---------------+-------------------+-------+----------+-------------+
| 198.19.0.1    | node-to-node mesh | up    | 07:25:58 | Established |
| 198.19.0.3    | node-to-node mesh | up    | 07:25:56 | Established |
| 198.19.15.254 | global            | up    | 08:39:33 | Established |
+---------------+-------------------+-------+----------+-------------+

IPv6 BGP status
No IPv6 peers found.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. Configure a Namespace to use External Routable IP Addresses</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF| kubectl apply <span class="hljs-_">-f</span> -
---
apiVersion: v1
kind: Namespace
metadata:
  annotations:
    cni.projectcalico.org/ipv4pools: <span class="hljs-string">&apos;[&quot;external-pool&quot;]&apos;</span>
  name: external-ns
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. Deploy Nginx</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF| kubectl apply <span class="hljs-_">-f</span> -
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: external-ns
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
        version: v1
    spec:
      containers:
      - name: nginx
        image: nginx
        imagePullPolicy: IfNotPresent
      nodeSelector:
        kubernetes.io/hostname: node1

---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: nginx
  namespace: external-ns
spec:
  podSelector:
    matchLabels:
      app: nginx
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - ports:
    - protocol: TCP
      port: 80
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>7. Access the NGINX pod from outside the cluster</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n external-ns -o wide --no-headers
nginx-8c44c96c6-xtw74   1/1   Running   0     70s   198.19.28.208   node1   &lt;none&gt;   &lt;none&gt;

$ curl 198.19.28.208 -I
HTTP/1.1 200 OK
Server: nginx/1.21.1
Date: Sat, 28 Aug 2021 08:48:10 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 06 Jul 2021 14:59:17 GMT
Connection: keep-alive
ETag: <span class="hljs-string">&quot;60e46fc5-264&quot;</span>
Accept-Ranges: bytes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>8. Check Calico IPAM allocations statistics</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ calicoctl ipam show
+----------+----------------+-----------+------------+-------------+
| GROUPING |      CIDR      | IPS TOTAL | IPS IN USE |  IPS FREE   |
+----------+----------------+-----------+------------+-------------+
| IP Pool  | 198.19.16.0/21 |      2048 | 12 (1%)    | 2036 (99%)  |
| IP Pool  | 198.19.24.0/21 |      2048 | 1 (0%)     | 2047 (100%) |
+----------+----------------+-----------+------------+-------------+</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kubernetes_services_networking">Kubernetes Services Networking</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_kube_proxy_service_debug">kube-proxy service debug</h3>
<div class="listingblock">
<div class="title"><strong>1. List the services</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get svc -n yaobank
NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
database   ClusterIP   198.19.33.67    &lt;none&gt;        2379/TCP       2d23h
summary    ClusterIP   198.19.46.158   &lt;none&gt;        80/TCP         2d23h
customer   NodePort    198.19.32.122   &lt;none&gt;        80:30180/TCP   2d23h</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. List the endpoints for each of the services</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get endpoints -n yaobank
NAME       ENDPOINTS                       AGE
customer   198.19.22.156:80                2d23h
database   198.19.21.74:2379               2d23h
summary    198.19.21.7:80,198.19.21.8:80   2d23h</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. List the pods</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n yaobank -o wide --no-headers
database-6c5db58d95-nnwsp   1/1   Running   2     2d23h   198.19.21.74    node2     &lt;none&gt;   &lt;none&gt;
summary-85c56b76d7-v8vs6    1/1   Running   2     2d23h   198.19.21.7     control   &lt;none&gt;   &lt;none&gt;
summary-85c56b76d7-nn9fv    1/1   Running   2     2d23h   198.19.21.8     control   &lt;none&gt;   &lt;none&gt;
customer-574bd6cc75-9wx6m   1/1   Running   2     2d23h   198.19.22.156   node1     &lt;none&gt;   &lt;none&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_clusterip">ClusterIP</h4>
<div class="paragraph">
<p><span class="image"><img src="files/Cluster_IP_Diagram.png" alt="Cluster IP Diagram.png"></span></p>
</div>
<div class="listingblock">
<div class="title"><strong>1. KUBE-SERVICES &#x2192; KUBE-SVC-XXXXXXXXXXXXXXXX</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ssh control
$ sudo iptables -v --numeric --table nat --list KUBE-SERVICES | grep  summary
    0     0 KUBE-MARK-MASQ  tcp  --  *      *      !198.19.16.0/20       198.19.46.158        /* yaobank/summary:http cluster IP */ tcp dpt:80
    0     0 KUBE-SVC-OIQIZJVJK6E34BR4  tcp  --  *      *       0.0.0.0/0            198.19.46.158        /* yaobank/summary:http cluster IP */ tcp dpt:80</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. KUBE-SVC-OIQIZJVJK6E34BR4 &#x2192; KUBE-SEP-XXXXXXXXXXXXXXXX</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ sudo iptables -v --numeric --table nat --list KUBE-SVC-OIQIZJVJK6E34BR4
Chain KUBE-SVC-OIQIZJVJK6E34BR4 (1 references)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination
    0     0 KUBE-SEP-GRMQA4KZODSYCGHU  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* yaobank/summary:http */ statistic mode random probability 0.50000000000
    0     0 KUBE-SEP-HE4BCN24RMUDWA6V  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* yaobank/summary:http */</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. KUBE-SEP-XXXXXXXXXXXXXXXX &#x2192; summary endpoint</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ sudo iptables -v --numeric --table nat --list KUBE-SEP-GRMQA4KZODSYCGHU
Chain KUBE-SEP-GRMQA4KZODSYCGHU (1 references)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination
    0     0 KUBE-MARK-MASQ  all  --  *      *       198.19.21.7          0.0.0.0/0            /* yaobank/summary:http */
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* yaobank/summary:http */ tcp to:198.19.21.7:80</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nodeport">NodePort</h4>
<div class="paragraph">
<p><span class="image"><img src="files/NodePorrt_Diagram.png " alt="NodePorrt Diagram.png "></span></p>
</div>
<div class="listingblock">
<div class="title"><strong>1. KUBE-SERVICES &#x2192; KUBE-NODEPORTS</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ sudo iptables -v --numeric --table nat --list KUBE-SERVICES | grep KUBE-NODEPORTS
  619 37158 KUBE-NODEPORTS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service nodeports; NOTE: this must be the last rule <span class="hljs-keyword">in</span> this chain */ ADDRTYPE match dst-type LOCAL</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. KUBE-NODEPORTS &#x2192; KUBE-SVC-XXXXXXXXXXXXXXXX</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ sudo iptables -v --numeric --table nat --list KUBE-NODEPORTS | grep customer
    0     0 KUBE-MARK-MASQ  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* yaobank/customer:http */ tcp dpt:30180
    0     0 KUBE-SVC-PX5FENG4GZJTCELT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* yaobank/customer:http */ tcp dpt:30180</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. KUBE-SVC-XXXXXXXXXXXXXXXX &#x2192; KUBE-SEP-XXXXXXXXXXXXXXXX</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ sudo iptables -v --numeric --table nat --list KUBE-SVC-PX5FENG4GZJTCELT
Chain KUBE-SVC-PX5FENG4GZJTCELT (2 references)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination
    0     0 KUBE-SEP-5S2QR7W7CXIFMZTT  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* yaobank/customer:http */</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. KUBE-SEP-XXXXXXXXXXXXXXXX &#x2192; customer endpoint</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ sudo iptables -v --numeric --table nat --list KUBE-SEP-5S2QR7W7CXIFMZTT
Chain KUBE-SEP-5S2QR7W7CXIFMZTT (1 references)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination
    0     0 KUBE-MARK-MASQ  all  --  *      *       198.19.22.156        0.0.0.0/0            /* yaobank/customer:http */
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* yaobank/customer:http */ tcp to:198.19.22.156:80</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nodeport_snat">NodePort SNAT</h4>
<div class="listingblock">
<div class="title"><strong>1, Access the customer service via nodeport</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl 198.19.0.1:30180
$ curl 198.19.0.2:30180
$ curl 198.19.0.3:30180</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. View the customer pod logs</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl logs  customer-574bd6cc75-9wx6m -n yaobank
198.19.0.1 - - [28/Aug/2021 15:14:21] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
198.19.0.2 - - [28/Aug/2021 15:16:54] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
198.19.0.3 - - [28/Aug/2021 15:17:03] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_calico_native_service_handling">Calico Native Service Handling</h3>
<div class="ulist">
<ul>
<li>
<p>Calico eBPF data plane supports native service handling.</p>
</li>
<li>
<p>Calico&#x2019;s eBPF dataplane is an alternative to the default standard Linux dataplane (which is iptables based). The eBPF dataplane has a number of advantages:</p>
<div class="ulist">
<ul>
<li>
<p>It scales to higher throughput.</p>
</li>
<li>
<p>It uses less CPU per GBit.</p>
</li>
<li>
<p>It has native support for Kubernetes services (without needing kube-proxy) that:</p>
<div class="ulist">
<ul>
<li>
<p>Reduces first packet latency for packets to services.</p>
</li>
<li>
<p>Preserves external client source IP addresses all the way to the pod.</p>
</li>
<li>
<p>Supports DSR (Direct Server Return) for more efficient service routing.</p>
</li>
<li>
<p>Uses less CPU than kube-proxy to keep the dataplane in sync.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><strong>1. Configure Calico to connect directly to the API server</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: kubernetes-services-endpoint
  namespace: tigera-operator
data:
  KUBERNETES_SERVICE_HOST: <span class="hljs-string">&quot;198.19.0.1&quot;</span>
  KUBERNETES_SERVICE_PORT: <span class="hljs-string">&quot;6443&quot;</span>
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2.  recreated with the new configuration</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete pod -n tigera-operator <span class="hljs-_">-l</span> k8s-app=tigera-operator</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. Disable kube-proxy</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl patch felixconfiguration default --patch=<span class="hljs-string">&apos;{&quot;spec&quot;: {&quot;bpfKubeProxyIptablesCleanupEnabled&quot;: false}}&apos;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. Switch on eBPF mode</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl patch felixconfiguration default --patch=<span class="hljs-string">&apos;{&quot;spec&quot;: {&quot;bpfEnabled&quot;: true}}&apos;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. restart YAO Bank&#x2019;s customer and summary pods</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete pod -n yaobank <span class="hljs-_">-l</span> app=customer
kubectl delete pod -n yaobank <span class="hljs-_">-l</span> app=summary</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_source_ip_preservation">Source IP preservation</h4>
<div class="paragraph">
<p><span class="image"><img src="files/eBPF_Source_IP_Diagram.png" alt="eBPF Source IP Diagram.png"></span></p>
</div>
<div class="listingblock">
<div class="title"><strong>1, Access the customer service via nodeport</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl 198.19.0.1:30180
$ curl 198.19.0.2:30180
$ curl 198.19.0.3:30180</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advertising_services">Advertising Services</h3>
<div class="listingblock">
<div class="title"><strong>1. Update Calico BGP configuration</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
---
apiVersion: projectcalico.org/v3
kind: BGPConfiguration
metadata:
  name: default
spec:
  serviceClusterIPs:
  - cidr: <span class="hljs-string">&quot;198.19.32.0/20&quot;</span>
EOF</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_calico_with_aws">Calico with AWS</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_aws_kubernetes">AWS &#x4E0A;&#x8FD0;&#x884C; Kubernetes &#x7684;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 41.6666%;">
<col style="width: 41.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">&#x5BF9;&#x6BD4;&#x9879;</th>
<th class="tableblock halign-left valign-top">EKS</th>
<th class="tableblock halign-left valign-top">BYOC</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x5B9A;&#x4E49;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Kubernetes as a Managed Cloud Service</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fully managed control plane</p>
</li>
<li>
<p>Requires less expertise</p>
</li>
<li>
<p>Heavily integrated with AWS services(ECR, ELB, IAM, VPC)</p>
</li>
<li>
<p>Built-in support for Calico</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Bring Your Own Cloud</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build a Kubernetes Cluster with AWS compute resources/services.</p>
</li>
<li>
<p>Self-Managed</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x4F18;&#x70B9;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Full Kubernetes Network Policy API implemnetation via Calico, etc</p>
</li>
<li>
<p>Advanced Calico Network Policy L3/L4 security ability</p>
</li>
<li>
<p>EKS with Calico CNI can save the IP addresses from the underlying VPC, also use the full set of Calico network features, like flexible IPAM</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Extremely flexible</p>
</li>
<li>
<p>More portable</p>
</li>
<li>
<p>Less costly</p>
</li>
<li>
<p>Well documented</p>
</li>
<li>
<p>Many tools available, like Kops, kubeadm, kubespray</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x7F3A;&#x70B9;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>The user is still required to manage dataplane worker nodes</p>
</li>
<li>
<p>Is closely tied with AWS services</p>
</li>
<li>
<p>Comparatively expensive</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Significant complexity for the user to manage</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_aws_kubernetes_aws_cni_calico_cni">AWS &#x4E0A; Kubernetes &#x4F7F;&#x7528;AWS CNI &#x548C; Calico CNI &#x5BF9;&#x6BD4;</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 41.6666%;">
<col style="width: 41.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">&#x9879;&#x76EE;</th>
<th class="tableblock halign-left valign-top">AWS CNI</th>
<th class="tableblock halign-left valign-top">Calico CNI</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x5B9A;&#x4E49;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>AWS CNI&#x2019;s full name is <strong>AWS VPC CNI</strong></p>
</li>
<li>
<p>Each Pod and Node get a IP(&#x6765;&#x81EA; VPC &#x4E2D;&#x7684; subnet)</p>
</li>
<li>
<p>Each Node can only handle a certain number of ENIs</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>EKS &#x548C; BYOC &#x96C6;&#x7FA4;&#x5747;&#x53EF;&#x4F7F;&#x7528; Calico CNI</p>
</li>
<li>
<p>Calico CNI in EKS uses Calico&#x2019;s high performance VXLAN tunnels to allow cluster nodes to communicate(&#x89E3;&#x51B3;&#x8DE8; subnet &#x901A;&#x4FE1;&#x95EE;&#x9898;)</p>
</li>
<li>
<p>Calico CNI in BYOC can use below 3 options for different scenarios:</p>
<div class="ulist">
<ul>
<li>
<p>BGP - &#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x5728;&#x540C;&#x4E00;&#x4E2A; subnet</p>
</li>
<li>
<p>IP-IP/VXLAN - &#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x5728;&#x591A;&#x4E2A; subnet</p>
</li>
<li>
<p>CrossSubnet - &#x6DF7;&#x5408;&#x6A21;&#x5F0F;&#xFF0C;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x5728;&#x540C;&#x4E00;&#x4E2A; subnet &#x4F7F;&#x7528; L2 &#x8F6C;&#x53D1;&#xFF0C;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x8DE8; subnet &#x91C7;&#x7528; Tunnel &#x8F6C;&#x53D1;</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x4F18;&#x70B9;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Pods get native IPs, Routing from outside or control nodes &quot;just works&quot;</p>
</li>
<li>
<p>Using multiple ENIS gives access to more bandwidth(&#x4E00;&#x4E2A;Node&#x4E0A;&#x7684; POD &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x591A;&#x4E2A; ENI &#x8BBF;&#x95EE;)</p>
</li>
<li>
<p>IAM integration is improved</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Use non-native POD IP(&#x4E0D;&#x4F1A;&#x6D88;&#x8017; VPC subnet &#x4E2D;&#x7684;IP)</p>
</li>
<li>
<p>More scalable</p>
</li>
<li>
<p>No IP address exhaustion consideration</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x7F3A;&#x70B9;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>IP address exhaustion</p>
</li>
<li>
<p>Number of pods per node is limited by number of ENIs and Node type</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Connections from pods to addresses outside the cluster need to be Source NATed</p>
</li>
<li>
<p>CrossSubnet overlay mode, the user needs to disable src/dest check in the AWS CLI it GUI</p>
</li>
<li>
<p>Calico CNI can not install on EKS control plane nodes - Control Plane nodes will not be able to initiate network connections to Calico Pod.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_aws_kubernetes_security_group">AWS &#x4E0A; Kubernetes Security Group</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 71.4286%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">TYPE</th>
<th class="tableblock halign-left valign-top">DESC</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security Group(EKS)</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>EKS clusters create a security group</p>
</li>
<li>
<p>Traffic from the control plane and managed node groups can flow freely</p>
</li>
<li>
<p>Assigned to the ENIs created by EKS</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security Group(Pod)</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>EKS support assigning SG directly to POD - SecurityGroupPolicy</p>
</li>
<li>
<p>Some instance Type not supported, eg, t3 instance not support security group on POD</p>
</li>
<li>
<p>Security Group Only - POD associate SG, means it give up the Calico Policy Enforcement</p>
</li>
<li>
<p>Source NAT is disabled - POD &#x51FA;&#x8BBF;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x5185;&#x90E8; Gateway POD</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security Group(BYOC)</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Can not have Pod level SG</p>
</li>
<li>
<p>Only for coarse-grained network policy, Kubernetes NetworkPolicy or Calico NetworkPolicy is necessary for fine-grained Policy control.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_aws_kubernetes_networkpolicy_encryption">AWS &#x4E0A; Kubernetes NetworkPolicy &#x548C; Encryption</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 41.6666%;">
<col style="width: 41.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">TYPE</th>
<th class="tableblock halign-left valign-top">Network Policy</th>
<th class="tableblock halign-left valign-top">Encryption</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x76EE;&#x7684;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Network Policy is the primary tool for securing a Kubernetes network</p>
</li>
<li>
<p>&#x8865;&#x5145; Kubernetes Network Policy &#x4E0D;&#x8DB3;&#xFF0C;&#x589E;&#x52A0;&#x9AD8;&#x7EA7; Policy &#x80FD;&#x529B; - Calico for Policy and Calico CNI both provide richer set of Policy capabilities, like <strong>policy ordering/priority</strong>, <strong>deny rule</strong>, <strong>flexible match rules</strong></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>An alternatives for encrypting data in flight - Without Calico CNI, a service mesh is necessary for application traffic encryption</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x65B9;&#x5F0F;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Abstracted from the network by using label selectors</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>WireGuard encryption</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x4F18;&#x52BF;</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Calico Policy can apply to multiple type, like Pods, VMs and host interface.</p>
</li>
<li>
<p>Massively simplifies network design</p>
</li>
<li>
<p>Istio Service Mesh Integgrated - Calico Policy for application layer security, L5 - L7 match criteria, cryptographic identity</p>
</li>
<li>
<p>Portable for Cloud vendor, eay for migration across Clouds, Avoid cloud provider lock-in</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Calico automatically creates and manages WireGuard tunnels between nodes providing transport level security for on-the-wire, in cluster pod traffic</p>
</li>
<li>
<p>WireGuard provides formally verified secure and performant tunnels with any specialized hardware</p>
</li>
<li>
<p>Ebable WireGuard only need one line command</p>
</li>
<li>
<p>Aavliable in both EKS(Calico CNI replace AWS CIS) and BYOC</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x7F3A;&#x70B9;</p></td>
<td class="tableblock halign-left valign-top"><div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Need Kernel support WireGuard mod</p>
</li>
<li>
<p>Modify the MTU used by Calico networking is recommend for increase networj performance</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_aws_calico_5">AWS &#x4E0A;&#x4F7F;&#x7528; Calico &#x7684; 5 &#x79CD;&#x7EC4;&#x5408;&#x65B9;&#x5F0F;</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">CNI</th>
<th class="tableblock halign-left valign-top">NetworkPolicy</th>
<th class="tableblock halign-left valign-top">Dataplane</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS-CNI</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">iptables</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS-CNI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calico Policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">iptables</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS-CNI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calico Policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calico eBPF</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calico CNI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calico Policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">iptables</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calico CNI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calico Policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calico eBPF</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_aws_byoc_kubernetes">AWS &#x4E0A;&#x6784;&#x5EFA; BYOC Kubernetes &#x96C6;&#x7FA4;&#x5DE5;&#x5177;</h3>
<div class="sect3">
<h4 id="_kops">KOps</h4>
<div class="ulist">
<ul>
<li>
<p>Like kubectl for clusters(kubectl &#x7BA1;&#x7406;&#x4E00;&#x4E2A;&#x96C6;&#x7FA4;&#xFF0C;KOps &#x53EF;&#x8DE8;&#x57FA;&#x7840;&#x8BBE;&#x65BD;&#x7BA1;&#x7406;&#x591A;&#x4E2A;&#x96C6;&#x7FA4;)</p>
</li>
<li>
<p>Build on top of kubectl and aws cli</p>
<div class="ulist">
<ul>
<li>
<p>Install KOps&#xFF1A;https://kops.sigs.k8s.io/install/</p>
</li>
</ul>
</div>
</li>
<li>
<p>Strengths</p>
<div class="ulist">
<ul>
<li>
<p>Builds production-grade clusters</p>
</li>
<li>
<p>Builds highly available cluster</p>
</li>
<li>
<p>Also provisions the necessary cloud infrastructure</p>
</li>
<li>
<p>Access to all of the Calico&#x2019;s feature</p>
</li>
<li>
<p>AWS is offically support</p>
</li>
<li>
<p>idempotent</p>
</li>
</ul>
</div>
</li>
<li>
<p>Consideration for setup KOps with AWS</p>
<div class="ulist">
<ul>
<li>
<p><strong>Authentication/IAM</strong> - KOps use AWS SDK, so if AWS CLI is authenticated, then KOps is authenticated. On the other side, create an IAM user is recommend, with: AmazonEC2FullAccess, AmazonRoute53FullAccess, AmazonS3FullAccess, IAMFullAccess, AmazonVPCFullAccess.</p>
<div class="ulist">
<ul>
<li>
<p><code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> pair can used by KOps</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>DNS</strong> - DNS records are needed to setup a cluster with KOps</p>
</li>
<li>
<p><strong>Cluster State Storage</strong> - Used to store Kops state and representation of the cluster, S3 Buckets be used.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_kubeadm">kubeadm</h4>
<div class="ulist">
<ul>
<li>
<p>Creates a minimum viable Kubernetes cluster that conforms to best practices</p>
</li>
<li>
<p>Strengths</p>
<div class="ulist">
<ul>
<li>
<p>As a build block in other ecosystems/installer tools</p>
</li>
<li>
<p>Very flexible across many environments</p>
</li>
</ul>
</div>
</li>
<li>
<p>Shortcomings</p>
<div class="ulist">
<ul>
<li>
<p>more complex to use than KOps</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_kubespray">kubespray</h4>
<div class="ulist">
<ul>
<li>
<p>Install Kubernetes using ansible</p>
</li>
<li>
<p>Strengths</p>
<div class="ulist">
<ul>
<li>
<p>Builds highly available clusters</p>
</li>
<li>
<p>Fully customisable</p>
</li>
<li>
<p>Easier than kubeadm and more flexible than KOps</p>
</li>
<li>
<p>One Ansible playbook can build a cluster</p>
</li>
<li>
<p>Great if you already use Absible</p>
</li>
</ul>
</div>
</li>
<li>
<p>Shortcomings</p>
<div class="ulist">
<ul>
<li>
<p>more complex to use than KOps</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aws_cni_calico_policy_iptables_dataplane">AWS CNI + Calico Policy + iptables Dataplane</h3>
<div class="sect3">
<h4 id="___3">&#x96C6;&#x7FA4;&#x521B;&#x5EFA;</h4>
<div class="listingblock">
<div class="title"><strong>1. eksctl &#x521B;&#x5EFA;&#x96C6;&#x7FA4;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">eksctl create cluster --name calicopolicy --version 1.18 --ssh-access --node-type t3.medium</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>&#x8BE6;&#x7EC6;&#x5173;&#x4E8E;eksctl: <a href="https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html" class="bare" target="_blank">https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x9A8C;&#x8BC1;&#x96C6;&#x7FA4;&#x521B;&#x5EFA;&#x6210;&#x529F;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes -A -o wide
NAME                                               STATUS   ROLES    AGE   VERSION               INTERNAL-IP     EXTERNAL-IP     OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME
ip-192-168-46-0.ap-northeast-1.compute.internal    Ready    &lt;none&gt;   10m   v1.18.20-eks-c9f1ce   192.168.46.0    3.113.245.244   Amazon Linux 2   4.14.248-189.473.amzn2.x86_64   docker://20.10.7
ip-192-168-76-87.ap-northeast-1.compute.internal   Ready    &lt;none&gt;   10m   v1.18.20-eks-c9f1ce   192.168.76.87   3.112.56.246    Amazon Linux 2   4.14.248-189.473.amzn2.x86_64   docker://20.10.7

$ kubectl get pods -A -o wide
NAMESPACE     NAME                       READY   STATUS    RESTARTS   AGE   IP               NODE                                               NOMINATED NODE   READINESS GATES
kube-system   aws-node-2gggk             1/1     Running   0          11m   192.168.46.0     ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   aws-node-q9kcb             1/1     Running   0          11m   192.168.76.87    ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-gdm9f   1/1     Running   0          19m   192.168.75.233   ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-wlqgf   1/1     Running   0          19m   192.168.49.127   ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-5bxqv           1/1     Running   0          11m   192.168.46.0     ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-cldfs           1/1     Running   0          11m   192.168.76.87    ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="___4">&#x6D4B;&#x8BD5;&#x5E94;&#x7528;&#x90E8;&#x7F72;</h4>
<div class="listingblock">
<div class="title"><strong>1. Deploy Demo App</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> https://raw.githubusercontent.com/tigera/ccol2aws/main/yaobank.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x9A8C;&#x8BC1;APP&#x521B;&#x5EFA;&#x6210;&#x529F;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n yaobank -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE                                               NOMINATED NODE   READINESS GATES
customer-bf4c98479-2np9p    1/1     Running   0          42s   192.168.57.109   ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
database-5b96655b86-88hwq   1/1     Running   0          42s   192.168.92.187   ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
summary-85c56b76d7-c28j6    1/1     Running   0          41s   192.168.54.112   ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
summary-85c56b76d7-td5rq    1/1     Running   0          41s   192.168.85.137   ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_aws_cni_ipam">AWS-CNI IPAM</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x4E0D;&#x540C;&#x578B;&#x53F7; EC2 &#x8282;&#x70B9;&#x652F;&#x6301;&#x7684; IP &#x6570;&#x91CF;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws ec2 describe-instance-types --filters Name=instance-type,Values=t3.* --query <span class="hljs-string">&quot;InstanceTypes[].{Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}&quot;</span> --output table
--------------------------------------
|        DescribeInstanceTypes       |
+----------+----------+--------------+
| IPv4addr | MaxENI   |    Type      |
+----------+----------+--------------+
|  15      |  4       |  t3.2xlarge  |
|  15      |  4       |  t3.xlarge   |
|  6       |  3       |  t3.medium   |
|  12      |  3       |  t3.large    |
|  2       |  2       |  t3.micro    |
|  2       |  2       |  t3.nano     |
|  4       |  3       |  t3.small    |
+----------+----------+--------------+</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>POD &#x53EF;&#x7528;&#x7684;&#x6700;&#x5927; IP&#x5730;&#x5740;</strong> - MaxENI * (IPv4addr-1 + 2)</p>
</li>
<li>
<p>t3.medium &#x6700;&#x5927; POD &#x53EF;&#x7528;&#x5730;&#x5740;&#x4E3A; 17</p>
</li>
<li>
<p>t3.large &#x6700;&#x5927; POD &#x53EF;&#x7528;&#x5730;&#x5740;&#x4E3A; 35</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B;&#x5F53;&#x524D;&#x5DF2;&#x4F7F;&#x7528;&#x7684; IP</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A -o wide --no-headers | awk <span class="hljs-string">&apos;{print $2, $7}&apos;</span>
aws-node-2gggk 192.168.46.0
aws-node-q9kcb 192.168.76.87
coredns-86f7d88d77-gdm9f 192.168.75.233
coredns-86f7d88d77-wlqgf 192.168.49.127
kube-proxy-5bxqv 192.168.46.0
kube-proxy-cldfs 192.168.76.87
customer-bf4c98479-2np9p 192.168.57.109
database-5b96655b86-88hwq 192.168.92.187
summary-85c56b76d7-c28j6 192.168.54.112
summary-85c56b76d7-td5rq 192.168.85.137</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
t3.medium &#x6700;&#x5927; POD &#x53EF;&#x7528;&#x5730;&#x5740;&#x4E3A; 17&#xFF0C;&#x4E24;&#x4E2A; t3.medium &#x6700;&#x5927; POD &#x53EF;&#x7528;&#x5730;&#x5740;&#x4E3A;34&#xFF0C;&#x5F53;&#x524D;&#x96C6;&#x7FA4;&#x5269;&#x4F59;&#x53EF;&#x5206;&#x914D; POD IP &#x4E3A;24&#xFF08;34-10&#xFF09;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x6269;&#x5C55; customer POD &#x5230; 30 &#x4E2A;&#x526F;&#x672C;&#xFF08;&#x90E8;&#x5206;&#x4F1A;&#x7531;&#x4E8E;&#x5206;&#x4E0D;&#x5230; IP &#x5730;&#x5740;&#x800C;&#x5931;&#x8D25;&#xFF0C;&#x65B0;&#x589E; 29 &#x4E2A; POD&#xFF0C;&#x53EF;&#x5206;&#x914D;&#x7684; IP &#x4E3A;24&#x4E2A;&#xFF0C;&#x6709;5&#x4E2A; POD&#x4E0D;&#x4F1A;&#x542F;&#x52A8;&#x6210;&#x529F;&#xFF09;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl scale -n yaobank --replicas 30 deployments/customer

// &#x5DF2;&#x4F7F;&#x7528;&#x4E86; 34 POD &#x5730;&#x5740;
$ kubectl get pods -A | grep Running | wc <span class="hljs-_">-l</span>
34

kubectl get pods -n  yaobank | grep Pending | wc <span class="hljs-_">-l</span>
5</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. POD &#x4E0A;&#x62A5;&#x9519;&#x65E5;&#x5FD7;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl describe pod -n yaobank customer-bf4c98479-x9pkf
Name:           customer-bf4c98479-x9pkf
Namespace:      yaobank
Priority:       0
Node:           &lt;none&gt;
Labels:         app=customer
                pod-template-hash=bf4c98479
                version=v1
Annotations:    kubernetes.io/psp: eks.privileged
Status:         Pending
IP:
IPs:            &lt;none&gt;
Controlled By:  ReplicaSet/customer-bf4c98479
Containers:
  customer:
    Image:        calico/yaobank-customer:certification
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from customer-token-gxgsc (ro)
Conditions:
  Type           Status
  PodScheduled   False
Volumes:
  customer-token-gxgsc:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  customer-token-gxgsc
    Optional:    <span class="hljs-literal">false</span>
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists <span class="hljs-keyword">for</span> 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists <span class="hljs-keyword">for</span> 300s
Events:
  Type     Reason            Age                From               Message
  ----     ------            ----               ----               -------
  Warning  FailedScheduling  90s (x9 over 11m)  default-scheduler  0/2 nodes are available: 2 Too many pods.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. Scale Down the APP</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl scale -n yaobank --replicas 1 deployments/customer</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_aws_eni_debug">AWS ENI DEBUG</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x67E5;&#x770B;&#x8BA1;&#x7B97;&#x8282;&#x70B9; 1 &#x4E0A;&#x7684; POD</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A -o wide | grep ip-192-168-46-0.ap-northeast-1.compute.internal
kube-system   aws-node-2gggk              1/1     Running   0          56m   192.168.46.0     ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-wlqgf    1/1     Running   0          65m   192.168.49.127   ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-5bxqv            1/1     Running   0          56m   192.168.46.0     ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
yaobank       summary-85c56b76d7-c28j6    1/1     Running   0          44m   192.168.54.112   ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x767B;&#x5F55;&#x5230;&#x8BA1;&#x7B97;&#x8282;&#x70B9;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes -o wide | grep ip-192-168-46-0.ap-northeast-1.compute.internal | awk <span class="hljs-string">&apos;{print $1, $7}&apos;</span>
ip-192-168-46-0.ap-northeast-1.compute.internal 3.113.245.244

$ ssh ec2-user@3.113.245.244</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">*3. &#x67E5;&#x770B; 3 &#x4E2A; ENI *</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ip addr
...
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0e:5e:cc:73:90:c9 brd ff:ff:ff:ff:ff:ff
    inet 192.168.46.0/19 brd 192.168.63.255 scope global dynamic eth0
       valid_lft 2698sec preferred_lft 2698sec
    inet6 fe80::c5e:ccff:fe73:90c9/64 scope link
       valid_lft forever preferred_lft forever
...
28: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0e:e7:e0:d9:b5:0d brd ff:ff:ff:ff:ff:ff
    inet 192.168.47.196/19 brd 192.168.63.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::ce7:e0ff:fed9:b50d/64 scope link
       valid_lft forever preferred_lft forever
...
14: eth2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0e:90:9b:08:ca:19 brd ff:ff:ff:ff:ff:ff
    inet 192.168.46.116/19 brd 192.168.63.255 scope global eth2
       valid_lft forever preferred_lft forever
    inet6 fe80::c90:9bff:fe08:ca19/64 scope link
       valid_lft forever preferred_lft forever</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x67E5;&#x770B; POD L2 Port</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ip a
...
3: eni55c81bde47f: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default
    link/ether e2:bd:60:03:d6:95 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet6 fe80::e0bd:60ff:fe03:d695/64 scope link
       valid_lft forever preferred_lft forever
6: eni14acb186de7@<span class="hljs-keyword">if</span>3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default
    link/ether 92:79:17:b2:0b:6a brd ff:ff:ff:ff:ff:ff link-netnsid 2
    inet6 fe80::9079:17ff:feb2:b6a/64 scope link
       valid_lft forever preferred_lft forever</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. ip rule</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ip rule
0:      from all lookup <span class="hljs-built_in">local</span>
512:    from all to 192.168.49.127 lookup main
512:    from all to 192.168.54.112 lookup main
512:    from all to 192.168.62.196 lookup main
512:    from all to 192.168.62.66 lookup main
512:    from all to 192.168.57.109 lookup main
512:    from all to 192.168.52.72 lookup main
512:    from all to 192.168.43.112 lookup main
512:    from all to 192.168.58.45 lookup main
512:    from all to 192.168.54.134 lookup main
512:    from all to 192.168.43.102 lookup main
512:    from all to 192.168.60.236 lookup main
512:    from all to 192.168.42.143 lookup main
512:    from all to 192.168.53.163 lookup main
512:    from all to 192.168.34.227 lookup main
1024:   from all fwmark 0x80/0x80 lookup main
1536:   from 192.168.52.72 to 192.168.0.0/16 lookup 3
1536:   from 192.168.43.112 to 192.168.0.0/16 lookup 3
1536:   from 192.168.58.45 to 192.168.0.0/16 lookup 3
1536:   from 192.168.54.134 to 192.168.0.0/16 lookup 3
1536:   from 192.168.43.102 to 192.168.0.0/16 lookup 3
1536:   from 192.168.60.236 to 192.168.0.0/16 lookup 2
1536:   from 192.168.42.143 to 192.168.0.0/16 lookup 2
1536:   from 192.168.53.163 to 192.168.0.0/16 lookup 2
1536:   from 192.168.34.227 to 192.168.0.0/16 lookup 2
32766:  from all lookup main
32767:  from all lookup default</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. &#x67E5;&#x770B;&#x8DEF;&#x7531;&#x8868;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ip route show table main
default via 192.168.32.1 dev eth0
169.254.169.254 dev eth0
192.168.32.0/19 dev eth0 proto kernel scope link src 192.168.46.0
192.168.34.227 dev enid9db68cfa09 scope link
192.168.42.143 dev eni7bb60820661 scope link
192.168.43.102 dev enif625a3b6ece scope link
192.168.43.112 dev eni84d1fe33efe scope link
192.168.49.127 dev eni55c81bde47f scope link
192.168.52.72 dev eni1cc215ba5a7 scope link
192.168.53.163 dev eni8229e014bcc scope link
192.168.54.112 dev eni14acb186de7 scope link
192.168.54.134 dev eni7ef47dfe8b7 scope link
192.168.57.109 dev enib7e715ac094 scope link
192.168.58.45 dev eni9628b5d8d6d scope link
192.168.60.236 dev enifedb39161ec scope link
192.168.62.66 dev eni028bc2a8670 scope link
192.168.62.196 dev eni29dcee60bb0 scope link

$ ip route show table 2
default via 192.168.32.1 dev eth1
192.168.32.1 dev eth1 scope link

$ ip route show table 3
default via 192.168.32.1 dev eth2
192.168.32.1 dev eth2 scope link</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_calico_policy_with_aws_cni_ipam_l3_l4">Calico Policy with AWS-CNI&#xFF08;&#x4E0D;&#x63D0;&#x4F9B; IPAM&#xFF0C;&#x53EA;&#x505A; L3/L4 &#x5B89;&#x5168;&#x7BA1;&#x63A7;&#xFF09;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x5B89;&#x88C5;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.7.8/config/v1.7/calico.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x9A8C;&#x8BC1;&#x5B89;&#x88C5;&#x6210;&#x529F;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n kube-system -o wide
NAME                                                  READY   STATUS    RESTARTS   AGE     IP               NODE                                               NOMINATED NODE   READINESS GATES
aws-node-2gggk                                        1/1     Running   0          86m     192.168.46.0     ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
aws-node-q9kcb                                        1/1     Running   0          86m     192.168.76.87    ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
calico-node-fbc9m                                     1/1     Running   0          2m9s    192.168.76.87    ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
calico-node-wtzvm                                     1/1     Running   0          2m9s    192.168.46.0     ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
calico-typha-5ff6788794-x95cv                         1/1     Running   0          2m10s   192.168.46.0     ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
calico-typha-horizontal-autoscaler-7d57c996b4-c6hqx   1/1     Running   0          2m10s   192.168.62.66    ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
coredns-86f7d88d77-gdm9f                              1/1     Running   0          94m     192.168.75.233   ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
coredns-86f7d88d77-wlqgf                              1/1     Running   0          94m     192.168.49.127   ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-proxy-5bxqv                                      1/1     Running   0          86m     192.168.46.0     ip-192-168-46-0.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-proxy-cldfs                                      1/1     Running   0          86m     192.168.76.87    ip-192-168-76-87.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
4 &#x4E2A;calico DeamonSet POD &#x521B;&#x5EFA;&#xFF0C;&#x4F7F;&#x7528; Node &#x8282;&#x70B9;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x8BB0;&#x5F55; POD &#x540D;&#x79F0;&#x5230;&#x811A;&#x672C;&#x4E2D;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> CUSTOMER_POD=$(kubectl get pods -n yaobank <span class="hljs-_">-l</span> app=customer -o name)
<span class="hljs-built_in">export</span> SUMMARY_POD=$(kubectl get pods -n yaobank <span class="hljs-_">-l</span> app=summary -o name | head -n 1)
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export CUSTOMER_POD=<span class="hljs-variable">${CUSTOMER_POD}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export SUMMARY_POD=<span class="hljs-variable">${SUMMARY_POD}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh
chmod 700 ccol2awsexports.sh
. ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x4ECE; cusomer POD &#x8BBF;&#x95EE; database POD&#xFF08;&#x8BBF;&#x95EE;&#x6210;&#x529F;&#xFF09;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$CUSTOMER_POD</span> -n yaobank -c customer -- /bin/bash

root@customer-bf4c98479-b4t8z:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true  -I</span>
HTTP/1.1 200 OK
Content-Type: application/json
X-Etcd-Cluster-Id: 7e27652122e8b2ae
X-Etcd-Index: 18
X-Raft-Index: 9861
X-Raft-Term: 5
Date: Tue, 02 Nov 2021 02:40:10 GMT
Content-Length: 1715</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x6DFB;&#x52A0;&#x5168;&#x5C40; Default Deny</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | calicoctl apply <span class="hljs-_">-f</span> -
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: default-app-policy
spec:
  namespaceSelector: has(projectcalico.org/name) &amp;&amp; projectcalico.org/name not <span class="hljs-keyword">in</span> {<span class="hljs-string">&quot;kube-system&quot;</span>, <span class="hljs-string">&quot;calico-system&quot;</span>}
  types:
  - Ingress
  - Egress
  egress:
    - action: Allow
      protocol: UDP
      destination:
        selector: k8s-app == <span class="hljs-string">&quot;kube-dns&quot;</span>
        ports:
          - 53
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. &#x4ECE; cusomer POD &#x8BBF;&#x95EE; database POD&#xFF08;&#x8BBF;&#x95EE;&#x5931;&#x8D25;&#xFF09;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$CUSTOMER_POD</span> -n yaobank -c customer -- /bin/bash

root@customer-bf4c98479-b4t8z:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true  -I --connect-timeout 3</span>
curl: (28) Connection timed out after 3000 milliseconds

root@customer-bf4c98479-b4t8z:/app<span class="hljs-comment"># exit</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>7. &#x6DFB;&#x52A0; Policy</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: database-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: database
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: summary
    ports:
      - protocol: TCP
        port: 2379
  egress:
    - to: []
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: customer-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: customer
  ingress:
    - ports:
      - protocol: TCP
        port: 80
  egress:
    - to: []
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: summary-policy
  namespace: yaobank
spec:
  podSelector:
    matchLabels:
      app: summary
  ingress:
    - from:
      - podSelector:
          matchLabels:
            app: customer
      ports:
      - protocol: TCP
        port: 80
  egress:
    - to:
      - podSelector:
          matchLabels:
            app: database
      ports:
      - protocol: TCP
        port: 2379
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>8. &#x4ECE; cusomer POD &#x8BBF;&#x95EE; database POD&#xFF08;&#x8BBF;&#x95EE;&#x5931;&#x8D25;&#xFF0C;Policy &#x5141;&#x8BB8; customer &#x8BBF;&#x95EE; summary&#xFF0C;&#x4F46;&#x4E0D;&#x5141;&#x8BB8; customer &#x8BBF;&#x95EE; database&#xFF09;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$CUSTOMER_POD</span> -n yaobank -c customer -- /bin/bash

root@customer-bf4c98479-b4t8z:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true  -I --connect-timeout 3</span>
curl: (28) Connection timed out after 3000 milliseconds

root@customer-bf4c98479-b4t8z:/app<span class="hljs-comment"># exit</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>9. &#x4ECE; summary &#x8BBF;&#x95EE; database&#xFF0C;&#x8BBF;&#x95EE;&#x6210;&#x529F;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">$SUMMARY_POD</span> -n yaobank -c summary -- /bin/bash

root@summary-85c56b76d7-c28j6:/app<span class="hljs-comment"># http://database:2379/v2/keys?recursive=true -I</span>
bash: http://database:2379/v2/keys?recursive=<span class="hljs-literal">true</span>: No such file or directory
root@summary-85c56b76d7-c28j6:/app<span class="hljs-comment"># curl http://database:2379/v2/keys?recursive=true -I</span>
HTTP/1.1 200 OK
Content-Type: application/json
X-Etcd-Cluster-Id: 7e27652122e8b2ae
X-Etcd-Index: 18
X-Raft-Index: 11118
X-Raft-Term: 5
Date: Tue, 02 Nov 2021 02:50:39 GMT
Content-Length: 1715</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_elb">ELB &#x53D1;&#x5E03;&#x670D;&#x52A1;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x521B;&#x5EFA; LoadBalancer &#x7C7B;&#x578B;&#x7684; Service &#x5C06;&#x4F1A;&#x5173;&#x8054;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt; EOF | kubectl apply <span class="hljs-_">-f</span> -
apiVersion: v1
kind: Service
metadata:
  name: yaobank-customer
  namespace: yaobank
spec:
  selector:
    app: customer
  ports:
    - port: 80
      targetPort: 80
  <span class="hljs-built_in">type</span>: LoadBalancer
EOF</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>&#x66F4;&#x591A;&#x5173;&#x4E8E; ELB&#xFF1A;https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B;&#x670D;&#x52A1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get svc -n yaobank
NAME               TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)        AGE
customer           NodePort       10.100.175.236   &lt;none&gt;                                                                         80:30180/TCP   93m
database           ClusterIP      10.100.193.59    &lt;none&gt;                                                                         2379/TCP       93m
summary            ClusterIP      10.100.89.160    &lt;none&gt;                                                                         80/TCP         93m
yaobank-customer   LoadBalancer   10.100.220.202   a9988b2b7630d491ead01ef28d21f90a-1857127968.ap-northeast-1.elb.amazonaws.com   80:31159/TCP   2m5s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x901A;&#x8FC7;&#x57DF;&#x540D;&#x8BBF;&#x95EE;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl a9988b2b7630d491ead01ef28d21f90a-1857127968.ap-northeast-1.elb.amazonaws.com -I
HTTP/1.0 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 593
Server: Werkzeug/0.12.2 Python/2.7.12
Date: Tue, 02 Nov 2021 02:57:57 GMT</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x67E5;&#x770B; customer POD Access &#x65E5;&#x5FD7;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl logs -n yaobank <span class="hljs-variable">$CUSTOMER_POD</span>
 * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
192.168.46.0 - - [02/Nov/2021 02:54:05] <span class="hljs-string">&quot;GET / HTTP/1.0&quot;</span> 200 -
192.168.46.0 - - [02/Nov/2021 02:57:42] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
192.168.76.87 - - [02/Nov/2021 02:57:42] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
192.168.76.87 - - [02/Nov/2021 02:57:44] <span class="hljs-string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> 404 -
192.168.46.0 - - [02/Nov/2021 02:57:57] <span class="hljs-string">&quot;HEAD / HTTP/1.1&quot;</span> 200 -</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x5220;&#x9664; LoadBalancer &#x7C7B;&#x578B;&#x7684; Service</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete service yaobank-customer -n=yaobank</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="___5">&#x5220;&#x9664;&#x96C6;&#x7FA4;</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">eksctl delete cluster --name calicopolicy</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aws_cni_calico_policy_calico_ebpf">AWS CNI + Calico Policy + Calico eBPF</h3>
<div class="sect3">
<h4 id="___6">&#x5B89;&#x88C5;&#x90E8;&#x7F72;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x57FA;&#x4E8E;&#x652F;&#x6301; eBPF &#x7684;&#x8282;&#x70B9;&#x521D;&#x59CB;&#x5316; EKS&#xFF08;Linux Kernel 5.4 &#x4EE5;&#x4E0A;&#xFF0C;&#x672C;&#x90E8;&#x7684;&#x4F7F;&#x7528;Bottlerocket&#xFF09;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">eksctl create cluster --name calicoebpf --version 1.18 --ssh-access --node-type t3.medium --node-ami-family Bottlerocket</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x9A8C;&#x8BC1; EKS &#x90E8;&#x7F72;&#xFF08;&#x4E24;&#x4E2A;&#x8282;&#x70B9;&#x7684; EKS &#x90E8;&#x7F72;&#x5B89;&#x88C5;&#xFF0C;KERNEL &#x7248;&#x672C;&#x662F; 5.4.141&#xFF0C;OS &#x955C;&#x50CF;&#x662F; Bottlerocket&#xFF1B;6 &#x4E2A; POD &#x542F;&#x52A8;&#xFF0C;2 &#x4E2A; coredns&#xFF0C;2 &#x4E2A; kube-proxy&#xFF0C;2 &#x4E2A; aws-node &#x63D0;&#x4F9B; AWS-CNI&#xFF09;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes -o wide
NAME                                                STATUS   ROLES    AGE     VERSION    INTERNAL-IP      EXTERNAL-IP     OS-IMAGE                               KERNEL-VERSION   CONTAINER-RUNTIME
ip-192-168-30-253.ap-northeast-1.compute.internal   Ready    &lt;none&gt;   5m50s   v1.18.20   192.168.30.253   35.76.115.233   Bottlerocket OS 1.3.0 (aws-k8s-1.18)   5.4.141          containerd://1.5.5+bottlerocket
ip-192-168-47-152.ap-northeast-1.compute.internal   Ready    &lt;none&gt;   5m48s   v1.18.20   192.168.47.152   3.112.41.202    Bottlerocket OS 1.3.0 (aws-k8s-1.18)   5.4.141          containerd://1.5.5+bottlerocket

$ kubectl get pods -A -o wide
NAMESPACE     NAME                       READY   STATUS    RESTARTS   AGE   IP               NODE                                                NOMINATED NODE   READINESS GATES
kube-system   aws-node-blqp4             1/1     Running   0          14m   192.168.30.253   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   aws-node-rg969             1/1     Running   0          14m   192.168.47.152   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-mmlbg   1/1     Running   0          21m   192.168.14.186   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-v776s   1/1     Running   0          21m   192.168.2.187    ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-lst24           1/1     Running   0          14m   192.168.30.253   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-ssmqd           1/1     Running   0          14m   192.168.47.152   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x5B89;&#x88C5; Calico</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> https://raw.githubusercontent.com/tigera/ccol2aws/main/calico-eks.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x9A8C;&#x8BC1; Calico &#x90E8;&#x7F72;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A -o wide | grep calico
kube-system   calico-node-dcsnv                                    1/1     Running   0          104s   192.168.47.152   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-gtwv8                                    1/1     Running   0          104s   192.168.30.253   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-typha-6dbb575c97-xhtg8                        1/1     Running   0          104s   192.168.47.152   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-typha-horizontal-autoscaler-9f999cfc5-bxctw   1/1     Running   0          103s   192.168.23.14    ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__ebpf_dataplane">&#x5F00;&#x542F; eBPF Dataplane</h4>
<div class="paragraph">
<p>&#x9ED8;&#x8BA4;&#xFF0C;Kubernetes &#x4E2D; Calico &#x548C; api-server &#x901A;&#x4FE1;&#x662F;&#x901A;&#x8FC7; kube-proxy &#x6765;&#x8FDB;&#x884C;&#x7684;&#xFF0C;&#x5F00;&#x542F; eBPF Dataplane &#x9700;&#x8981;&#x5220;&#x9664; kube-proxy&#xFF0C;&#x5220;&#x9664; kube-proxy &#x4E4B;&#x524D;&#x9700;&#x8981; Calico &#x76F4;&#x63A5;&#x548C; api-server &#x901A;&#x4FE1;&#x3002;</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="img/calico-ebpf-enable.png" alt="calico ebpf enable.png"></span></p>
</div>
<div class="listingblock">
<div class="title"><strong>1. &#x83B7;&#x53D6; API Server &#x7684;&#x5730;&#x5740;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get configmap -n kube-system kube-proxy -o jsonpath=<span class="hljs-string">&apos;{.data.kubeconfig}&apos;</span> | grep server
    server: https://5e8ff3570dd657770971f662<span class="hljs-built_in">fc</span>84a38a.yl4.ap-northeast-1.eks.amazonaws.com</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
EKS &#x96C6;&#x7FA4;&#x4E2D;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x662F;&#x96C6;&#x4E2D;&#x90E8;&#x7F72;&#x7684;&#xFF0C;&#x5BF9;&#x7528;&#x6237;&#x8005;&#x6765;&#x8BF4;&#xFF0C;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x4E0D;&#x53EF;&#x89C1;&#xFF0C;&#x7528;&#x6237;&#x6240;&#x83B7;&#x5F97;&#x5230;&#x7684; EKS &#x53EA;&#x6709;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x521B;&#x5EFA;&#x4E00;&#x4E2A; configmap &#x4FDD;&#x5B58; API Server &#x7684;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
kind: ConfigMap
apiVersion: v1
metadata:
  name: kubernetes-services-endpoint
  namespace: kube-system
data:
  KUBERNETES_SERVICE_HOST: <span class="hljs-string">&quot;5e8ff3570dd657770971f662fc84a38a.yl4.ap-northeast-1.eks.amazonaws.com&quot;</span>
  KUBERNETES_SERVICE_PORT: <span class="hljs-string">&quot;443&quot;</span>
EOF</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
calico-node &#x4F1A;&#x4ECE;&#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x8BFB;&#x53D6; api-server &#x7684;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#xFF0C;&#x4ECE;&#x800C;&#x76F4;&#x63A5;&#x548C; api-server &#x901A;&#x4FE1;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x521B;&#x5EFA; Calico IPPool</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl apply <span class="hljs-_">-f</span> - &lt;&lt;EOF
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
  name: vpc-subnet
spec:
  cidr: 192.168.0.0/16
  natOutgoing: <span class="hljs-literal">true</span>
  nodeSelector: !all()
EOF</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
EKS &#x9ED8;&#x8BA4; POD CIRD &#x662F; <code>192.168.0.0/16</code>&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">*4. Restart calico-node, calico-typha, and calico-kube-controllers *</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete pod -n kube-system <span class="hljs-_">-l</span> k8s-app=calico-node
kubectl delete pod -n kube-system <span class="hljs-_">-l</span> k8s-app=calico-kube-controllers
kubectl delete pod -n kube-system <span class="hljs-_">-l</span> k8s-app=calico-typha</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. Disable kube-proxy</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl patch ds -n kube-system kube-proxy -p <span class="hljs-string">&apos;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;nodeSelector&quot;:{&quot;non-calico&quot;: &quot;true&quot;}}}}}&apos;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. &#x4FEE;&#x6539; Calico felixconfiguration &#x914D;&#x7F6E;&#xFF0C;&#x5F00;&#x542F; eBPF Dataplane</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl patch felixconfiguration default --patch=<span class="hljs-string">&apos;{&quot;spec&quot;: {&quot;bpfEnabled&quot;: true}}&apos;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>7. coredns &#x66F4;&#x65B0;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete pod -n kube-system <span class="hljs-_">-l</span> k8s-app=kube-dns</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>8. &#x9A8C;&#x8BC1; Kubernetes &#x5F53;&#x524D;&#x72B6;&#x6001;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A -o wide
NAMESPACE     NAME                                                 READY   STATUS    RESTARTS   AGE     IP               NODE                                                NOMINATED NODE   READINESS GATES
kube-system   aws-node-blqp4                                       1/1     Running   0          50m     192.168.30.253   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   aws-node-rg969                                       1/1     Running   0          50m     192.168.47.152   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-28k24                                    1/1     Running   0          5m54s   192.168.47.152   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-q69k8                                    1/1     Running   0          5m53s   192.168.30.253   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-typha-6dbb575c97-x6zjk                        1/1     Running   0          5m50s   192.168.30.253   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-typha-horizontal-autoscaler-9f999cfc5-plwm9   1/1     Running   0          5m11s   192.168.50.191   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-cwccw                             1/1     Running   0          44s     192.168.23.14    ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-hwjnw                             1/1     Running   0          44s     192.168.32.76    ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
kube-proxy &#x88AB;&#x5220;&#x9664;&#xFF0C;&#x5F53;&#x524D; EKS kube-system &#x4E0B;&#x8FD0;&#x884C;&#x7740; 3 &#x7C7B; POD&#xFF1A;aws-node for AWS-CNI&#xFF0C;calico for Policy and sBPF&#xFF0C;coredns for internal DNS&#x3002;
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="__app">&#x90E8;&#x7F72;&#x6D4B;&#x8BD5; APP</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x90E8;&#x7F72;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> https://raw.githubusercontent.com/tigera/ccol2aws/main/yaobank.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="files/microservice-on-k8s.png" alt="microservice on k8s.png"></span></p>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x9A8C;&#x8BC1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -o wide -n yaobank
NAME                        READY   STATUS    RESTARTS   AGE    IP               NODE                                                NOMINATED NODE   READINESS GATES
customer-bf4c98479-ww2b5    1/1     Running   0          103s   192.168.34.103   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
database-5b96655b86-cc9gb   1/1     Running   0          103s   192.168.14.186   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
summary-85c56b76d7-8xhvr    1/1     Running   0          103s   192.168.59.216   ip-192-168-47-152.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
summary-85c56b76d7-ww8n6    1/1     Running   0          103s   192.168.26.219   ip-192-168-30-253.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x4E3A;&#x65B9;&#x4FBF;&#x540E;&#x7EED;&#x6D4B;&#x8BD5;&#xFF0C;&#x5C06; CUSTOMER POD &#x548C;SUMMARY POD &#x540D;&#x79F0;&#x4FDD;&#x5B58;&#x5230;&#x811A;&#x672C;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> CUSTOMER_POD=$(kubectl get pods -n yaobank <span class="hljs-_">-l</span> app=customer -o name)
<span class="hljs-built_in">export</span> SUMMARY_POD=$(kubectl get pods -n yaobank <span class="hljs-_">-l</span> app=summary -o name | head -n 1)
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export CUSTOMER_POD=<span class="hljs-variable">${CUSTOMER_POD}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export SUMMARY_POD=<span class="hljs-variable">${SUMMARY_POD}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="___7">&#x8BBF;&#x95EE;&#x670D;&#x52A1;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x521B;&#x5EFA; Loadbalancer &#x7C7B;&#x578B;&#x7684;Service</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt; EOF | kubectl apply <span class="hljs-_">-f</span> -
apiVersion: v1
kind: Service
metadata:
  name: yaobank-customer
  namespace: yaobank
spec:
  selector:
    app: customer
  ports:
    - port: 80
      targetPort: 80
  <span class="hljs-built_in">type</span>: LoadBalancer
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B; Service</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get svc -n yaobank
NAME               TYPE           CLUSTER-IP       EXTERNAL-IP                                                                   PORT(S)        AGE
customer           NodePort       10.100.145.100   &lt;none&gt;                                                                        80:30180/TCP   26m
database           ClusterIP      10.100.206.163   &lt;none&gt;                                                                        2379/TCP       26m
summary            ClusterIP      10.100.216.117   &lt;none&gt;                                                                        80/TCP         26m
yaobank-customer   LoadBalancer   10.100.176.85    aa2a64471ffee4d6f9618b063c881734-617348242.ap-northeast-1.elb.amazonaws.com   80:30716/TCP   17m</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x670D;&#x52A1;&#x8BBF;&#x95EE;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl aa2a64471ffee4d6f9618b063c881734-617348242.ap-northeast-1.elb.amazonaws.com -I
HTTP/1.0 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 593
Server: Werkzeug/0.12.2 Python/2.7.12
Date: Wed, 03 Nov 2021 06:25:48 GMT</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x67E5;&#x770B; Customer POD Access &#x65E5;&#x5FD7;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl logs -n yaobank <span class="hljs-variable">$CUSTOMER_POD</span>
 * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
192.168.35.47 - - [03/Nov/2021 06:16:52] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
192.168.35.47 - - [03/Nov/2021 06:25:45] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
192.168.35.47 - - [03/Nov/2021 06:25:48] <span class="hljs-string">&quot;HEAD / HTTP/1.1&quot;</span> 200 -
192.168.35.47 - - [03/Nov/2021 06:27:03] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. Delete ELB</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete service yaobank-customer -n=yaobank</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__source_ip_preservation">&#x5F00;&#x542F;&#x6E90;&#x5730;&#x5740;&#x900F;&#x4F20;&#xFF08;Source IP Preservation&#xFF09;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x5728;&#x521B;&#x5EFA; Service &#x662F;&#x901A;&#x8FC7;&#x8BBE;&#x5B9A; service.beta.kubernetes.io/aws-load-balancer-type &#x4E3A; nlb &#x5F00;&#x542F;&#x6E90;&#x5730;&#x5740;&#x900F;&#x4F20;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt; EOF | kubectl apply <span class="hljs-_">-f</span> -
apiVersion: v1
kind: Service
metadata:
  name: yaobank-customer
  namespace: yaobank
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: <span class="hljs-string">&quot;nlb&quot;</span>
spec:
  selector:
    app: customer
  ports:
    - port: 80
      targetPort: 80
  <span class="hljs-built_in">type</span>: LoadBalancer
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B;&#x670D;&#x52A1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get svc -n yaobank yaobank-customer
NAME               TYPE           CLUSTER-IP      EXTERNAL-IP                                                                          PORT(S)        AGE
yaobank-customer   LoadBalancer   10.100.167.26   ae9ef3a157df94411a7c5b5b2b038a8b-09836b10c4bd6927.elb.ap-northeast-1.amazonaws.com   80:30330/TCP   115s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x8BBF;&#x95EE;&#x670D;&#x52A1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl ae9ef3a157df94411a7c5b5b2b038a8b-09836b10c4bd6927.elb.ap-northeast-1.amazonaws.com -I
HTTP/1.0 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 593
Server: Werkzeug/0.12.2 Python/2.7.12
Date: Wed, 03 Nov 2021 06:39:59 GMT</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x4ECE; Customer &#x65E5;&#x5FD7;&#x4E2D;&#x67E5;&#x770B;&#x6E90;&#x5730;&#x5740;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl logs -n yaobank <span class="hljs-variable">$CUSTOMER_POD</span>
 * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
192.168.35.47 - - [03/Nov/2021 06:16:52] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
192.168.35.47 - - [03/Nov/2021 06:25:45] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
192.168.35.47 - - [03/Nov/2021 06:25:48] <span class="hljs-string">&quot;HEAD / HTTP/1.1&quot;</span> 200 -
192.168.35.47 - - [03/Nov/2021 06:27:03] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
106.38.20.203 - - [03/Nov/2021 06:38:58] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
106.38.20.203 - - [03/Nov/2021 06:39:59] <span class="hljs-string">&quot;HEAD / HTTP/1.1&quot;</span> 200 -</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>106.38.20.203</code> &#x5730;&#x5740;&#x4E3A;<code>&#x4E2D;&#x56FD; &#x5317;&#x4EAC; &#x7535;&#x4FE1;</code>&#x5730;&#x5740;&#xFF0C;Customer POD &#x5BA2;&#x6237;&#x7AEF;&#x5730;&#x5740;&#x4E3A;&#x6E90;&#x5BA2;&#x6237;&#x7AEF;&#x5730;&#x5740;&#x3002;
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up">Clean Up</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">eksctl delete cluster --name calicoebpf</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_calico_cni_calico_policy_iptables_dataplane">Calico CNI + Calico Policy + iptables Dataplane</h3>
<div class="sect3">
<h4 id="_eks">EKS &#x90E8;&#x7F72;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x521B;&#x5EFA;&#x4E00;&#x4E2A; EKS &#x96C6;&#x7FA4;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">eksctl create cluster --name calicocni --without-nodegroup</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>--without-nodegroup</code> &#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;&#x96C6;&#x7FA4;&#x4F46;&#x4E0D;&#x90E8;&#x7F72;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B;&#x8BA1;&#x7B97;&#x8282;&#x70B9;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes
No resources found</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
&#x4E0A;&#x9762;&#x6B65;&#x9AA4; 1 &#x6267;&#x884C;&#x6CA1;&#x6709;&#x521B;&#x5EFA;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#xFF0C;&#x800C;&#x5728; EKS &#x4E0B;&#xFF0C;&#x7528;&#x6237;&#x770B;&#x4E0D;&#x5230;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x4FE1;&#x606F;&#xFF0C;&#x6240;&#x4EE5;&#x4E0A;&#x9762; <code>kubectl get nodes</code> &#x7684;&#x7ED3;&#x679C;&#x4E3A;&#x7A7A;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x67E5;&#x770B; POD</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A -o wide
NAMESPACE     NAME                       READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES
kube-system   coredns-86f7d88d77-7fbzl   0/1     Pending   0          18m   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-wjqsg   0/1     Pending   0          18m   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
coredns POD &#x72B6;&#x6001;&#x4E3A; Pending&#xFF0C;&#x5728;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x548C; CNI &#x7F51;&#x7EDC;&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;&#x540E;&#x4F1A;&#x8FDB;&#x5165;&#x8FD0;&#x884C;&#x72B6;&#x6001;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x5220;&#x9664; aws cni &#x76F8;&#x5173;&#x7684; daemonset</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete daemonset -n kube-system aws-node</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
&#x672C;&#x90E8;&#x5206;&#x4F7F;&#x7528; Calico CNI&#xFF0C;&#x6240;&#x4EE5;&#x5220;&#x9664; aws-node daemonset&#x3002;
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="__calico_cni">&#x90E8;&#x7F72; Calico CNI</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x90E8;&#x7F72;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> https://raw.githubusercontent.com/tigera/ccol2aws/main/calico-vxlan.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x90E8;&#x7F72;&#x9A8C;&#x8BC1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A -o wide
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE     IP       NODE     NOMINATED NODE   READINESS GATES
kube-system   calico-kube-controllers-54658cf6f7-j2xdj   0/1     Pending   0          2m18s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-7fbzl                   0/1     Pending   0          25m     &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-wjqsg                   0/1     Pending   0          25m     &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
calico-kube-controllers POD &#x5904;&#x4E8E; Pending &#x72B6;&#x6001;&#xFF0C;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x521D;&#x59CB;&#x5316;&#x540E;&#x5B8C;&#x6210;&#x90E8;&#x7F72;&#xFF0C;&#x5E76;&#x4F1A;&#x542F;&#x52A8; calico-node &#x53CA; calico-typha POD&#x3002;
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="__eks">&#x521B;&#x5EFA;&#x4E00;&#x7EC4; EKS &#x8BA1;&#x7B97;&#x8282;&#x70B9;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x521B;&#x5EFA;&#x8BA1;&#x7B97;&#x8282;&#x70B9;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">eksctl create nodegroup --cluster calicocni --node-type t3.medium --node-ami-family Bottlerocket --max-pods-per-node 100 --ssh-access</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B;&#x521B;&#x5EFA;&#x7684;&#x8BA1;&#x7B97;&#x8282;&#x70B9;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes -o wide
NAME                                                STATUS   ROLES    AGE   VERSION    INTERNAL-IP      EXTERNAL-IP    OS-IMAGE                               KERNEL-VERSION   CONTAINER-RUNTIME
ip-192-168-11-183.ap-northeast-1.compute.internal   Ready    &lt;none&gt;   72s   v1.18.20   192.168.11.183   3.115.11.42    Bottlerocket OS 1.3.0 (aws-k8s-1.18)   5.4.141          containerd://1.5.5+bottlerocket
ip-192-168-71-154.ap-northeast-1.compute.internal   Ready    &lt;none&gt;   71s   v1.18.20   192.168.71.154   35.72.30.131   Bottlerocket OS 1.3.0 (aws-k8s-1.18)   5.4.141          containerd://1.5.5+bottlerocket</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684; POD</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A -o wide
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE    IP               NODE                                                NOMINATED NODE   READINESS GATES
kube-system   calico-kube-controllers-54658cf6f7-j2xdj   1/1     Running   0          11m    172.16.144.194   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-cfj68                          1/1     Running   0          105s   192.168.71.154   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-tp4rc                          1/1     Running   0          106s   192.168.11.183   ip-192-168-11-183.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-7fbzl                   1/1     Running   0          35m    172.16.144.195   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-wjqsg                   1/1     Running   0          35m    172.16.144.193   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-n8bbt                           1/1     Running   0          105s   192.168.71.154   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-xmgk8                           1/1     Running   0          106s   192.168.11.183   ip-192-168-11-183.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__app_2">&#x90E8;&#x7F72;&#x6D4B;&#x8BD5; APP</h4>
<div class="paragraph">
<p><span class="image"><img src="files/microservice-on-k8s.png" alt="microservice on k8s.png"></span></p>
</div>
<div class="listingblock">
<div class="title"><strong>1. &#x90E8;&#x7F72;&#x6D4B;&#x8BD5; APP</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> https://raw.githubusercontent.com/tigera/ccol2aws/main/yaobank.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B; POD IP</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n yaobank -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE                                                NOMINATED NODE   READINESS GATES
customer-bf4c98479-r98pd    1/1     Running   0          29s   172.16.136.131   ip-192-168-11-183.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
database-5b96655b86-8jf9h   1/1     Running   0          29s   172.16.136.129   ip-192-168-11-183.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
summary-85c56b76d7-skhls    1/1     Running   0          29s   172.16.136.130   ip-192-168-11-183.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
summary-85c56b76d7-sl6d9    1/1     Running   0          29s   172.16.144.196   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>172.16.0.0/16</code> &#x4E3A; Calico CNI IPAM &#x5206;&#x914D;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x548C; Node &#x8282;&#x70B9;&#x4E0D;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7F51;&#x7EDC;&#x3002;
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_calico_cni_ipam_aws_cni">Calico CNI IPAM&#xFF08;&#x6CA1;&#x6709; AWS CNI &#x6700;&#x5927;&#x53EF;&#x7528;&#x5730;&#x5740;&#x9650;&#x5236;&#xFF09;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x6269;&#x5C55; customer POD &#x670D;&#x52A1;&#x5230; 30 &#x4E2A;&#x526F;&#x672C;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl scale -n yaobank --replicas 30 deployments/customer</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x9A8C;&#x8BC1; POD &#x90FD;&#x542F;&#x52A8;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A | grep Running | wc <span class="hljs-_">-l</span>
40</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
&#x5904;&#x4E8E; Running &#x72B6;&#x6001;&#x7684; customer POD &#x72B6;&#x6001;&#x4E3A; 30&#xFF0C;&#x6CA1;&#x6709; AWS CNI &#x4E0B; t3.medium &#x8282;&#x70B9; 34 &#x4E2A;&#x6700;&#x5927;&#x53EF;&#x7528; POD &#x7684;&#x9650;&#x5236;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x67E5;&#x770B; Calico CNI IPAM &#x4FE1;&#x606F;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ calicoctl ipam show
+----------+---------------+-----------+------------+--------------+
| GROUPING |     CIDR      | IPS TOTAL | IPS IN USE |   IPS FREE   |
+----------+---------------+-----------+------------+--------------+
| IP Pool  | 172.16.0.0/16 |     65536 | 38 (0%)    | 65498 (100%) |
+----------+---------------+-----------+------------+--------------+</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x8C03;&#x6574; customer POD &#x670D;&#x52A1;&#x5230; 30 &#x4E2A;&#x526F;&#x672C;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl scale -n yaobank --replicas 1 deployments/customer</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wireguard">WireGuard &#x52A0;&#x5BC6;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x5F00;&#x542F; WireGuard &#x52A0;&#x5BC6;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">calicoctl patch felixconfiguration default --type=<span class="hljs-string">&apos;merge&apos;</span> -p <span class="hljs-string">&apos;{&quot;spec&quot;:{&quot;wireguardEnabled&quot;:true}}&apos;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x7EC4;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">eksctl create nodegroup --name calicoubuntu-ng --cluster calicocni --node-type t3.medium --node-ami-family Ubuntu2004 --max-pods-per-node 100 --ssh-access</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
EKS &#x652F;&#x6301;&#x521B;&#x5EFA;&#x591A;&#x4E2A;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x7EC4;&#x3002;
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x67E5;&#x770B;&#x8BA1;&#x7B97;&#x8282;&#x70B9;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes -o wide
NAME                                                STATUS   ROLES    AGE     VERSION    INTERNAL-IP      EXTERNAL-IP      OS-IMAGE                               KERNEL-VERSION    CONTAINER-RUNTIME
ip-192-168-11-183.ap-northeast-1.compute.internal   Ready    &lt;none&gt;   53m     v1.18.20   192.168.11.183   3.115.11.42      Bottlerocket OS 1.3.0 (aws-k8s-1.18)   5.4.141           containerd://1.5.5+bottlerocket
ip-192-168-50-53.ap-northeast-1.compute.internal    Ready    &lt;none&gt;   5m15s   v1.18.16   192.168.50.53    13.231.161.250   Ubuntu 20.04.3 LTS                     5.11.0-1020-aws   docker://20.10.7
ip-192-168-71-154.ap-northeast-1.compute.internal   Ready    &lt;none&gt;   53m     v1.18.20   192.168.71.154   35.72.30.131     Bottlerocket OS 1.3.0 (aws-k8s-1.18)   5.4.141           containerd://1.5.5+bottlerocket
ip-192-168-83-149.ap-northeast-1.compute.internal   Ready    &lt;none&gt;   5m15s   v1.18.16   192.168.83.149   18.183.59.23     Ubuntu 20.04.3 LTS                     5.11.0-1020-aws   docker://20.10.7</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x67E5;&#x770B;&#x8BA1;&#x7B97;&#x8282;&#x70B9;&#x7EC4;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ eksctl get nodegroup --cluster calicocni
[&#x2139;]  eksctl version 0.37.0
[&#x2139;]  using region ap-northeast-1
CLUSTER         NODEGROUP       STATUS          CREATED                 MIN SIZE                                                                                                                                               MAX SIZE DESIRED CAPACITY        INSTANCE TYPE   IMAGE ID                ASG NAME
calicocni       calicoubuntu-ng CREATE_COMPLETE 2021-11-03T08:24:04Z    2                                                                                                                                                      t3.medium        ami-0e06ef5bd62a4e456   eksctl-calicocni-nodegroup-calicoubuntu-ng-NodeGroup-TEL4A38S0MRC
calicocni       ng-7b6c0a05     CREATE_COMPLETE 2021-11-03T07:35:33Z    2                                                                                                                                                      t3.medium        ami-095ad745205a24ba6   eksctl-calicocni-nodegroup-ng-7b6c0a05-NodeGroup-VV084NCEIKHL</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x67E5;&#x770B; POD</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -A -o wide
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE     IP               NODE                                                NOMINATED NODE   READINESS GATES
kube-system   calico-kube-controllers-54658cf6f7-j2xdj   1/1     Running   0          64m     172.16.144.194   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-cfj68                          1/1     Running   0          54m     192.168.71.154   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-h5rp6                          1/1     Running   0          5m59s   192.168.50.53    ip-192-168-50-53.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-tmnvt                          1/1     Running   0          5m59s   192.168.83.149   ip-192-168-83-149.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-tp4rc                          1/1     Running   0          54m     192.168.11.183   ip-192-168-11-183.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-7fbzl                   1/1     Running   0          88m     172.16.144.195   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-86f7d88d77-wjqsg                   1/1     Running   0          88m     172.16.144.193   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-n8bbt                           1/1     Running   0          54m     192.168.71.154   ip-192-168-71-154.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-wnjg5                           1/1     Running   0          5m59s   192.168.83.149   ip-192-168-83-149.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-wxst2                           1/1     Running   0          5m59s   192.168.50.53    ip-192-168-50-53.ap-northeast-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-xmgk8                           1/1     Running   0          54m     192.168.11.183   ip-192-168-11-183.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. &#x67E5;&#x770B; Ubuntu &#x8282;&#x70B9;&#x7F51;&#x5361;&#x4FE1;&#x606F;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ssh ubuntu@13.231.161.250 ip addr
bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 06:41:75:56:5f:b1 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.50.53/19 brd 192.168.63.255 scope global dynamic ens5
       valid_lft 2738sec preferred_lft 2738sec
    inet6 fe80::441:75ff:fe56:5fb1/64 scope link
       valid_lft forever preferred_lft forever
5: wireguard.cali: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 8941 qdisc noqueue state UNKNOWN group default qlen 1000
    link/none
    inet 172.16.141.193/32 scope global wireguard.cali
       valid_lft forever preferred_lft forever
6: vxlan.calico: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8951 qdisc noqueue state UNKNOWN group default
    link/ether 66:74:c3:0a:39:53 brd ff:ff:ff:ff:ff:ff
    inet 172.16.141.192/32 scope global vxlan.calico
       valid_lft forever preferred_lft forever
    inet6 fe80::6474:c3ff:fe0a:3953/64 scope link
       valid_lft forever preferred_lft forever</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>wireguard.cali</code> is wireguard cali interface.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><strong>7. &#x67E5;&#x770B; wireguard &#x5185;&#x6838;&#x6A21;&#x5757;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ssh ubuntu@13.231.161.250 lsmod | grep wireguard
bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
wireguard              81920  0
curve25519_x86_64      49152  1 wireguard
libchacha20poly1305    16384  1 wireguard
libblake2s             16384  1 wireguard
ip6_udp_tunnel         16384  2 wireguard,vxlan
udp_tunnel             20480  2 wireguard,vxlan
libcurve25519_generic    49152  2 curve25519_x86_64,wireguard</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>8. &#x67E5;&#x770B; wireguard &#x5185;&#x6838;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x95F4;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ssh ubuntu@13.231.161.250 sudo dmesg | grep wireguard
bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
[  128.336924] wireguard: WireGuard 1.0.0 loaded. See www.wireguard.com <span class="hljs-keyword">for</span> information.
[  128.336927] wireguard: Copyright (C) 2015-2019 Jason A. Donenfeld &lt;Jason@zx2c4.com&gt;. All Rights Reserved.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up_2">Clean up</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">eksctl delete cluster --name calicocni</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__aws_service_calico_production_enabled_kubernetes">&#x57FA;&#x4E8E; AWS Service &#x53CA; Calico &#x6784;&#x5EFA; Production Enabled Kubernetes &#x73AF;&#x5883;</h3>
<div class="sect3">
<h4 id="__s3">&#x521B;&#x5EFA; S3 &#x5B58;&#x50A8;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x5B9A;&#x4E49; S3 &#x540D;&#x79F0;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> KOPS_STATE_STORE=s3://kops.calico.kylin
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export KOPS_STATE_STORE=<span class="hljs-variable">${KOPS_STATE_STORE}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x521B;&#x5EFA;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws s3 mb <span class="hljs-variable">${KOPS_STATE_STORE}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x67E5;&#x770B; S3 &#x6587;&#x4EF6;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws s3 ls kops.calico.kylin</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
&#x4E0A;&#x8FF0;&#x547D;&#x4EE4;&#x8F93;&#x51FA;&#x4E3A;&#x7A7A;&#xFF0C;&#x662F;&#x7531;&#x4E8E;&#x5F53;&#x524D;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x90E8;&#x7F72;&#x64CD;&#x4F5C;&#x3002;
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="__kubernetes">&#x521B;&#x5EFA; Kubernetes &#x96C6;&#x7FA4;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x5B9A;&#x4E49;&#x96C6;&#x7FA4;&#x540D;&#x79F0;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> CLUSTER_NAME=kopscalico.k8s.local
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export CLUSTER_NAME=<span class="hljs-variable">${CLUSTER_NAME}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B;&#x5F53;&#x524D;&#x53EF;&#x7528; Region</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws ec2 describe-availability-zones | grep RegionName | head -n 1
            <span class="hljs-string">&quot;RegionName&quot;</span>: <span class="hljs-string">&quot;ap-northeast-1&quot;</span>,

$ <span class="hljs-built_in">export</span> REGION=ap-northeast-1
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export REGION=<span class="hljs-variable">${REGION}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x67E5;&#x770B;&#x53EF;&#x7528; Zone</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws ec2 describe-availability-zones | grep ZoneName
            <span class="hljs-string">&quot;ZoneName&quot;</span>: <span class="hljs-string">&quot;ap-northeast-1a&quot;</span>,
            <span class="hljs-string">&quot;ZoneName&quot;</span>: <span class="hljs-string">&quot;ap-northeast-1c&quot;</span>,
            <span class="hljs-string">&quot;ZoneName&quot;</span>: <span class="hljs-string">&quot;ap-northeast-1d&quot;</span>,

$ <span class="hljs-built_in">export</span> ZONES=ap-northeast-1c,ap-northeast-1d
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export ZONES=<span class="hljs-variable">${ZONES}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x521B;&#x5EFA; Kubernetes &#x96C6;&#x7FA4;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kops create cluster --zones <span class="hljs-variable">${ZONES}</span> --networking calico --name <span class="hljs-variable">${CLUSTER_NAME}</span>
kops update cluster --name <span class="hljs-variable">${CLUSTER_NAME}</span> --yes --admin</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x7BA1;&#x7406;&#x8282;&#x70B9;&#x53EF;&#x8FD0;&#x884C;&#x4E1A;&#x52A1; POD</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl taint nodes --all node-role.kubernetes.io/master-
node/ip-172-20-40-151.ap-northeast-1.compute.internal untainted
taint <span class="hljs-string">&quot;node-role.kubernetes.io/master&quot;</span> not found
taint <span class="hljs-string">&quot;node-role.kubernetes.io/master&quot;</span> not found</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. &#x5B89;&#x88C5;&#x9A8C;&#x8BC1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes -A -o wide
NAME                                               STATUS   ROLES    AGE   VERSION    INTERNAL-IP     EXTERNAL-IP      OS-IMAGE             KERNEL-VERSION    CONTAINER-RUNTIME
ip-172-20-40-151.ap-northeast-1.compute.internal   Ready    master   51m   v1.19.15   172.20.40.151   13.231.253.234   Ubuntu 20.04.3 LTS   5.11.0-1019-aws   docker://19.3.14
ip-172-20-53-174.ap-northeast-1.compute.internal   Ready    node     50m   v1.19.15   172.20.53.174   13.114.199.57    Ubuntu 20.04.3 LTS   5.11.0-1019-aws   docker://19.3.14
ip-172-20-91-147.ap-northeast-1.compute.internal   Ready    node     49m   v1.19.15   172.20.91.147   35.77.14.22      Ubuntu 20.04.3 LTS   5.11.0-1019-aws   docker://19.3.14

$ kubectl get pods -A -o wide
NAMESPACE     NAME                                                                       READY   STATUS    RESTARTS   AGE   IP                NODE                                               NOMINATED NODE   READINESS GATES
kube-system   calico-kube-controllers-7d8f747cf4-kntrt                                   1/1     Running   0          51m   100.102.98.65     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-4jmct                                                          1/1     Running   0          50m   172.20.53.174     ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node<span class="hljs-_">-l</span>5hm5                                                          1/1     Running   0          51m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-v4sp6                                                          1/1     Running   0          50m   172.20.91.147     ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   dns-controller-8d8889c4b-xlbmt                                             1/1     Running   0          51m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   etcd-manager-events-ip-172-20-40-151.ap-northeast-1.compute.internal       1/1     Running   0          50m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   etcd-manager-main-ip-172-20-40-151.ap-northeast-1.compute.internal         1/1     Running   0          50m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kops-controller-84k4v                                                      1/1     Running   0          50m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-apiserver-ip-172-20-40-151.ap-northeast-1.compute.internal            2/2     Running   1          50m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-controller-manager-ip-172-20-40-151.ap-northeast-1.compute.internal   1/1     Running   0          50m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-dns-696cb84c7-bfjpd                                                   3/3     Running   0          49m   100.103.113.129   ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-dns-696cb84c7-rbdvj                                                   3/3     Running   0          51m   100.127.225.130   ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-dns-autoscaler-55f8f75459-rhqjb                                       1/1     Running   0          51m   100.127.225.129   ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-ip-172-20-40-151.ap-northeast-1.compute.internal                1/1     Running   0          50m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-ip-172-20-53-174.ap-northeast-1.compute.internal                1/1     Running   0          50m   172.20.53.174     ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-ip-172-20-91-147.ap-northeast-1.compute.internal                1/1     Running   0          48m   172.20.91.147     ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   kube-scheduler-ip-172-20-40-151.ap-northeast-1.compute.internal            1/1     Running   0          50m   172.20.40.151     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>7. &#x67E5;&#x770B; S3 &#x5B58;&#x50A8;&#x6587;&#x4EF6;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws s3 ls <span class="hljs-variable">${KOPS_STATE_STORE}</span>/<span class="hljs-variable">${CLUSTER_NAME}</span>/
                           PRE addons/
                           PRE backups/
                           PRE clusteraddons/
                           PRE instancegroup/
                           PRE manifests/
                           PRE pki/
                           PRE secrets/
2021-11-04 03:23:35       5355 cluster.spec
2021-11-04 03:21:33       1267 config
2021-11-04 03:23:35          6 kops-version.txt</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>8. &#x67E5;&#x770B; EC2 &#x5B9E;&#x4F8B;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws ec2 describe-instances --query <span class="hljs-string">&quot;Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,InstanceName:Tags[?Key==&apos;Name&apos;]|[0].Value,Status:State.Name}&quot;</span> --filters Name=instance-state-name,Values=running
[
    [
        {
            <span class="hljs-string">&quot;PublicIPAdd&quot;</span>: <span class="hljs-string">&quot;13.231.253.234&quot;</span>,
            <span class="hljs-string">&quot;InstanceName&quot;</span>: <span class="hljs-string">&quot;master-ap-northeast-1c.masters.kopscalico.k8s.local&quot;</span>,
            <span class="hljs-string">&quot;Status&quot;</span>: <span class="hljs-string">&quot;running&quot;</span>
        }
    ],
    [
        {
            <span class="hljs-string">&quot;PublicIPAdd&quot;</span>: <span class="hljs-string">&quot;13.114.199.57&quot;</span>,
            <span class="hljs-string">&quot;InstanceName&quot;</span>: <span class="hljs-string">&quot;nodes-ap-northeast-1c.kopscalico.k8s.local&quot;</span>,
            <span class="hljs-string">&quot;Status&quot;</span>: <span class="hljs-string">&quot;running&quot;</span>
        }
    ],
    [
        {
            <span class="hljs-string">&quot;PublicIPAdd&quot;</span>: <span class="hljs-string">&quot;35.77.14.22&quot;</span>,
            <span class="hljs-string">&quot;InstanceName&quot;</span>: <span class="hljs-string">&quot;nodes-ap-northeast-1d.kopscalico.k8s.local&quot;</span>,
            <span class="hljs-string">&quot;Status&quot;</span>: <span class="hljs-string">&quot;running&quot;</span>
        }
    ]
]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__boutique">&#x90E8;&#x7F72; Boutique &#x5E94;&#x7528;</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x90E8;&#x7F72; APP</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> https://raw.githubusercontent.com/GoogleCloudPlatform/microservices-demo/release/v0.2.2/release/kubernetes-manifests.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x67E5;&#x770B; APP</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -o wide
NAME                                     READY   STATUS    RESTARTS   AGE     IP                NODE                                               NOMINATED NODE   READINESS GATES
adservice<span class="hljs-_">-f</span>787c8dcd-959pp                1/1     Running   0          3m16s   100.127.225.135   ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
cartservice-67b89ffc69-jg9qr             1/1     Running   0          3m17s   100.103.113.135   ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
checkoutservice-75db8bf6f6-fgr9j         1/1     Running   0          3m17s   100.127.225.131   ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
currencyservice-68887d98fd-26tsq         1/1     Running   0          3m16s   100.103.113.130   ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
emailservice-5f8<span class="hljs-built_in">fc</span>7dbb4-8jtj6            1/1     Running   0          3m17s   100.103.113.131   ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
frontend-5c4745dfdb-rjr7m                1/1     Running   0          3m17s   100.127.225.132   ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
loadgenerator-86f46dcb88-pwh62           1/1     Running   4          3m17s   100.127.225.134   ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
paymentservice-6658569876-rd27v          1/1     Running   0          3m17s   100.103.113.133   ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
productcatalogservice-587f8bc64-dl79d    1/1     Running   0          3m17s   100.127.225.133   ip-172-20-53-174.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
recommendationservice-78965f984b-hrfgl   1/1     Running   0          3m17s   100.103.113.134   ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
redis-cart-74594bd569-69vfn              1/1     Running   0          3m16s   100.103.113.132   ip-172-20-91-147.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
shippingservice-6998959488-kt99d         1/1     Running   0          3m16s   100.102.98.66     ip-172-20-40-151.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__alb_application_load_balancer">&#x4F7F;&#x7528; ALB(Application Load Balancer )</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x83B7;&#x53D6; VPC ID</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> VPC_ID=`aws ec2 describe-vpcs --filters <span class="hljs-string">&quot;Name=tag:Name,Values=<span class="hljs-variable">$CLUSTER_NAME</span>&quot;</span> --query Vpcs[].VpcId --output text`
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export VPC_ID=<span class="hljs-variable">${VPC_ID}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$VPC_ID</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x521B;&#x5EFA; ALB &#x6240;&#x9700; RBAC</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/rbac-role.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x83B7;&#x53D6; ALB IAM Policy</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ wget https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/iam-policy.json
$ aws iam create-policy --policy-name ALBIngressControllerIAMPolicy --policy-document file://iam-policy.json
{
    <span class="hljs-string">&quot;Policy&quot;</span>: {
        <span class="hljs-string">&quot;PolicyName&quot;</span>: <span class="hljs-string">&quot;ALBIngressControllerIAMPolicy&quot;</span>,
        <span class="hljs-string">&quot;PolicyId&quot;</span>: <span class="hljs-string">&quot;ANPAX3FESL57C4KMOVMS3&quot;</span>,
        <span class="hljs-string">&quot;Arn&quot;</span>: <span class="hljs-string">&quot;arn:aws:iam::539363532670:policy/ALBIngressControllerIAMPolicy&quot;</span>,
        <span class="hljs-string">&quot;Path&quot;</span>: <span class="hljs-string">&quot;/&quot;</span>,
        <span class="hljs-string">&quot;DefaultVersionId&quot;</span>: <span class="hljs-string">&quot;v1&quot;</span>,
        <span class="hljs-string">&quot;AttachmentCount&quot;</span>: 0,
        <span class="hljs-string">&quot;PermissionsBoundaryUsageCount&quot;</span>: 0,
        <span class="hljs-string">&quot;IsAttachable&quot;</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">&quot;CreateDate&quot;</span>: <span class="hljs-string">&quot;2021-11-04T04:33:59+00:00&quot;</span>,
        <span class="hljs-string">&quot;UpdateDate&quot;</span>: <span class="hljs-string">&quot;2021-11-04T04:33:59+00:00&quot;</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. &#x8BBE;&#x5B9A; policy ARN &#x53D8;&#x91CF;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ <span class="hljs-built_in">export</span> POLICY_ARN=arn:aws:iam::539363532670:policy/ALBIngressControllerIAMPolicy
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export POLICY_ARN=<span class="hljs-variable">${POLICY_ARN}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x8BBE;&#x5B9A; Node Role &#x53D8;&#x91CF;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> NODE_ROLE=nodes.<span class="hljs-variable">$CLUSTER_NAME</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export NODE_ROLE=<span class="hljs-variable">${NODE_ROLE}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. Attach the node role to the policy created using the ARN</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws iam attach-role-policy --region=<span class="hljs-variable">$REGION</span> --role-name=<span class="hljs-variable">$NODE_ROLE</span> --policy-arn=<span class="hljs-variable">$POLICY_ARN</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>7. &#x4E0B;&#x8F7D; ALB Ingress Controller Deployment YAML</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">wget https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/alb-ingress-controller.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>8. &#x7F16;&#x8F91; alb-ingress-controller.yaml&#xFF0C;&#x4FEE;&#x6539;--cluster-name&#xFF0C;--aws-vpc-id&#xFF0C;--aws-region</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-comment"># Application Load Balancer (ALB) Ingress Controller Deployment Manifest.</span>
<span class="hljs-comment"># This manifest details sensible defaults for deploying an ALB Ingress Controller.</span>
<span class="hljs-comment"># GitHub: https://github.com/kubernetes-sigs/aws-alb-ingress-controller</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: alb-ingress-controller
  name: alb-ingress-controller
  <span class="hljs-comment"># Namespace the ALB Ingress Controller should run in. Does not impact which</span>
  <span class="hljs-comment"># namespaces it&apos;s able to resolve ingress resource for. For limiting ingress</span>
  <span class="hljs-comment"># namespace scope, see --watch-namespace.</span>
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: alb-ingress-controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: alb-ingress-controller
    spec:
      containers:
        - name: alb-ingress-controller
          args:
            <span class="hljs-comment"># Limit the namespace where this ALB Ingress Controller deployment will</span>
            <span class="hljs-comment"># resolve ingress resources. If left commented, all namespaces are used.</span>
            <span class="hljs-comment"># - --watch-namespace=your-k8s-namespace</span>

            <span class="hljs-comment"># Setting the ingress-class flag below ensures that only ingress resources with the</span>
            <span class="hljs-comment"># annotation kubernetes.io/ingress.class: &quot;alb&quot; are respected by the controller. You may</span>
            <span class="hljs-comment"># choose any class you&apos;d like for this controller to respect.</span>
            - --ingress-class=alb

            <span class="hljs-comment"># REQUIRED</span>
            <span class="hljs-comment"># Name of your cluster. Used when naming resources created</span>
            <span class="hljs-comment"># by the ALB Ingress Controller, providing distinction between</span>
            <span class="hljs-comment"># clusters.</span>
            - --cluster-name=kopscalico.k8s.local

            <span class="hljs-comment"># AWS VPC ID this ingress controller will use to create AWS resources.</span>
            <span class="hljs-comment"># If unspecified, it will be discovered from ec2metadata.</span>
            - --aws-vpc-id=vpc-04748aa440577e1ce

            <span class="hljs-comment"># AWS region this ingress controller will operate in.</span>
            <span class="hljs-comment"># If unspecified, it will be discovered from ec2metadata.</span>
            <span class="hljs-comment"># List of regions: http://docs.aws.amazon.com/general/latest/gr/rande.html#vpc_region</span>
            - --aws-region=ap-northeast-1

            <span class="hljs-comment"># Enables logging on all outbound requests sent to the AWS API.</span>
            <span class="hljs-comment"># If logging is desired, set to true.</span>
            <span class="hljs-comment"># - --aws-api-debug</span>
            <span class="hljs-comment"># Maximum number of times to retry the aws calls.</span>
            <span class="hljs-comment"># defaults to 10.</span>
            <span class="hljs-comment"># - --aws-max-retries=10</span>
          <span class="hljs-comment"># env:</span>
            <span class="hljs-comment"># AWS key id for authenticating with the AWS API.</span>
            <span class="hljs-comment"># This is only here for examples. It&apos;s recommended you instead use</span>
            <span class="hljs-comment"># a project like kube2iam for granting access.</span>
            <span class="hljs-comment">#- name: AWS_ACCESS_KEY_ID</span>
            <span class="hljs-comment">#  value: KEYVALUE</span>

            <span class="hljs-comment"># AWS key secret for authenticating with the AWS API.</span>
            <span class="hljs-comment"># This is only here for examples. It&apos;s recommended you instead use</span>
            <span class="hljs-comment"># a project like kube2iam for granting access.</span>
            <span class="hljs-comment">#- name: AWS_SECRET_ACCESS_KEY</span>
            <span class="hljs-comment">#  value: SECRETVALUE</span>
          <span class="hljs-comment"># Repository location of the ALB Ingress Controller.</span>
          image: docker.io/amazon/aws-alb-ingress-controller:v1.1.4
      serviceAccountName: alb-ingress-controller</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>9. &#x521B;&#x5EFA; ALB</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply <span class="hljs-_">-f</span>  alb-ingress-controller.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>10. &#x9A8C;&#x8BC1;&#x521B;&#x5EFA;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get all -n kube-system <span class="hljs-_">-l</span> app.kubernetes.io/name=alb-ingress-controller
NAME                                          READY   STATUS    RESTARTS   AGE
pod/alb-ingress-controller-7cf5bdc85b-nq867   1/1     Running   0          119s

NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/alb-ingress-controller   1/1     1            1           119s

NAME                                                DESIRED   CURRENT   READY   AGE
replicaset.apps/alb-ingress-controller-7cf5bdc85b   1         1         1       119s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>11. &#x63D2;&#x66F2; subnets</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws ec2 describe-subnets --filters <span class="hljs-string">&quot;Name=vpc-id,Values=<span class="hljs-variable">${VPC_ID}</span>&quot;</span> --query Subnets[].SubnetId --output table
------------------------------
|       DescribeSubnets      |
+----------------------------+
|  subnet-0a6dee79bf442694a  |
|  subnet-0892010209c3b11d6  |
+----------------------------+</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>12. &#x8BBE;&#x5B9A; subnet ID &#x53D8;&#x91CF;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> SUBNET_ID1=subnet-0a6dee79bf442694a
<span class="hljs-built_in">export</span> SUBNET_ID2=subnet-0892010209c3b11d6
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export SUBNET_ID1=<span class="hljs-variable">${SUBNET_ID1}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export SUBNET_ID2=<span class="hljs-variable">${SUBNET_ID2}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>13. Tag the subnet resources</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws ec2 create-tags --resources <span class="hljs-variable">$SUBNET_ID1</span> --tags Key=kubernetes.io/cluster/<span class="hljs-variable">$CLUSTER_NAME</span>,Value=shared
aws ec2 create-tags --resources <span class="hljs-variable">$SUBNET_ID2</span> --tags Key=kubernetes.io/cluster/<span class="hljs-variable">$CLUSTER_NAME</span>,Value=shared
aws ec2 create-tags --resources <span class="hljs-variable">$SUBNET_ID1</span> --tags Key=kubernetes.io/role/elb,Value=
aws ec2 create-tags --resources <span class="hljs-variable">$SUBNET_ID2</span> --tags Key=kubernetes.io/role/elb,Value=</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>14. &#x53D1;&#x5E03;&#x670D;&#x52A1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply <span class="hljs-_">-f</span> -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frontend-ingress
  namespace: default
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
  labels:
    app: frontend
spec:
  rules:
    - http:
        paths:
          - path: /*
            pathType: Exact
            backend:
              service:
                name: <span class="hljs-string">&quot;frontend-external&quot;</span>
                port:
                  number: 80
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>15. &#x67E5;&#x770B; Ingress</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ kubectl get ingress
Warning: extensions/v1beta1 Ingress is deprecated <span class="hljs-keyword">in</span> v1.14+, unavailable <span class="hljs-keyword">in</span> v1.22+; use networking.k8s.io/v1 Ingress
NAME               CLASS    HOSTS   ADDRESS                                                                      PORTS   AGE
frontend-ingress   &lt;none&gt;   *       e84cfdb8-default-frontendi-3e1f-839848441.ap-northeast-1.elb.amazonaws.com   80      9s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>16. &#x8BBF;&#x95EE;&#x670D;&#x52A1;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl http://e84cfdb8-default-frontendi-3e1f-839848441.ap-northeast-1.elb.amazonaws.com -I
HTTP/1.1 200 OK
Date: Thu, 04 Nov 2021 04:55:24 GMT
Content-Type: text/html; charset=utf-8
Connection: keep-alive
Set-Cookie: shop_session-id=345be51c<span class="hljs-_">-a</span>75d-4615-ba6f<span class="hljs-_">-f</span>74c7d54d9ad; Max-Age=172800</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__alb">&#x5220;&#x9664; ALB</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x5220;&#x9664; RBAC</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete <span class="hljs-_">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/rbac-role.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x5220;&#x9664; IAM Policy</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws iam detach-role-policy --role-name=<span class="hljs-variable">$NODE_ROLE</span> --policy-arn=<span class="hljs-variable">$POLICY_ARN</span>
aws iam delete-policy --policy-arn=<span class="hljs-variable">$POLICY_ARN</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>3. &#x5220;&#x9664; Ingress</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl delete ingress frontend-ingress</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>4. Remove the subnet tags</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws ec2 delete-tags --resources <span class="hljs-variable">$SUBNET_ID1</span> --tags Key=kubernetes.io/cluster/<span class="hljs-variable">$CLUSTER_NAME</span>,Value=shared
aws ec2 delete-tags --resources <span class="hljs-variable">$SUBNET_ID2</span> --tags Key=kubernetes.io/cluster/<span class="hljs-variable">$CLUSTER_NAME</span>,Value=shared
aws ec2 delete-tags --resources <span class="hljs-variable">$SUBNET_ID1</span> --tags Key=kubernetes.io/role/elb,Value=
aws ec2 delete-tags --resources <span class="hljs-variable">$SUBNET_ID2</span> --tags Key=kubernetes.io/role/elb,Value=</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>5. &#x67E5;&#x770B; ALB</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws elbv2 describe-load-balancers
{
    <span class="hljs-string">&quot;LoadBalancers&quot;</span>: [
        {
            <span class="hljs-string">&quot;LoadBalancerArn&quot;</span>: <span class="hljs-string">&quot;arn:aws:elasticloadbalancing:ap-northeast-1:539363532670:loadbalancer/app/e84cfdb8-default-frontendi-3e1f/2305fe802621a510&quot;</span>,
            <span class="hljs-string">&quot;DNSName&quot;</span>: <span class="hljs-string">&quot;e84cfdb8-default-frontendi-3e1f-839848441.ap-northeast-1.elb.amazonaws.com&quot;</span>,
            <span class="hljs-string">&quot;CanonicalHostedZoneId&quot;</span>: <span class="hljs-string">&quot;Z14GRHDCWA56QT&quot;</span>,
            <span class="hljs-string">&quot;CreatedTime&quot;</span>: <span class="hljs-string">&quot;2021-11-04T04:52:39.270000+00:00&quot;</span>,
            <span class="hljs-string">&quot;LoadBalancerName&quot;</span>: <span class="hljs-string">&quot;e84cfdb8-default-frontendi-3e1f&quot;</span>,
            <span class="hljs-string">&quot;Scheme&quot;</span>: <span class="hljs-string">&quot;internet-facing&quot;</span>,
            <span class="hljs-string">&quot;VpcId&quot;</span>: <span class="hljs-string">&quot;vpc-04748aa440577e1ce&quot;</span>,
            <span class="hljs-string">&quot;State&quot;</span>: {
                <span class="hljs-string">&quot;Code&quot;</span>: <span class="hljs-string">&quot;active&quot;</span>
            },
            <span class="hljs-string">&quot;Type&quot;</span>: <span class="hljs-string">&quot;application&quot;</span>,
            <span class="hljs-string">&quot;AvailabilityZones&quot;</span>: [
                {
                    <span class="hljs-string">&quot;ZoneName&quot;</span>: <span class="hljs-string">&quot;ap-northeast-1d&quot;</span>,
                    <span class="hljs-string">&quot;SubnetId&quot;</span>: <span class="hljs-string">&quot;subnet-0892010209c3b11d6&quot;</span>,
                    <span class="hljs-string">&quot;LoadBalancerAddresses&quot;</span>: []
                },
                {
                    <span class="hljs-string">&quot;ZoneName&quot;</span>: <span class="hljs-string">&quot;ap-northeast-1c&quot;</span>,
                    <span class="hljs-string">&quot;SubnetId&quot;</span>: <span class="hljs-string">&quot;subnet-0a6dee79bf442694a&quot;</span>,
                    <span class="hljs-string">&quot;LoadBalancerAddresses&quot;</span>: []
                }
            ],
            <span class="hljs-string">&quot;SecurityGroups&quot;</span>: [
                <span class="hljs-string">&quot;sg-02fcc82fecdf6a7c2&quot;</span>
            ],
            <span class="hljs-string">&quot;IpAddressType&quot;</span>: <span class="hljs-string">&quot;ipv4&quot;</span>
        }
    ]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>6. &#x8BBE;&#x5B9A; LOADBAL_ARN &#x53D8;&#x91CF;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> LOADBAL_ARN=arn:aws:elasticloadbalancing:ap-northeast-1:539363532670:loadbalancer/app/e84cfdb8-default-frontendi-3e1f/2305fe802621a510
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export LOADBAL_ARN=<span class="hljs-variable">${LOADBAL_ARN}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>7. &#x8BBE;&#x5B9A; Security Group &#x53D8;&#x91CF;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> LB_SG=sg-02fcc82fecdf6a7c2
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export LB_SG=<span class="hljs-variable">${LB_SG}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>8. &#x83B7;&#x53D6; VPC Owner ID</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws ec2 describe-vpcs --filters <span class="hljs-string">&quot;Name=vpc-id,Values=<span class="hljs-variable">${VPC_ID}</span>&quot;</span> --query Vpcs[].OwnerId --output text
539363532670</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>9. &#x8BBE;&#x5B9A; Owener ID &#x53D8;&#x91CF;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> OWNER_ID=539363532670
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export OWNER_ID=<span class="hljs-variable">${OWNER_ID}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>10. Get the security group ID associated with the nodes</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws ec2 describe-security-groups --filters <span class="hljs-string">&quot;Name=vpc-id,Values=<span class="hljs-variable">$VPC_ID</span>&quot;</span> <span class="hljs-string">&quot;Name=group-name,Values=nodes.<span class="hljs-variable">$CLUSTER_NAME</span>&quot;</span> --query SecurityGroups[].GroupId  --output text
sg-0da80fb9a77b7079c</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>11. &#x8BBE;&#x5B9A; NODE_SG &#x53D8;&#x91CF;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">export</span> NODE_SG=sg-0da80fb9a77b7079c
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export NODE_SG=<span class="hljs-variable">${NODE_SG}</span>&quot;</span> &gt;&gt; ccol2awsexports.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>12. Delete Ingress Rule</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ aws ec2 revoke-security-group-ingress --group-id=<span class="hljs-variable">$NODE_SG</span> --source-group=<span class="hljs-variable">$LB_SG</span> --group-owner=<span class="hljs-variable">$OWNER_ID</span> --protocol=tcp --port=0-65535
{
    <span class="hljs-string">&quot;Return&quot;</span>: <span class="hljs-literal">true</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>13. Delete Loadbalancer</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws elbv2 delete-load-balancer --load-balancer-arn=<span class="hljs-variable">${LOADBAL_ARN}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>14. Clean Up Security Group</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws ec2 delete-security-group --group-id=<span class="hljs-variable">$LB_SG</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up_3">Clean Up</h4>
<div class="listingblock">
<div class="title"><strong>1. &#x5220;&#x9664; Kubernetes &#x96C6;&#x7FA4;</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kops delete cluster --name <span class="hljs-variable">${CLUSTER_NAME}</span> --yes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong>2. &#x5220;&#x9664; S3</strong></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws s3 rb <span class="hljs-variable">${KOPS_STATE_STORE}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="flannel.html" class="navigation navigation-prev " aria-label="Previous page: Flannel">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../sdn/" class="navigation navigation-next " aria-label="Next page: LINUX NETWORK">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Calico","level":"1.3.2.3","depth":3,"next":{"title":"LINUX NETWORK","level":"1.4","depth":1,"path":"sdn/README.adoc","ref":"sdn/README.adoc","articles":[{"title":"Netfilter","level":"1.4.1","depth":2,"path":"sdn/netfilter.adoc","ref":"sdn/netfilter.adoc","articles":[]},{"title":"OVS","level":"1.4.2","depth":2,"path":"sdn/ovs.adoc","ref":"sdn/ovs.adoc","articles":[{"title":"SWITCHING","level":"1.4.2.1","depth":3,"path":"sdn/ovs-switch.adoc","ref":"sdn/ovs-switch.adoc","articles":[]},{"title":"ROUTING","level":"1.4.2.2","depth":3,"path":"sdn/ovs-routing.adoc","ref":"sdn/ovs-routing.adoc","articles":[]},{"title":"ACLs","level":"1.4.2.3","depth":3,"path":"sdn/ovs-acl.adoc","ref":"sdn/ovs-acl.adoc","articles":[]},{"title":"NFV","level":"1.4.2.4","depth":3,"path":"sdn/ovs-nfv.adoc","ref":"sdn/ovs-nfv.adoc","articles":[]}]},{"title":"Mininet","level":"1.4.3","depth":2,"path":"sdn/mininet.adoc","ref":"sdn/mininet.adoc","articles":[]}]},"previous":{"title":"Flannel","level":"1.3.2.2","depth":3,"path":"k8s-net/flannel.adoc","ref":"k8s-net/flannel.adoc","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{"copyrightYear":"2019","copyrightHolder":"Kylin Soong"},"plugins":["collapsible-menu","-sharing","sharing-plus","splitter","back-to-top-button","edit-link"],"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy Kylin Soong 2019","modify_label":"该文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"collapsible-menu":{},"splitter":{},"search":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"donate":{"wechat":"http://ksoong.org/docs/content/images/wechat.png","alipay":"http://ksoong.org/docs/content/images/alipay.png","title":"","button":"赞赏","alipayText":"支付宝捐赠","wechatText":"微信捐赠"},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"back-to-top-button":{},"sharing":{"weibo":true,"linkedin":true,"google":true,"facebook":true,"all":["facebook","google","linkedin","weibo"]},"edit-link":{"label":"Edit This Page","base":"https://github.com/kylinsoong/docs/blob/gh-pages"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css"}},"file":{"path":"k8s-net/Calico.adoc","mtime":"2021-11-19T02:29:20.424Z","type":"asciidoc"},"gitbook":{"version":"3.2.3","time":"2022-03-30T14:13:13.098Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

