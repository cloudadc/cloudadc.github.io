= 基本集群管理
:toc: manual

== mongod & mongo

`mongod` 命令用来启动一个 MongoDB Server 后台进程，`mongo` 是一个 Shell 入口用来连接 MongoDB Server 执行一些数据库管理操作。

=== 基本操作

本部分说明 `mongod` 和 `mongo` 命令的一些基本使用操作。

[source, text]
.*1. 启动 MongoDB Server*
----
$ mongod
2019-03-13T14:03:02.496+0000 I CONTROL  [initandlisten] MongoDB starting : pid=2530 port=27017 dbpath=/data/db 64-bit host=m103
2019-03-13T14:03:02.497+0000 I CONTROL  [initandlisten] db version v3.6.11
2019-03-13T14:03:02.497+0000 I CONTROL  [initandlisten] git version: b4339db12bf57ffee5b84a95c6919dbd35fe31c9

...

2019-03-13T14:03:03.493+0000 I FTDC     [initandlisten] Initializing full-time diagnostic data capture with directory '/data/db/diagnostic.data'
2019-03-13T14:03:03.493+0000 I NETWORK  [initandlisten] waiting for connections on port 27017
----

如上输出可以显示：

* MongoDB 启动成功
* 进程 ID 为 2530
* 监听的端口为 27017
* dbpath 为 /data/db
* MongoDB 的版本为 v3.6.11

[source, text]
.*2. 查看 mongod 监听的端口*
----
$ netstat -ntulop 2350
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name Timer
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      -                off (0.00/0/0)
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                off (0.00/0/0)
tcp        0      0 0.0.0.0:43671           0.0.0.0:*               LISTEN      -                off (0.00/0/0)
tcp        0      0 127.0.0.1:27017         0.0.0.0:*               LISTEN      2530/mongod      off (0.00/0/0)
tcp6       0      0 :::111                  :::*                    LISTEN      -                off (0.00/0/0)
tcp6       0      0 :::22                   :::*                    LISTEN      -                off (0.00/0/0)
tcp6       0      0 :::45403                :::*                    LISTEN      -                off (0.00/0/0)
udp        0      0 0.0.0.0:111             0.0.0.0:*                           -                off (0.00/0/0)
udp        0      0 0.0.0.0:51421           0.0.0.0:*                           -                off (0.00/0/0)
udp        0      0 0.0.0.0:7926            0.0.0.0:*                           -                off (0.00/0/0)
udp        0      0 0.0.0.0:775             0.0.0.0:*                           -                off (0.00/0/0)
udp        0      0 127.0.0.1:904           0.0.0.0:*                           -                off (0.00/0/0)
udp        0      0 0.0.0.0:68              0.0.0.0:*                           -                off (0.00/0/0)
udp6       0      0 :::111                  :::*                                -                off (0.00/0/0)
udp6       0      0 :::52488                :::*                                -                off (0.00/0/0)
udp6       0      0 :::14840                :::*                                -                off (0.00/0/0)
udp6       0      0 :::775                  :::*                                -                off (0.00/0/0) 
----

[source, text]
.*3. mongo 命令客户端连接*
----
$ mongo
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("26452ac6-5ba0-4a35-826f-2c5fcf491742") }
MongoDB server version: 3.6.11
MongoDB Enterprise > 
----

[source, text]
.*4. 查看 mongod Console 接收到连接信息*
----
2019-03-13T14:09:12.012+0000 I NETWORK  [listener] connection accepted from 127.0.0.1:46344 #1 (1 connection now open)
2019-03-13T14:09:12.012+0000 I NETWORK  [conn1] received client metadata from 127.0.0.1:46344 conn1: { application: { name: "MongoDB Shell" }, driver: { name: "MongoDB Internal Client", version: "3.6.11" }, os: { type: "Linux", name: "Ubuntu", architecture: "x86_64", version: "14.04" } } 
----

[source, text]
.*5. MongoDB shell 查看所有的数据库列表*
----
MongoDB Enterprise > show dbs
admin   0.000GB
config  0.000GB
local   0.000GB 
----

[source, text]
.*6. MongoDB shell 在 admin 库下执行停止 MongoDB 命令*
----
MongoDB Enterprise > use admin
switched to db admin
MongoDB Enterprise > db.shutdownServer()
server should be down...
----

[source, text]
.*7. 查看 mongod Console 中数据库停止的消息*
----
2019-03-13T14:13:25.764+0000 I COMMAND  [conn1] terminating, shutdown command received
2019-03-13T14:13:25.764+0000 I NETWORK  [conn1] shutdown: going to close listening sockets...
2019-03-13T14:13:25.764+0000 I NETWORK  [conn1] removing socket file: /tmp/mongodb-27017.sock
2019-03-13T14:13:25.765+0000 I FTDC     [conn1] Shutting down full-time diagnostic data capture
2019-03-13T14:13:25.766+0000 I STORAGE  [conn1] WiredTigerKVEngine shutting down
2019-03-13T14:13:25.912+0000 I STORAGE  [conn1] shutdown: removing fs lock...
2019-03-13T14:13:25.912+0000 I CONTROL  [conn1] now exiting
2019-03-13T14:13:25.913+0000 I CONTROL  [conn1] shutting down with code:0
----

[source, text]
.*8. 退出 MongoDB shell*
----
MongoDB Enterprise > exit
bye
----

=== mongod 启动指定参数

本部分说明 `mongod` 启动 MongoDB 数据库时指定相应参数。
 
[source, text]
.*1. 查看 mongod 帮助*
----
$ mongod -h

...

  --port arg                            specify port number - 27017 by default
  --dbpath arg                          directory for datafiles - defaults to 
                                        /data/db
  --logpath arg                         log file to send write to instead of 
                                        stdout - has to be a file, not 
                                        directory
  --fork                                fork server process
----

[source, text]
.*2. 创建一个本地目录*
----
$ mkdir first_mongod
----

[source, text]
.*3. 启动 MongoDB 并指定参数*
----
$ mongod --port 30000 --dbpath first_mongod/ --logpath first_mongod/mongod01.log --fork
about to fork child process, waiting until server is ready for connections.
forked process: 2750
child process started successfully, parent exiting
----

[source, text]
.*4. 查看运行进程*
----
$ ps -aux | grep mongo*
vagrant   2750  0.8  2.5 1105028 53100 ?       Sl   14:25   0:00 mongod --port 30000 --dbpath first_mongod/ --logpath first_mongod/mongod01.log --fork
----
[source, text]
.*5. 查看监听的端口*
----
$ netstat -ntulop | grep 2750
tcp        0      0 127.0.0.1:30000         0.0.0.0:*               LISTEN      2750/mongod      off (0.00/0/0)
----

[source, text]
.*6. mongo 命令客户端连接*
----
$ mongo --port 30000
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:30000/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("db4aa0de-5309-401a-bd64-1f60466a5acf") }
MongoDB server version: 3.6.11
----

[source, text]
.*7. Mongo Shell 命令行执行停止 MongoDB*
----
MongoDB Enterprise > use admin
switched to db admin
MongoDB Enterprise > db.shutdownServer()
server should be down...
----

[source, text]
.*8. 退出 MongoDB shell*
----
MongoDB Enterprise > exit
bye
----

=== 绑定多个地址，创建用户

本部分说明 `mongod` 启动 MongoDB 数据库时邦定多个 IP，并通过 `mongo` 命令创建一个管理账户。

[source, text]
.*1. 启动 MongoDB*
----
$ mongod --port 27000 --dbpath /data/db/ --bind_ip '192.168.103.100,localhost'
----

[source, text]
.*2. 查看运行的进程*
----
$ ps -ef | grep mongod
vagrant   2547  1959  7 23:35 pts/0    00:00:00 mongod --port 27000 --dbpath /data/db/ --bind_ip 192.168.103.100,localhost
----

[source, text]
.*3. 查看监听的端口*
----
$ netstat -antulop | grep 2547
tcp        0      0 127.0.0.1:27000         0.0.0.0:*               LISTEN      2547/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27000   0.0.0.0:*               LISTEN      2547/mongod      off (0.00/0/0)
----

[source, text]
.*4. 创建管理用户*
----
$ mongo admin --host localhost:27000 --eval '
  db.createUser({
    user: "kylin",
    pwd: "mongodb",
    roles: [
      {role: "root", db: "admin"}
    ]
  })
'
----

[source, text]
.*5. 使用新创建的用户连接数据库*
----
$ mongo kylin --host localhost:27000 
MongoDB shell version v3.6.11
connecting to: mongodb://localhost:27000/kylin?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("3b10edf4-5d3a-4831-a505-787298cdae34") }
MongoDB server version: 3.6.11
----

[source, text]
.*6. Mongo Shell 命令行执行停止 MongoDB*
----
MongoDB Enterprise > use admin
switched to db admin
MongoDB Enterprise > db.shutdownServer()
server should be down...
----

[source, text]
.*7. 退出 MongoDB shell*
----
MongoDB Enterprise > exit
bye
----

=== 通过配制文件启动 MongoDB

本部通过一个配制文件指定 `mongod` 启动时所需要的参数。

[source, text]
.*1. 创建 my-mongod.conf，内容如下*
----
storage:
  dbPath: /data/db/

net:
  port: 27000
  bindIp: localhost,192.168.103.100

security:
  authorization: enabled
----

[source, text]
.*2. 启动 MongoDB*
----
$ mongod --config my-mongod.conf
----

[source, text]
.*3. 查看运行的进程*
----
$ ps -ef | grep mongod
vagrant   2699  1959  0 23:48 pts/0    00:00:01 mongod --config my-mongod.conf
----

[source, text]
.*4. 查看监听的端口*
----
$ netstat -antulop | grep 2699
tcp        0      0 192.168.103.100:27000   0.0.0.0:*               LISTEN      2699/mongod      off (0.00/0/0)
tcp        0      0 127.0.0.1:27000         0.0.0.0:*               LISTEN      2699/mongod      off (0.00/0/0
---- 

[source, text]
.*5. Kill 停止运行的 mongod*
----
$ kill -9 2699
----

=== 改变默认的数据存储路径

本部分说明在 `mongod` 启动时指定一个额外的路径。

[source, text]
.*1. 创建一个路径*
----
$ sudo mkdir -p /var/mongodb/db/
----

[source, text]
.*2. 修改以上创建的路径为 vagrant 用户所有*
----
$ sudo chown vagrant:vagrant /var/mongodb/db/

$ ls -l /var/mongodb/
total 4
drwxr-xr-x 2 vagrant vagrant 4096 Mar 14 00:10 db
----

[source, text]
.*3. 创建 my-mongod.conf，内容如下*
----
storage:
  dbPath: /var/mongodb/db/

net:
  port: 27000
  bindIp: localhost,192.168.103.100

security:
  authorization: enabled
----

[source, text]
.*4. 启动 MongoDB*
----
$ mongod --config my-mongod.conf
----

[source, text]
.*5. 查看运行的进程*
----
$ ps -ef | grep mongod
vagrant   3257  1959  1 00:17 pts/0    00:00:00 mongod --config my-mongod.conf
----

[source, text]
.*6. 查看监听的端口*
----
$ netstat -antulop | grep 3257
tcp        0      0 192.168.103.100:27000   0.0.0.0:*               LISTEN      3257/mongod      off (0.00/0/0)
tcp        0      0 127.0.0.1:27000         0.0.0.0:*               LISTEN      3257/mongod      off (0.00/0/0)
----

[source, text]
.*7. 查看数据库文件*
----
$ ls -l /var/mongodb/db/
total 196
-rw------- 1 vagrant vagrant    45 Mar 14 00:17 WiredTiger
-rw------- 1 vagrant vagrant    21 Mar 14 00:17 WiredTiger.lock
-rw------- 1 vagrant vagrant  1103 Mar 14 00:19 WiredTiger.turtle
-rw------- 1 vagrant vagrant 57344 Mar 14 00:19 WiredTiger.wt
-rw------- 1 vagrant vagrant  4096 Mar 14 00:17 WiredTigerLAS.wt
-rw------- 1 vagrant vagrant 16384 Mar 14 00:18 _mdb_catalog.wt
-rw------- 1 vagrant vagrant 16384 Mar 14 00:18 collection-0--7654468380997166951.wt
-rw------- 1 vagrant vagrant 16384 Mar 14 00:18 collection-2--7654468380997166951.wt
-rw------- 1 vagrant vagrant  4096 Mar 14 00:17 collection-4--7654468380997166951.wt
drwx------ 2 vagrant vagrant  4096 Mar 14 00:20 diagnostic.data
-rw------- 1 vagrant vagrant 16384 Mar 14 00:18 index-1--7654468380997166951.wt
-rw------- 1 vagrant vagrant 16384 Mar 14 00:18 index-3--7654468380997166951.wt
-rw------- 1 vagrant vagrant  4096 Mar 14 00:17 index-5--7654468380997166951.wt
-rw------- 1 vagrant vagrant  4096 Mar 14 00:18 index-6--7654468380997166951.wt
drwx------ 2 vagrant vagrant  4096 Mar 14 00:17 journal
-rw------- 1 vagrant vagrant     5 Mar 14 00:17 mongod.lock
-rw------- 1 vagrant vagrant 16384 Mar 14 00:19 sizeStorer.wt
-rw------- 1 vagrant vagrant   114 Mar 14 00:17 storage.bson
----

[source, text]
.*8. mongo 命令客户端连接*
----
$ mongo admin --port 27000
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:27000/admin?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("bf41ace1-63a6-4da1-af9f-c93882fdbcda") }
MongoDB server version: 3.6.11
MongoDB Enterprise > 
----

[source, text]
.*9. Mongo Shell 命令行执行停止 MongoDB*
----
MongoDB Enterprise > use admin
switched to db admin
MongoDB Enterprise > db.shutdownServer()
server should be down...
----

[source, text]
.*10. 退出 MongoDB shell*
----
MongoDB Enterprise > exit
bye
----

=== 设定日志策略

本部分设计日志策略，将查询时间大于 50 毫秒的操作日志输出。

[source, text]
.*1. 创建 my-mongod.conf，内容如下*
----
storage:
  dbPath: /var/mongodb/db/

systemLog:
  destination: file
  logAppend: true
  path: /var/mongodb/db/mongod.log

net:
  port: 27000
  bindIp: localhost,192.168.103.100

processManagement:
  fork: true

operationProfiling:
  slowOpThresholdMs: 50

security:
  authorization: enabled
----

[source, text]
.*2. 启动 MongoDB*
----
$ mongod --config my-mongod.conf
----

[source, text]
.*3. 执行一次查询*
----
//
----

[source, text]
.*4. 查看日志输出*
----
//
----

=== 执行计划分析

MongoDB 中如果要分析某些执行操作的性能，如执行时间等，就需要执行计划 `Profiler`，本部分说明 MongoDB 执行计划分析。

[source, text]
.*1. 创建一个新 DB*
----
MongoDB Enterprise > use newDB
switched to db newDB
----

[source, text]
.*2. 查看计划执行级别*
----
MongoDB Enterprise > db.getProfilingLevel()
0
----

[source, text]
.*3. 设定计划执行级别为 1，收集执行操作较长的操作(默认 100 毫秒)*
----
MongoDB Enterprise > db.setProfilingLevel(1)
{ "was" : 0, "slowms" : 100, "sampleRate" : 1, "ok" : 1 }
----

[source, text]
.*4. 查看生成执行计划保存的 collection*
----
MongoDB Enterprise > show collections
system.profile
----

[source, text]
.*5. 调整较长执行时间阀值为 0，即收集所有操作(测试目的)*
----
MongoDB Enterprise > db.setProfilingLevel(1, {slowms: 0})
{ "was" : 1, "slowms" : 100, "sampleRate" : 1, "ok" : 1 }
----

[source, text]
.*6. 执行一次插入数据操作*
----
MongoDB Enterprise > db.new_connection.insert({"id": 1001, "name": "Kylin"})
WriteResult({ "nInserted" : 1 })
----

[source, text]
.*7. 查看执行计划*
----
MongoDB Enterprise > db.system.profile.find().pretty()
{
	"op" : "insert",
	"ns" : "newDB.new_connection",
	"command" : {
		"insert" : "new_connection",
		"ordered" : true,
		"lsid" : {
			"id" : UUID("a5f34116-7269-4372-ab7c-67a3254a1afe")
		},
		"$db" : "newDB"
	},
	"ninserted" : 1,
	"keysInserted" : 1,
	"numYield" : 0,
	"locks" : {
		"Global" : {
			"acquireCount" : {
				"r" : NumberLong(5),
				"w" : NumberLong(3)
			}
		},
		"Database" : {
			"acquireCount" : {
				"r" : NumberLong(1),
				"w" : NumberLong(2),
				"W" : NumberLong(1)
			}
		},
		"Collection" : {
			"acquireCount" : {
				"r" : NumberLong(1),
				"w" : NumberLong(2)
			}
		}
	},
	"responseLength" : 29,
	"protocol" : "op_msg",
	"millis" : 60,
	"ts" : ISODate("2019-03-14T09:37:47.393Z"),
	"client" : "127.0.0.1",
	"appName" : "MongoDB Shell",
	"allUsers" : [ ],
	"user" : ""
}
----

[source, text]
.*8. 执行一次读取操作*
----
MongoDB Enterprise > db.new_connection.find({"id": 1001})
{ "_id" : ObjectId("5c8a20eb29d0caf9229a8d82"), "id" : 1001, "name" : "Kylin" }
----

[source, text]
.*9. 再次查看执行计划*
----
MongoDB Enterprise > db.system.profile.find().pretty()

...

{
	"op" : "query",
	"ns" : "newDB.new_connection",
	"command" : {
		"find" : "new_connection",
		"filter" : {
			"id" : 1001
		},
		"lsid" : {
			"id" : UUID("a5f34116-7269-4372-ab7c-67a3254a1afe")
		},
		"$db" : "newDB"
	},
	"keysExamined" : 0,
	"docsExamined" : 1,
	"cursorExhausted" : true,
	"numYield" : 0,
	"locks" : {
		"Global" : {
			"acquireCount" : {
				"r" : NumberLong(2)
			}
		},
		"Database" : {
			"acquireCount" : {
				"r" : NumberLong(1)
			}
		},
		"Collection" : {
			"acquireCount" : {
				"r" : NumberLong(1)
			}
		}
	},
	"nreturned" : 1,
	"responseLength" : 146,
	"protocol" : "op_msg",
	"millis" : 0,
	"planSummary" : "COLLSCAN",
	"execStats" : {
		"stage" : "COLLSCAN",
		"filter" : {
			"id" : {
				"$eq" : 1001
			}
		},
		"nReturned" : 1,
		"executionTimeMillisEstimate" : 0,
		"works" : 3,
		"advanced" : 1,
		"needTime" : 1,
		"needYield" : 0,
		"saveState" : 0,
		"restoreState" : 0,
		"isEOF" : 1,
		"invalidates" : 0,
		"direction" : "forward",
		"docsExamined" : 1
	},
	"ts" : ISODate("2019-03-14T09:43:54.961Z"),
...
----

=== 创建管理用户

[source, text]
.*1. 启动 MongoDB*
----
$ mongod -f /etc/mongod.conf
----

[source, text]
.*2. 查看运行的进程*
----
$ ps -ef | grep mongod
vagrant   5191  1956  5 14:52 pts/0    00:00:00 mongod -f /etc/mongod.conf
----

[source, text]
.*3. 查看监听的端口*
----
$ netstat -antulop | grep 5191
tcp        0      0 127.0.0.1:27017         0.0.0.0:*               LISTEN      5191/mongod      off (0.00/0/0
----

[source, text]
.*4. mongo 命令客户端连接*
----
$ mongo --host 127.0.0.1:27017
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("d34d9ea7-369a-4466-865a-833556a63a3f") }
MongoDB server version: 3.6.11
----

[source, text]
.*5. 创建一个 root 用户，具有 root 权限*
----
MongoDB Enterprise > use admin
switched to db admin
MongoDB Enterprise > db.createUser({user: "root", pwd: "root123", roles: ["root"]})
Successfully added user: { "user" : "root", "roles" : [ "root" ] }
----

[source, text]
.*6. 退出 Mongo Shell 终端，以新创建的用户登录*
----
$ mongo --username root --password root123 --authenticationDatabase admin
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:27017/?authSource=admin&gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("eb8549e7-025c-4d89-94ec-e42096526967") }
MongoDB server version: 3.6.11
----

[source, text]
.*7. 查看 DB 状态*
----
MongoDB Enterprise > db.stats()
{
	"db" : "test",
	"collections" : 0,
	"views" : 0,
	"objects" : 0,
	"avgObjSize" : 0,
	"dataSize" : 0,
	"storageSize" : 0,
	"numExtents" : 0,
	"indexes" : 0,
	"indexSize" : 0,
	"fileSize" : 0,
	"fsUsedSize" : 0,
	"fsTotalSize" : 0,
	"ok" : 1
}
----

[source, text]
.*8. 退出 MongoDB shell*
----
MongoDB Enterprise > exit
bye
----

=== 创建应用用户

[source, text]
.*1. 创建 test-mongod.conf，内容如下*
----
storage:
  dbPath: /var/mongodb/db/

systemLog:
  destination: file
  logAppend: true
  path: /var/mongodb/db/mongod.log

net:
  port: 27000
  bindIp: localhost,192.168.103.100

processManagement:
  fork: true

security:
  authorization: enabled
----

[source, text]
.*2. 启动 MongoDB*
----
$ mongod -f test-mongod.conf 
forked process: 5405
----

[source, text]
.*3. 查看监听的端口*
----
$ netstat -antulop | grep 5405
tcp        0      0 192.168.103.100:27000   0.0.0.0:*               LISTEN      5405/mongod      off (0.00/0/0)
tcp        0      0 127.0.0.1:27000         0.0.0.0:*               LISTEN      5405/mongod      off (0.00/0/0)
----

[source, text]
.*4. mongo 命令客户端连接*
----
$ mongo --host 127.0.0.1:27000
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:27000/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("dd7a993a-9b0d-4ad5-a802-b92d7127a1d0") }
MongoDB server version: 3.6.11
----

[source, text]
.*5. 在 admin 数据库中创建 root 用户*
----
MongoDB Enterprise > use admin
switched to db admin
MongoDB Enterprise > db.createUser({user: "m103-admin", pwd: "m103-pass", roles: ["root"]})
Successfully added user: { "user" : "m103-admin", "roles" : [ "root" ] }
MongoDB Enterprise > exit
bye
----

[source, text]
.*6. 以新创建的用户登录*
----
$ mongo admin --host 127.0.0.1:27000 -u m103-admin -p m103-pass
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:27000/admin?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("e903a74b-fb15-4f3d-a295-8af6d72f7af2") }
MongoDB server version: 3.6.11
----

[source, text]
.*7. 创建一个应用用户可以对 applicationData 数据库进行读写操作*
----
MongoDB Enterprise > use applicationData
switched to db applicationData
MongoDB Enterprise > show users
MongoDB Enterprise > db.createUser({user: "m103-application-user", pwd: "m103-application-pass", roles: [{db: "applicationData", role: "readWrite"}]})
Successfully added user: {
	"user" : "m103-application-user",
	"roles" : [
		{
			"db" : "applicationData",
			"role" : "readWrite"
		}
	]
}
----

[source, text]
.*8. 使用应用帐号连接 Mongo Shell*
----
$ mongo applicationData --host 127.0.0.1:27000 -u m103-application-user -p m103-application-pass
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:27000/applicationData?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("2fb69f0c-5e8c-4c48-9f2a-2656a2372a1c") }
MongoDB server version: 3.6.11
----

[source, text]
.*9. 执行写操作*
----
MongoDB Enterprise > db.inventory.insertMany([{ item: "journal", qty: 25, status: "A", size: { h: 14, w: 21, uom: "cm" }, tags: [ "blank", "red" ] }, { item: "notebook", qty: 50, status: "A", size: { h: 8.5, w: 11, uom: "in" }, tags: [ "red", "blank" ] }]);
{
	"acknowledged" : true,
	"insertedIds" : [
		ObjectId("5c8d2518d2fe64d546a47c9e"),
		ObjectId("5c8d2518d2fe64d546a47c9f")
	]
}
----

[source, text]
.*10. 执行读操作*
----
MongoDB Enterprise > db.inventory.find({})
{ "_id" : ObjectId("5c8d2518d2fe64d546a47c9e"), "item" : "journal", "qty" : 25, "status" : "A", "size" : { "h" : 14, "w" : 21, "uom" : "cm" }, "tags" : [ "blank", "red" ] }
{ "_id" : ObjectId("5c8d2518d2fe64d546a47c9f"), "item" : "notebook", "qty" : 50, "status" : "A", "size" : { "h" : 8.5, "w" : 11, "uom" : "in" }, "tags" : [ "red", "blank" ] }
----

[source, text]
.*11. 退出 Mongo Shell*
----
MongoDB Enterprise > exit
bye
----

=== 批量导入数据

本部分使用 `创建应用用户` 批量导入数据。

[source, text]
.*1. 查看要导入的数据*
----
$ ls -l products.json 
-rw-rw-r-- 1 vagrant vagrant 92216793 Mar 15 05:34 products.json
----

[source, text]
.*2. mongoimport 批量导入*
----
$ mongoimport --db applicationData --port 27000 --username m103-application-user --password m103-application-pass --file products.json 
2019-03-16T16:19:11.249+0000	no collection specified
2019-03-16T16:19:11.249+0000	using filename 'products' as collection
2019-03-16T16:19:11.262+0000	connected to: localhost:27000
2019-03-16T16:19:14.252+0000	[#####...................] applicationData.products	20.4MB/87.9MB (23.2%)
2019-03-16T16:19:17.252+0000	[###########.............] applicationData.products	40.6MB/87.9MB (46.2%)
2019-03-16T16:19:20.255+0000	[################........] applicationData.products	59.9MB/87.9MB (68.1%)
2019-03-16T16:19:23.251+0000	[#####################...] applicationData.products	79.8MB/87.9MB (90.8%)
2019-03-16T16:19:24.451+0000	[########################] applicationData.products	87.9MB/87.9MB (100.0%)
2019-03-16T16:19:24.451+0000	imported 516784 documents
----

[source, text]
.*3. 在 Mongo Shell 中查看文档总数目*
----
MongoDB Enterprise > db.products.count()
516784
----

== 集群管理

=== 3 节点集群复制配制

[source, text]
.*1. 创建一个 keyfile，确保节点之间通信安全*
----
$ sudo mkdir -p /var/mongodb/pki
$ sudo chown vagrant:vagrant -R /var/mongodb
$ openssl rand -base64 741 > /var/mongodb/pki/m103-keyfile
$ chmod 600 /var/mongodb/pki/m103-keyfile
----

*2. 创建三个节点配制文件，内容如下*

[cols="5a,5a,5a"]
|===
|mongod-repl-1.conf |mongod-repl-2.conf |mongod-repl-3.conf  

|
[source, text]
----
storage:
  dbPath: /var/mongodb/db/1
net:
  bindIp: 192.168.103.100,localhost
  port: 27001
security:
  authorization: enabled
  keyFile: /var/mongodb/pki/m103-keyfile
systemLog:
  destination: file
  path: /var/mongodb/db/mongod1.log
  logAppend: true
processManagement:
  fork: true
replication:
  replSetName: m103-repl
----

|
[source, text]
----
storage:
  dbPath: /var/mongodb/db/2
net:
  bindIp: 192.168.103.100,localhost
  port: 27002
security:
  authorization: enabled
  keyFile: /var/mongodb/pki/m103-keyfile
systemLog:
  destination: file
  path: /var/mongodb/db/mongod2.log
  logAppend: true
processManagement:
  fork: true
replication:
  replSetName: m103-repl
----

|
[source, text]
----
storage:
  dbPath: /var/mongodb/db/3
net:
  bindIp: 192.168.103.100,localhost
  port: 27003
security:
  authorization: enabled
  keyFile: /var/mongodb/pki/m103-keyfile
systemLog:
  destination: file
  path: /var/mongodb/db/mongod3.log
  logAppend: true
processManagement:
  fork: true
replication:
  replSetName: m103-repl
----

|===

[source, text]
.*3. 创建日志存储路径*
----
$ mkdir -p /var/mongodb/db/{1,2,3}
----

[source, text]
.*4. 启动三个节点*
----
$ mongod -f mongod-repl-1.conf 
$ mongod -f mongod-repl-2.conf 
$ mongod -f mongod-repl-3.conf 
----

[source, text]
.*5. 查看运行进程*
----
$ ps -ef | grep mongod
vagrant   2155     1  0 07:29 ?        00:00:00 mongod -f mongod-repl-1.conf
vagrant   2194     1  0 07:30 ?        00:00:00 mongod -f mongod-repl-2.conf
vagrant   2232     1  0 07:31 ?        00:00:00 mongod -f mongod-repl-3.conf
----

[source, text]
.*6. 查看三个进行监听的端口*
----
$ for i in 2155 2194 2232 ; do netstat -antulop | grep $i; done
tcp        0      0 127.0.0.1:27001         0.0.0.0:*               LISTEN      2155/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27001   0.0.0.0:*               LISTEN      2155/mongod      off (0.00/0/0)
tcp        0      0 127.0.0.1:27002         0.0.0.0:*               LISTEN      2194/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27002   0.0.0.0:*               LISTEN      2194/mongod      off (0.00/0/0)
tcp        0      0 127.0.0.1:27003         0.0.0.0:*               LISTEN      2232/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27003   0.0.0.0:*               LISTEN      2232/mongod      off (0.00/0/0)
----

[source, text]
.*7. 连接到主节点，初始化集群*
----
$ mongo --port 27001
MongoDB shell version v3.6.11
connecting to: mongodb://127.0.0.1:27001/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("b5bd64d4-fec1-4002-b078-c4465e1fd966") }
MongoDB server version: 3.6.11

MongoDB Enterprise > rs.initiate()
{
	"info2" : "no configuration specified. Using a default configuration for the set",
	"me" : "192.168.103.100:27001",
	"ok" : 1
}
----

[source, text]
.*8. 查看集群状态*
----
MongoDB Enterprise m103-repl:SECONDARY> rs.status()
{
	"set" : "m103-repl",
	"date" : ISODate("2019-03-18T07:40:20.648Z"),
	"myState" : 1,
	"term" : NumberLong(1),
	"syncingTo" : "",
	"syncSourceHost" : "",
	"syncSourceId" : -1,
	"heartbeatIntervalMillis" : NumberLong(2000),
	"optimes" : {
		"lastCommittedOpTime" : {
			"ts" : Timestamp(1552894818, 1),
			"t" : NumberLong(1)
		},
		"readConcernMajorityOpTime" : {
			"ts" : Timestamp(1552894818, 1),
			"t" : NumberLong(1)
		},
		"appliedOpTime" : {
			"ts" : Timestamp(1552894818, 1),
			"t" : NumberLong(1)
		},
		"durableOpTime" : {
			"ts" : Timestamp(1552894818, 1),
			"t" : NumberLong(1)
		}
	},
	"members" : [
		{
			"_id" : 0,
			"name" : "192.168.103.100:27001",
			"health" : 1,
			"state" : 1,
			"stateStr" : "PRIMARY",
			"uptime" : 640,
			"optime" : {
				"ts" : Timestamp(1552894818, 1),
				"t" : NumberLong(1)
			},
			"optimeDate" : ISODate("2019-03-18T07:40:18Z"),
			"syncingTo" : "",
			"syncSourceHost" : "",
			"syncSourceId" : -1,
			"infoMessage" : "could not find member to sync from",
			"electionTime" : Timestamp(1552894756, 2),
			"electionDate" : ISODate("2019-03-18T07:39:16Z"),
			"configVersion" : 1,
			"self" : true,
			"lastHeartbeatMessage" : ""
		}
	],
	"ok" : 1,
	"operationTime" : Timestamp(1552894818, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552894818, 1),
		"signature" : {
			"hash" : BinData(0,"b2Owp1OlR6reFIFTnG9/4e02+Tw="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
----

[source, text]
.*9. 创建一个超级用户*
----
MongoDB Enterprise m103-repl:PRIMARY> use admin
switched to db admin
MongoDB Enterprise m103-repl:PRIMARY> db.createUser({user: "m103-admin", pwd: "m103-pass", roles: [{role: "root", db: "admin"}]})
Successfully added user: {
	"user" : "m103-admin",
	"roles" : [
		{
			"role" : "root",
			"db" : "admin"
		}
	]
}
MongoDB Enterprise m103-repl:PRIMARY> exit
bye
----

[source, text]
.*10. 已超级用户登录*
----
$ mongo --host "m103-repl/192.168.103.100:27001" -u "m103-admin" -p "m103-pass" --authenticationDatabase "admin"
MongoDB shell version v3.6.11
connecting to: mongodb://192.168.103.100:27001/?authSource=admin&gssapiServiceName=mongodb&replicaSet=m103-repl
2019-03-18T07:47:47.621+0000 I NETWORK  [thread1] Starting new replica set monitor for m103-repl/192.168.103.100:27001
2019-03-18T07:47:47.622+0000 I NETWORK  [thread1] Successfully connected to 192.168.103.100:27001 (1 connections now open to 192.168.103.100:27001 with a 5 second timeout)
Implicit session: session { "id" : UUID("b1ea59d3-b36f-4a84-bf96-3739d1a620e9") }
MongoDB server version: 3.6.11
----

[source, text]
.*11. 添加成员*
----
MongoDB Enterprise m103-repl:PRIMARY> rs.add("192.168.103.100:27002")
{
	"ok" : 1,
	"operationTime" : Timestamp(1552895444, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552895444, 1),
		"signature" : {
			"hash" : BinData(0,"/fYb24lG+07P1vFJbWlrave4/wg="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
MongoDB Enterprise m103-repl:PRIMARY> rs.add("192.168.103.100:27003")
{
	"ok" : 1,
	"operationTime" : Timestamp(1552895447, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552895447, 1),
		"signature" : {
			"hash" : BinData(0,"3qY1jjhSv+hsOWXvMPDFrHFOeic="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
----

[source, text]
.*12. 查看集群状态*
----
MongoDB Enterprise m103-repl:PRIMARY> rs.status()
{
	"set" : "m103-repl",
	"date" : ISODate("2019-03-18T07:52:04.922Z"),
	"myState" : 1,
	"term" : NumberLong(1),
	"syncingTo" : "",
	"syncSourceHost" : "",
	"syncSourceId" : -1,
	"heartbeatIntervalMillis" : NumberLong(2000),
	"optimes" : {
		"lastCommittedOpTime" : {
			"ts" : Timestamp(1552895518, 1),
			"t" : NumberLong(1)
		},
		"readConcernMajorityOpTime" : {
			"ts" : Timestamp(1552895518, 1),
			"t" : NumberLong(1)
		},
		"appliedOpTime" : {
			"ts" : Timestamp(1552895518, 1),
			"t" : NumberLong(1)
		},
		"durableOpTime" : {
			"ts" : Timestamp(1552895518, 1),
			"t" : NumberLong(1)
		}
	},
	"members" : [
		{
			"_id" : 0,
			"name" : "192.168.103.100:27001",
			"health" : 1,
			"state" : 1,
			"stateStr" : "PRIMARY",
			"uptime" : 1344,
			"optime" : {
				"ts" : Timestamp(1552895518, 1),
				"t" : NumberLong(1)
			},
			"optimeDate" : ISODate("2019-03-18T07:51:58Z"),
			"syncingTo" : "",
			"syncSourceHost" : "",
			"syncSourceId" : -1,
			"infoMessage" : "",
			"electionTime" : Timestamp(1552894756, 2),
			"electionDate" : ISODate("2019-03-18T07:39:16Z"),
			"configVersion" : 3,
			"self" : true,
			"lastHeartbeatMessage" : ""
		},
		{
			"_id" : 1,
			"name" : "192.168.103.100:27002",
			"health" : 1,
			"state" : 2,
			"stateStr" : "SECONDARY",
			"uptime" : 80,
			"optime" : {
				"ts" : Timestamp(1552895518, 1),
				"t" : NumberLong(1)
			},
			"optimeDurable" : {
				"ts" : Timestamp(1552895518, 1),
				"t" : NumberLong(1)
			},
			"optimeDate" : ISODate("2019-03-18T07:51:58Z"),
			"optimeDurableDate" : ISODate("2019-03-18T07:51:58Z"),
			"lastHeartbeat" : ISODate("2019-03-18T07:52:03.064Z"),
			"lastHeartbeatRecv" : ISODate("2019-03-18T07:52:03.607Z"),
			"pingMs" : NumberLong(0),
			"lastHeartbeatMessage" : "",
			"syncingTo" : "192.168.103.100:27001",
			"syncSourceHost" : "192.168.103.100:27001",
			"syncSourceId" : 0,
			"infoMessage" : "",
			"configVersion" : 3
		},
		{
			"_id" : 2,
			"name" : "192.168.103.100:27003",
			"health" : 1,
			"state" : 2,
			"stateStr" : "SECONDARY",
			"uptime" : 77,
			"optime" : {
				"ts" : Timestamp(1552895518, 1),
				"t" : NumberLong(1)
			},
			"optimeDurable" : {
				"ts" : Timestamp(1552895518, 1),
				"t" : NumberLong(1)
			},
			"optimeDate" : ISODate("2019-03-18T07:51:58Z"),
			"optimeDurableDate" : ISODate("2019-03-18T07:51:58Z"),
			"lastHeartbeat" : ISODate("2019-03-18T07:52:03.064Z"),
			"lastHeartbeatRecv" : ISODate("2019-03-18T07:52:03.012Z"),
			"pingMs" : NumberLong(0),
			"lastHeartbeatMessage" : "",
			"syncingTo" : "192.168.103.100:27002",
			"syncSourceHost" : "192.168.103.100:27002",
			"syncSourceId" : 1,
			"infoMessage" : "",
			"configVersion" : 3
		}
	],
	"ok" : 1,
	"operationTime" : Timestamp(1552895518, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552895518, 1),
		"signature" : {
			"hash" : BinData(0,"0GmanYs4kEgfT36dh6aE7p5BSeI="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
----

[source, text]
.*13. 查看监听端口*
----
$ for i in 2155 2194 2232 ; do netstat -antulop | grep $i; echo ;done
tcp        0      0 127.0.0.1:27001         0.0.0.0:*               LISTEN      2155/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27001   0.0.0.0:*               LISTEN      2155/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27001   192.168.103.100:50635   ESTABLISHED 2155/mongod      keepalive (103.02/0/0)
tcp        0      0 192.168.103.100:41951   192.168.103.100:27002   ESTABLISHED 2155/mongod      keepalive (103.02/0/0)
tcp        0      0 192.168.103.100:41195   192.168.103.100:27003   ESTABLISHED 2155/mongod      keepalive (106.09/0/0)
tcp        0      0 192.168.103.100:27001   192.168.103.100:50632   ESTABLISHED 2155/mongod      keepalive (183.92/0/0)
tcp        0      0 192.168.103.100:27001   192.168.103.100:50631   ESTABLISHED 2155/mongod      keepalive (225.90/0/0)
tcp        0      0 192.168.103.100:27001   192.168.103.100:50643   ESTABLISHED 2155/mongod      keepalive (106.09/0/0)
tcp        0      0 192.168.103.100:27001   192.168.103.100:50638   ESTABLISHED 2155/mongod      keepalive (103.02/0/0)
tcp        0      0 192.168.103.100:27001   192.168.103.100:50658   ESTABLISHED 2155/mongod      keepalive (123.50/0/0)
tcp        0      0 192.168.103.100:27001   192.168.103.100:50650   ESTABLISHED 2155/mongod      keepalive (106.09/0/0)
tcp        0      0 192.168.103.100:27001   192.168.103.100:50659   ESTABLISHED 2155/mongod      keepalive (123.50/0/0)

tcp        0      0 127.0.0.1:27002         0.0.0.0:*               LISTEN      2194/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27002   0.0.0.0:*               LISTEN      2194/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27002   192.168.103.100:41966   ESTABLISHED 2194/mongod      keepalive (106.09/0/0)
tcp        0      0 192.168.103.100:27002   192.168.103.100:41951   ESTABLISHED 2194/mongod      keepalive (103.02/0/0)
tcp        0      0 192.168.103.100:27002   192.168.103.100:41973   ESTABLISHED 2194/mongod      keepalive (123.50/0/0)
tcp        0      0 192.168.103.100:27002   192.168.103.100:41969   ESTABLISHED 2194/mongod      keepalive (106.09/0/0)
tcp        0      0 192.168.103.100:27002   192.168.103.100:41970   ESTABLISHED 2194/mongod      keepalive (106.09/0/0)
tcp        0      0 192.168.103.100:50638   192.168.103.100:27001   ESTABLISHED 2194/mongod      keepalive (103.02/0/0)
tcp        0      0 192.168.103.100:27002   192.168.103.100:41972   ESTABLISHED 2194/mongod      keepalive (117.35/0/0)
tcp        0      0 192.168.103.100:50635   192.168.103.100:27001   ESTABLISHED 2194/mongod      keepalive (103.02/0/0)
tcp        0      0 192.168.103.100:50650   192.168.103.100:27001   ESTABLISHED 2194/mongod      keepalive (106.09/0/0)
tcp        0      0 192.168.103.100:41201   192.168.103.100:27003   ESTABLISHED 2194/mongod      keepalive (106.09/0/0)

tcp        0      0 127.0.0.1:27003         0.0.0.0:*               LISTEN      2232/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27003   0.0.0.0:*               LISTEN      2232/mongod      off (0.00/0/0)
tcp        0      0 192.168.103.100:27003   192.168.103.100:41201   ESTABLISHED 2232/mongod      keepalive (106.08/0/0)
tcp        0      0 192.168.103.100:41210   192.168.103.100:27003   ESTABLISHED 2232/mongod      keepalive (123.49/0/0)
tcp        0      0 192.168.103.100:27003   192.168.103.100:41210   ESTABLISHED 2232/mongod      keepalive (123.49/0/0)
tcp        0      0 192.168.103.100:41966   192.168.103.100:27002   ESTABLISHED 2232/mongod      keepalive (106.08/0/0)
tcp        0      0 192.168.103.100:41973   192.168.103.100:27002   ESTABLISHED 2232/mongod      keepalive (123.49/0/0)
tcp        0      0 192.168.103.100:50658   192.168.103.100:27001   ESTABLISHED 2232/mongod      keepalive (123.49/0/0)
tcp        0      0 192.168.103.100:50643   192.168.103.100:27001   ESTABLISHED 2232/mongod      keepalive (106.08/0/0)
tcp        0      0 192.168.103.100:27003   192.168.103.100:41195   ESTABLISHED 2232/mongod      keepalive (106.08/0/0)
tcp        0      0 192.168.103.100:27003   192.168.103.100:41207   ESTABLISHED 2232/mongod      keepalive (106.08/0/0)
tcp        0      0 192.168.103.100:41972   192.168.103.100:27002   ESTABLISHED 2232/mongod      keepalive (117.34/0/0)
tcp        0      0 192.168.103.100:50659   192.168.103.100:27001   ESTABLISHED 2232/mongod      keepalive (123.49/0/0)
tcp        0      0 192.168.103.100:41969   192.168.103.100:27002   ESTABLISHED 2232/mongod      keepalive (106.08/0/0)
----

=== 添加和删除节点

本部分在上面 *3 节点集群复制配制* 基础上进行添加和删除节点。

*1. 创建两个配制文件内容如下*

[cols="5a,5a"]
|===
|mongod-repl-4.conf |arbiter.conf 

|
[source, text]
----
storage:
  dbPath: /var/mongodb/db/4
net:
  bindIp: 192.168.103.100,localhost
  port: 27004
security:
  authorization: enabled
  keyFile: /var/mongodb/pki/m103-keyfile
systemLog:
  destination: file
  path: /var/mongodb/db/mongod4.log
  logAppend: true
processManagement:
  fork: true
replication:
  replSetName: m103-repl
----

|
[source, text]
----
storage:
  dbPath: /var/mongodb/db/arbiter
net:
  bindIp: 192.168.103.100,localhost
  port: 28000
security:
  authorization: enabled
  keyFile: /var/mongodb/pki/m103-keyfile
systemLog:
  destination: file
  path: /var/mongodb/db/mongod-arbiter.log
  logAppend: true
processManagement:
  fork: true
replication:
  replSetName: m103-repl
----

|===

[source, text]
.*2. 启动 mongod 进程*
----
$ mongod -f mongod-repl-4.conf
$ mongod -f arbiter.conf
----

[source, text]
.*3. 添加新创建的节点到集群*
----
MongoDB Enterprise m103-repl:PRIMARY> rs.add("192.168.103.100:27004")
{
	"ok" : 1,
	"operationTime" : Timestamp(1552900251, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552900251, 1),
		"signature" : {
			"hash" : BinData(0,"tgvIK0IO8r7x2965MiC3GuBL4NM="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}

MongoDB Enterprise m103-repl:PRIMARY> rs.addArb("192.168.103.100:28000")
{
	"ok" : 1,
	"operationTime" : Timestamp(1552900296, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552900296, 1),
		"signature" : {
			"hash" : BinData(0,"3KERoIv/hxKNDo1Wh/UWvJC4c2U="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
----

[source, text]
.*4. 查看新添加的两个节点*
----
MongoDB Enterprise m103-repl:PRIMARY> rs.isMaster()
{
	"hosts" : [
		"192.168.103.100:27001",
		"192.168.103.100:27002",
		"192.168.103.100:27003",
		"192.168.103.100:27004"
	],
	"arbiters" : [
		"192.168.103.100:28000"
	],
	"setName" : "m103-repl",
	"setVersion" : 9,
	"ismaster" : true,
	"secondary" : false,
	"primary" : "192.168.103.100:27001",
	"me" : "192.168.103.100:27001",
	"electionId" : ObjectId("7fffffff0000000000000001"),
	"lastWrite" : {
		"opTime" : {
			"ts" : Timestamp(1552900328, 1),
			"t" : NumberLong(1)
		},
		"lastWriteDate" : ISODate("2019-03-18T09:12:08Z"),
		"majorityOpTime" : {
			"ts" : Timestamp(1552900328, 1),
			"t" : NumberLong(1)
		},
		"majorityWriteDate" : ISODate("2019-03-18T09:12:08Z")
	},
	"maxBsonObjectSize" : 16777216,
	"maxMessageSizeBytes" : 48000000,
	"maxWriteBatchSize" : 100000,
	"localTime" : ISODate("2019-03-18T09:12:09.222Z"),
	"logicalSessionTimeoutMinutes" : 30,
	"minWireVersion" : 0,
	"maxWireVersion" : 6,
	"readOnly" : false,
	"ok" : 1,
	"operationTime" : Timestamp(1552900328, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552900328, 1),
		"signature" : {
			"hash" : BinData(0,"NYyWWkgAKi1u8fPZEUQdEc8U3ps="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
----

[source, text]
.*5. 删除 arbiter 节点*
----
MongoDB Enterprise m103-repl:PRIMARY> rs.remove("192.168.103.100:28000")
{
	"ok" : 1,
	"operationTime" : Timestamp(1552900423, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552900423, 1),
		"signature" : {
			"hash" : BinData(0,"dA94M4Nv2EhsJdq5mC8PjZgC8tY="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
----


[source, text]
.*6. 隐藏一个节点*
----
MongoDB Enterprise m103-repl:PRIMARY> var cfg = rs.conf()
MongoDB Enterprise m103-repl:PRIMARY> cfg.members[3].votes = 0
0
MongoDB Enterprise m103-repl:PRIMARY> cfg.members[3].hidden = true
true
MongoDB Enterprise m103-repl:PRIMARY> cfg.members[3].priority = 0
0

MongoDB Enterprise m103-repl:PRIMARY> rs.reconfig(cfg)
{
	"ok" : 1,
	"operationTime" : Timestamp(1552900605, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552900605, 1),
		"signature" : {
			"hash" : BinData(0,"ibtCCQKaVLHIYaiQE/fNhGfYUFQ="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
----

[source, text]
.*7. 查看集群*
----
MongoDB Enterprise m103-repl:PRIMARY> rs.isMaster()
{
	"hosts" : [
		"192.168.103.100:27001",
		"192.168.103.100:27002",
		"192.168.103.100:27003"
	],
	"setName" : "m103-repl",
	"setVersion" : 11,
	"ismaster" : true,
	"secondary" : false,
	"primary" : "192.168.103.100:27001",
	"me" : "192.168.103.100:27001",
	"electionId" : ObjectId("7fffffff0000000000000001"),
	"lastWrite" : {
		"opTime" : {
			"ts" : Timestamp(1552900698, 1),
			"t" : NumberLong(1)
		},
		"lastWriteDate" : ISODate("2019-03-18T09:18:18Z"),
		"majorityOpTime" : {
			"ts" : Timestamp(1552900698, 1),
			"t" : NumberLong(1)
		},
		"majorityWriteDate" : ISODate("2019-03-18T09:18:18Z")
	},
	"maxBsonObjectSize" : 16777216,
	"maxMessageSizeBytes" : 48000000,
	"maxWriteBatchSize" : 100000,
	"localTime" : ISODate("2019-03-18T09:18:28.633Z"),
	"logicalSessionTimeoutMinutes" : 30,
	"minWireVersion" : 0,
	"maxWireVersion" : 6,
	"readOnly" : false,
	"ok" : 1,
	"operationTime" : Timestamp(1552900698, 1),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1552900698, 1),
		"signature" : {
			"hash" : BinData(0,"iJnZ5UHzZ3AwTy4b0zXYtLFzv4o="),
			"keyId" : NumberLong("6669632199739834369")
		}
	}
}
----

=== TODO

[source, text]
.**
----

----

[source, text]
.**
----

----

[source, text]
.**
----

----

[source, text]
.**
----

----

[source, text]
.**
----

----

[source, text]
.**
----

----

[source, text]
.**
----

----

[source, text]
.**
----

----

[source, text]
.**
----

----

[source, text]
.**
----

----


